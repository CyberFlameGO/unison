<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE PatternGuards #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE RecordWildCards #-}</span><span>
</span><span id="line-5"></span><span>
</span><span id="line-6"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Network.HTTP2.Arch.Receiver</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-7"></span><span>    </span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#frameReceiver"><span class="hs-identifier">frameReceiver</span></a></span><span>
</span><span id="line-8"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#maxConcurrency"><span class="hs-identifier">maxConcurrency</span></a></span><span>
</span><span id="line-9"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#initialFrame"><span class="hs-identifier">initialFrame</span></a></span><span>
</span><span id="line-10"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-11"></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent</span></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.STM</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Control.Exception</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">E</span></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BS</span></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Char8</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">C8</span></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.IORef</span></span><span>
</span><span id="line-18"></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Imports.html"><span class="hs-identifier">Imports</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">delete</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">insert</span></span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.HPACK.html"><span class="hs-identifier">Network.HPACK</span></a></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.HPACK.Token.html"><span class="hs-identifier">Network.HPACK.Token</span></a></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.HTTP2.Arch.Context.html"><span class="hs-identifier">Network.HTTP2.Arch.Context</span></a></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.HTTP2.Arch.EncodeFrame.html"><span class="hs-identifier">Network.HTTP2.Arch.EncodeFrame</span></a></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.HTTP2.Arch.HPACK.html"><span class="hs-identifier">Network.HTTP2.Arch.HPACK</span></a></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.HTTP2.Arch.Queue.html"><span class="hs-identifier">Network.HTTP2.Arch.Queue</span></a></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.HTTP2.Arch.Rate.html"><span class="hs-identifier">Network.HTTP2.Arch.Rate</span></a></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.HTTP2.Arch.Stream.html"><span class="hs-identifier">Network.HTTP2.Arch.Stream</span></a></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.HTTP2.Arch.Types.html"><span class="hs-identifier">Network.HTTP2.Arch.Types</span></a></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.html"><span class="hs-identifier">Network.HTTP2.Frame</span></a></span><span>
</span><span id="line-30"></span><span>
</span><span id="line-31"></span><span class="hs-comment">----------------------------------------------------------------</span><span>
</span><span id="line-32"></span><span>
</span><span id="line-33"></span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#maxConcurrency"><span class="hs-identifier hs-type">maxConcurrency</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-34"></span><span id="maxConcurrency"><span class="annot"><span class="annottext">maxConcurrency :: Int
</span><a href="Network.HTTP2.Arch.Receiver.html#maxConcurrency"><span class="hs-identifier hs-var hs-var">maxConcurrency</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="Network.HTTP2.Frame.Types.html#recommendedConcurrency"><span class="hs-identifier hs-var">recommendedConcurrency</span></a></span><span>
</span><span id="line-35"></span><span>
</span><span id="line-36"></span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#continuationLimit"><span class="hs-identifier hs-type">continuationLimit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-37"></span><span id="continuationLimit"><span class="annot"><span class="annottext">continuationLimit :: Int
</span><a href="Network.HTTP2.Arch.Receiver.html#continuationLimit"><span class="hs-identifier hs-var hs-var">continuationLimit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">10</span></span><span>
</span><span id="line-38"></span><span>
</span><span id="line-39"></span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#headerFragmentLimit"><span class="hs-identifier hs-type">headerFragmentLimit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-40"></span><span id="headerFragmentLimit"><span class="annot"><span class="annottext">headerFragmentLimit :: Int
</span><a href="Network.HTTP2.Arch.Receiver.html#headerFragmentLimit"><span class="hs-identifier hs-var hs-var">headerFragmentLimit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">51200</span></span><span> </span><span class="hs-comment">-- 50K</span><span>
</span><span id="line-41"></span><span>
</span><span id="line-42"></span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#pingRateLimit"><span class="hs-identifier hs-type">pingRateLimit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-43"></span><span id="pingRateLimit"><span class="annot"><span class="annottext">pingRateLimit :: Int
</span><a href="Network.HTTP2.Arch.Receiver.html#pingRateLimit"><span class="hs-identifier hs-var hs-var">pingRateLimit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">4</span></span><span>
</span><span id="line-44"></span><span>
</span><span id="line-45"></span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#settingsRateLimit"><span class="hs-identifier hs-type">settingsRateLimit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-46"></span><span id="settingsRateLimit"><span class="annot"><span class="annottext">settingsRateLimit :: Int
</span><a href="Network.HTTP2.Arch.Receiver.html#settingsRateLimit"><span class="hs-identifier hs-var hs-var">settingsRateLimit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">4</span></span><span>
</span><span id="line-47"></span><span>
</span><span id="line-48"></span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#emptyFrameRateLimit"><span class="hs-identifier hs-type">emptyFrameRateLimit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-49"></span><span id="emptyFrameRateLimit"><span class="annot"><span class="annottext">emptyFrameRateLimit :: Int
</span><a href="Network.HTTP2.Arch.Receiver.html#emptyFrameRateLimit"><span class="hs-identifier hs-var hs-var">emptyFrameRateLimit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">4</span></span><span>
</span><span id="line-50"></span><span>
</span><span id="line-51"></span><span class="hs-comment">----------------------------------------------------------------</span><span>
</span><span id="line-52"></span><span>
</span><span id="line-53"></span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#initialFrame"><span class="hs-identifier hs-type">initialFrame</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span>
</span><span id="line-54"></span><span id="initialFrame"><span class="annot"><span class="annottext">initialFrame :: ByteString
</span><a href="Network.HTTP2.Arch.Receiver.html#initialFrame"><span class="hs-identifier hs-var hs-var">initialFrame</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(FrameFlags -&gt; FrameFlags) -&gt; SettingsList -&gt; ByteString
</span><a href="Network.HTTP2.Arch.EncodeFrame.html#settingsFrame"><span class="hs-identifier hs-var">settingsFrame</span></a></span><span> </span><span class="annot"><span class="annottext">FrameFlags -&gt; FrameFlags
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">SettingsKeyId
</span><a href="Network.HTTP2.Frame.Types.html#SettingsMaxConcurrentStreams"><span class="hs-identifier hs-var">SettingsMaxConcurrentStreams</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Int
</span><a href="Network.HTTP2.Arch.Receiver.html#maxConcurrency"><span class="hs-identifier hs-var">maxConcurrency</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-55"></span><span>
</span><span id="line-56"></span><span class="hs-comment">----------------------------------------------------------------</span><span>
</span><span id="line-57"></span><span>
</span><span id="line-58"></span><span class="hs-keyword">type</span><span> </span><span id="RecvN"><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#RecvN"><span class="hs-identifier hs-var">RecvN</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span>
</span><span id="line-59"></span><span>
</span><span id="line-60"></span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#frameReceiver"><span class="hs-identifier hs-type">frameReceiver</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP2.Arch.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#RecvN"><span class="hs-identifier hs-type">RecvN</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-61"></span><span id="frameReceiver"><span class="annot"><span class="annottext">frameReceiver :: Context -&gt; RecvN -&gt; IO ()
</span><a href="Network.HTTP2.Arch.Receiver.html#frameReceiver"><span class="hs-identifier hs-var hs-var">frameReceiver</span></a></span></span><span> </span><span id="local-6989586621679092915"><span class="annot"><span class="annottext">ctx :: Context
</span><a href="#local-6989586621679092915"><span class="hs-identifier hs-var">ctx</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Network.HTTP2.Arch.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span class="hs-special">{</span><span id="local-6989586621679092897"><span id="local-6989586621679092898"><span id="local-6989586621679092899"><span id="local-6989586621679092900"><span id="local-6989586621679092901"><span id="local-6989586621679092902"><span id="local-6989586621679092903"><span id="local-6989586621679092904"><span id="local-6989586621679092905"><span id="local-6989586621679092906"><span id="local-6989586621679092907"><span id="local-6989586621679092908"><span id="local-6989586621679092909"><span id="local-6989586621679092910"><span id="local-6989586621679092911"><span id="local-6989586621679092912"><span id="local-6989586621679092913"><span class="annot"><span class="annottext">TVar Int
IORef Bool
IORef Int
IORef (Maybe Int)
IORef Settings
TQueue Control
TQueue (Output Stream)
DynamicTable
Rate
StreamTable
RoleInfo
Role
emptyFrameRate :: Context -&gt; Rate
settingsRate :: Context -&gt; Rate
pingRate :: Context -&gt; Rate
connectionWindow :: Context -&gt; TVar Int
decodeDynamicTable :: Context -&gt; DynamicTable
encodeDynamicTable :: Context -&gt; DynamicTable
controlQ :: Context -&gt; TQueue Control
outputQ :: Context -&gt; TQueue (Output Stream)
peerStreamId :: Context -&gt; IORef Int
myStreamId :: Context -&gt; IORef Int
continued :: Context -&gt; IORef (Maybe Int)
concurrency :: Context -&gt; IORef Int
streamTable :: Context -&gt; StreamTable
firstSettings :: Context -&gt; IORef Bool
http2settings :: Context -&gt; IORef Settings
roleInfo :: Context -&gt; RoleInfo
role :: Context -&gt; Role
emptyFrameRate :: Rate
settingsRate :: Rate
pingRate :: Rate
connectionWindow :: TVar Int
decodeDynamicTable :: DynamicTable
encodeDynamicTable :: DynamicTable
controlQ :: TQueue Control
outputQ :: TQueue (Output Stream)
peerStreamId :: IORef Int
myStreamId :: IORef Int
continued :: IORef (Maybe Int)
concurrency :: IORef Int
streamTable :: StreamTable
firstSettings :: IORef Bool
http2settings :: IORef Settings
roleInfo :: RoleInfo
role :: Role
</span><a href="Network.HTTP2.Arch.Context.html#emptyFrameRate"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679092879"><span class="annot"><span class="annottext">RecvN
</span><a href="#local-6989586621679092879"><span class="hs-identifier hs-var">recvN</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO ()
</span><a href="#local-6989586621679092878"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; (SomeException -&gt; IO ()) -&gt; IO ()
forall e a. Exception e =&gt; IO a -&gt; (e -&gt; IO a) -&gt; IO a
</span><span class="hs-operator hs-var">`E.catch`</span></span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; IO ()
</span><a href="#local-6989586621679092876"><span class="hs-identifier hs-var">sendGoaway</span></a></span><span>
</span><span id="line-62"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-63"></span><span>    </span><span class="annot"><a href="#local-6989586621679092878"><span class="hs-identifier hs-type">loop</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-64"></span><span>    </span><span id="local-6989586621679092878"><span class="annot"><span class="annottext">loop :: Int -&gt; IO ()
</span><a href="#local-6989586621679092878"><span class="hs-identifier hs-var hs-var">loop</span></a></span></span><span> </span><span id="local-6989586621679092875"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092875"><span class="hs-identifier hs-var">n</span></a></span></span><span>
</span><span id="line-65"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092875"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">6</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-66"></span><span>          </span><span class="annot"><span class="annottext">IO ()
</span><span class="hs-identifier hs-var">yield</span></span><span>
</span><span id="line-67"></span><span>          </span><span class="annot"><span class="annottext">Int -&gt; IO ()
</span><a href="#local-6989586621679092878"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-68"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-69"></span><span>        </span><span id="local-6989586621679092873"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092873"><span class="hs-identifier hs-var">hd</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RecvN
</span><a href="#local-6989586621679092879"><span class="hs-identifier hs-var">recvN</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="Network.HTTP2.Frame.Types.html#frameHeaderLength"><span class="hs-identifier hs-var">frameHeaderLength</span></a></span><span>
</span><span id="line-70"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Bool
</span><span class="hs-identifier hs-var">BS.null</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092873"><span class="hs-identifier hs-var">hd</span></a></span><span> </span><span class="hs-keyword">then</span><span>
</span><span id="line-71"></span><span>            </span><span class="annot"><span class="annottext">TQueue Control -&gt; Control -&gt; IO ()
</span><a href="Network.HTTP2.Arch.Queue.html#enqueueControl"><span class="hs-identifier hs-var">enqueueControl</span></a></span><span> </span><span class="annot"><span class="annottext">TQueue Control
</span><a href="#local-6989586621679092903"><span class="hs-identifier hs-var">controlQ</span></a></span><span> </span><span class="annot"><span class="annottext">Control
</span><a href="Network.HTTP2.Arch.Types.html#CFinish"><span class="hs-identifier hs-var">CFinish</span></a></span><span>
</span><span id="line-72"></span><span>          </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-73"></span><span>            </span><span id="local-6989586621679092868"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679092868"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; RecvN -&gt; (FrameTypeId, FrameHeader) -&gt; IO Bool
</span><a href="Network.HTTP2.Arch.Receiver.html#processFrame"><span class="hs-identifier hs-var">processFrame</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679092915"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">RecvN
</span><a href="#local-6989586621679092879"><span class="hs-identifier hs-var">recvN</span></a></span><span> </span><span class="annot"><span class="annottext">((FrameTypeId, FrameHeader) -&gt; IO Bool)
-&gt; (FrameTypeId, FrameHeader) -&gt; IO Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; (FrameTypeId, FrameHeader)
</span><a href="Network.HTTP2.Frame.Decode.html#decodeFrameHeader"><span class="hs-identifier hs-var">decodeFrameHeader</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092873"><span class="hs-identifier hs-var">hd</span></a></span><span>
</span><span id="line-74"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679092868"><span class="hs-identifier hs-var">cont</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO ()
</span><a href="#local-6989586621679092878"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092875"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-75"></span><span>
</span><span id="line-76"></span><span>    </span><span id="local-6989586621679092876"><span class="annot"><span class="annottext">sendGoaway :: SomeException -&gt; IO ()
</span><a href="#local-6989586621679092876"><span class="hs-identifier hs-var hs-var">sendGoaway</span></a></span></span><span> </span><span id="local-6989586621679092863"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679092863"><span class="hs-identifier hs-var">e</span></a></span></span><span>
</span><span id="line-77"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#ConnectionError"><span class="hs-identifier hs-type">ConnectionError</span></a></span><span> </span><span id="local-6989586621679092861"><span class="annot"><span class="annottext">ErrorCodeId
</span><a href="#local-6989586621679092861"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span id="local-6989586621679092860"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092860"><span class="hs-identifier hs-var">msg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; Maybe HTTP2Error
forall e. Exception e =&gt; SomeException -&gt; Maybe e
</span><span class="hs-identifier hs-var">E.fromException</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679092863"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-78"></span><span>          </span><span id="local-6989586621679092858"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092858"><span class="hs-identifier hs-var">psid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO Int
</span><a href="Network.HTTP2.Arch.Context.html#getPeerStreamID"><span class="hs-identifier hs-var">getPeerStreamID</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679092915"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-79"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679092856"><span class="annot"><span class="annottext">frame :: ByteString
</span><a href="#local-6989586621679092856"><span class="hs-identifier hs-var hs-var">frame</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; ErrorCodeId -&gt; ByteString -&gt; ByteString
</span><a href="Network.HTTP2.Arch.EncodeFrame.html#goawayFrame"><span class="hs-identifier hs-var">goawayFrame</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092858"><span class="hs-identifier hs-var">psid</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId
</span><a href="#local-6989586621679092861"><span class="hs-identifier hs-var">err</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092860"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-80"></span><span>          </span><span class="annot"><span class="annottext">TQueue Control -&gt; Control -&gt; IO ()
</span><a href="Network.HTTP2.Arch.Queue.html#enqueueControl"><span class="hs-identifier hs-var">enqueueControl</span></a></span><span> </span><span class="annot"><span class="annottext">TQueue Control
</span><a href="#local-6989586621679092903"><span class="hs-identifier hs-var">controlQ</span></a></span><span> </span><span class="annot"><span class="annottext">(Control -&gt; IO ()) -&gt; Control -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Control
</span><a href="Network.HTTP2.Arch.Types.html#CGoaway"><span class="hs-identifier hs-var">CGoaway</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092856"><span class="hs-identifier hs-var">frame</span></a></span><span>
</span><span id="line-81"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-82"></span><span>
</span><span id="line-83"></span><span class="hs-comment">----------------------------------------------------------------</span><span>
</span><span id="line-84"></span><span>
</span><span id="line-85"></span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#processFrame"><span class="hs-identifier hs-type">processFrame</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP2.Arch.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#RecvN"><span class="hs-identifier hs-type">RecvN</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameTypeId"><span class="hs-identifier hs-type">FrameTypeId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameHeader"><span class="hs-identifier hs-type">FrameHeader</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-86"></span><span id="processFrame"><span class="annot"><span class="annottext">processFrame :: Context -&gt; RecvN -&gt; (FrameTypeId, FrameHeader) -&gt; IO Bool
</span><a href="Network.HTTP2.Arch.Receiver.html#processFrame"><span class="hs-identifier hs-var hs-var">processFrame</span></a></span></span><span> </span><span id="local-6989586621679092853"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679092853"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679092852"><span class="annot"><span class="annottext">RecvN
</span><a href="#local-6989586621679092852"><span class="hs-identifier hs-var">_recvN</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679092851"><span class="annot"><span class="annottext">FrameTypeId
</span><a href="#local-6989586621679092851"><span class="hs-identifier hs-var">fid</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameHeader"><span class="hs-identifier hs-type">FrameHeader</span></a></span><span class="hs-special">{</span><span id="local-6989586621679092849"><span class="annot"><span class="annottext">Int
streamId :: FrameHeader -&gt; Int
streamId :: Int
</span><a href="Network.HTTP2.Frame.Types.html#streamId"><span class="hs-identifier hs-var hs-var">streamId</span></a></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-87"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Context -&gt; Bool
</span><a href="Network.HTTP2.Arch.Context.html#isServer"><span class="hs-identifier hs-var">isServer</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679092853"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span>
</span><span id="line-88"></span><span>    </span><span class="annot"><span class="annottext">Int -&gt; Bool
</span><a href="Network.HTTP2.Frame.Types.html#isServerInitiated"><span class="hs-identifier hs-var">isServerInitiated</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092849"><span class="hs-identifier hs-var">streamId</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span>
</span><span id="line-89"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FrameTypeId
</span><a href="#local-6989586621679092851"><span class="hs-identifier hs-var">fid</span></a></span><span> </span><span class="annot"><span class="annottext">FrameTypeId -&gt; [FrameTypeId] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`notElem`</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">FrameTypeId
</span><a href="Network.HTTP2.Frame.Types.html#FramePriority"><span class="hs-identifier hs-var">FramePriority</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">FrameTypeId
</span><a href="Network.HTTP2.Frame.Types.html#FrameRSTStream"><span class="hs-identifier hs-var">FrameRSTStream</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">FrameTypeId
</span><a href="Network.HTTP2.Frame.Types.html#FrameWindowUpdate"><span class="hs-identifier hs-var">FrameWindowUpdate</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-90"></span><span>    </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO Bool
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO Bool) -&gt; HTTP2Error -&gt; IO Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId -&gt; ByteString -&gt; HTTP2Error
</span><a href="Network.HTTP2.Frame.Types.html#ConnectionError"><span class="hs-identifier hs-var">ConnectionError</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId
</span><a href="Network.HTTP2.Frame.Types.html#ProtocolError"><span class="hs-identifier hs-var">ProtocolError</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;stream id should be odd&quot;</span></span><span>
</span><span id="line-91"></span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#processFrame"><span class="hs-identifier hs-var">processFrame</span></a></span><span> </span><span class="annot"><a href="Network.HTTP2.Arch.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span class="hs-special">{</span><span id="local-6989586621679092822"><span id="local-6989586621679092823"><span id="local-6989586621679092824"><span id="local-6989586621679092825"><span id="local-6989586621679092826"><span id="local-6989586621679092827"><span id="local-6989586621679092828"><span id="local-6989586621679092829"><span id="local-6989586621679092830"><span id="local-6989586621679092831"><span id="local-6989586621679092832"><span id="local-6989586621679092833"><span id="local-6989586621679092834"><span id="local-6989586621679092835"><span id="local-6989586621679092836"><span id="local-6989586621679092837"><span id="local-6989586621679092838"><span class="annot"><span class="annottext">TVar Int
IORef Bool
IORef Int
IORef (Maybe Int)
IORef Settings
TQueue Control
TQueue (Output Stream)
DynamicTable
Rate
StreamTable
RoleInfo
Role
emptyFrameRate :: Rate
settingsRate :: Rate
pingRate :: Rate
connectionWindow :: TVar Int
decodeDynamicTable :: DynamicTable
encodeDynamicTable :: DynamicTable
controlQ :: TQueue Control
outputQ :: TQueue (Output Stream)
peerStreamId :: IORef Int
myStreamId :: IORef Int
continued :: IORef (Maybe Int)
concurrency :: IORef Int
streamTable :: StreamTable
firstSettings :: IORef Bool
http2settings :: IORef Settings
roleInfo :: RoleInfo
role :: Role
emptyFrameRate :: Context -&gt; Rate
settingsRate :: Context -&gt; Rate
pingRate :: Context -&gt; Rate
connectionWindow :: Context -&gt; TVar Int
decodeDynamicTable :: Context -&gt; DynamicTable
encodeDynamicTable :: Context -&gt; DynamicTable
controlQ :: Context -&gt; TQueue Control
outputQ :: Context -&gt; TQueue (Output Stream)
peerStreamId :: Context -&gt; IORef Int
myStreamId :: Context -&gt; IORef Int
continued :: Context -&gt; IORef (Maybe Int)
concurrency :: Context -&gt; IORef Int
streamTable :: Context -&gt; StreamTable
firstSettings :: Context -&gt; IORef Bool
http2settings :: Context -&gt; IORef Settings
roleInfo :: Context -&gt; RoleInfo
role :: Context -&gt; Role
</span><a href="#local-6989586621679092822"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679092821"><span class="annot"><span class="annottext">RecvN
</span><a href="#local-6989586621679092821"><span class="hs-identifier hs-var">recvN</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameUnknown"><span class="hs-identifier hs-type">FrameUnknown</span></a></span><span> </span><span class="annot"><span class="annottext">FrameFlags
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameHeader"><span class="hs-identifier hs-type">FrameHeader</span></a></span><span class="hs-special">{</span><span id="local-6989586621679092819"><span class="annot"><span class="annottext">Int
payloadLength :: FrameHeader -&gt; Int
payloadLength :: Int
</span><a href="Network.HTTP2.Frame.Types.html#payloadLength"><span class="hs-identifier hs-var hs-var">payloadLength</span></a></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-92"></span><span>    </span><span id="local-6989586621679092817"><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621679092817"><span class="hs-identifier hs-var">mx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef (Maybe Int) -&gt; IO (Maybe Int)
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef (Maybe Int)
</span><a href="#local-6989586621679092832"><span class="hs-identifier hs-var">continued</span></a></span><span>
</span><span id="line-93"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621679092817"><span class="hs-identifier hs-var">mx</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-94"></span><span>        </span><span class="annot"><span class="annottext">Maybe Int
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-95"></span><span>            </span><span class="hs-comment">-- ignoring unknown frame</span><span>
</span><span id="line-96"></span><span>            </span><span class="annot"><span class="annottext">IO ByteString -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(IO ByteString -&gt; IO ()) -&gt; IO ByteString -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RecvN
</span><a href="#local-6989586621679092821"><span class="hs-identifier hs-var">recvN</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092819"><span class="hs-identifier hs-var">payloadLength</span></a></span><span>
</span><span id="line-97"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; IO Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-98"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO Bool
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO Bool) -&gt; HTTP2Error -&gt; IO Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId -&gt; ByteString -&gt; HTTP2Error
</span><a href="Network.HTTP2.Frame.Types.html#ConnectionError"><span class="hs-identifier hs-var">ConnectionError</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId
</span><a href="Network.HTTP2.Frame.Types.html#ProtocolError"><span class="hs-identifier hs-var">ProtocolError</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;unknown frame&quot;</span></span><span>
</span><span id="line-99"></span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#processFrame"><span class="hs-identifier hs-var">processFrame</span></a></span><span> </span><span id="local-6989586621679092814"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679092814"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679092813"><span class="annot"><span class="annottext">RecvN
</span><a href="#local-6989586621679092813"><span class="hs-identifier hs-var">recvN</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FrameTypeId
</span><a href="Network.HTTP2.Frame.Types.html#FramePushPromise"><span class="hs-identifier hs-var">FramePushPromise</span></a></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679092811"><span class="annot"><span class="annottext">header :: FrameHeader
</span><a href="#local-6989586621679092811"><span class="hs-identifier hs-var">header</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameHeader"><span class="hs-identifier hs-type">FrameHeader</span></a></span><span class="hs-special">{</span><span id="local-6989586621679092810"><span class="annot"><span class="annottext">Int
payloadLength :: Int
payloadLength :: FrameHeader -&gt; Int
</span><a href="#local-6989586621679092810"><span class="hs-identifier hs-var hs-var">payloadLength</span></a></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-100"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Context -&gt; Bool
</span><a href="Network.HTTP2.Arch.Context.html#isServer"><span class="hs-identifier hs-var">isServer</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679092814"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO Bool
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO Bool) -&gt; HTTP2Error -&gt; IO Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId -&gt; ByteString -&gt; HTTP2Error
</span><a href="Network.HTTP2.Frame.Types.html#ConnectionError"><span class="hs-identifier hs-var">ConnectionError</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId
</span><a href="Network.HTTP2.Frame.Types.html#ProtocolError"><span class="hs-identifier hs-var">ProtocolError</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;push promise is not allowed&quot;</span></span><span>
</span><span id="line-101"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-102"></span><span>      </span><span id="local-6989586621679092809"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092809"><span class="hs-identifier hs-var">pl</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RecvN
</span><a href="#local-6989586621679092813"><span class="hs-identifier hs-var">recvN</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092810"><span class="hs-identifier hs-var">payloadLength</span></a></span><span>
</span><span id="line-103"></span><span>      </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#PushPromiseFrame"><span class="hs-identifier hs-type">PushPromiseFrame</span></a></span><span> </span><span id="local-6989586621679092807"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092807"><span class="hs-identifier hs-var">sid</span></a></span></span><span> </span><span id="local-6989586621679092806"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092806"><span class="hs-identifier hs-var">frag</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Either HTTP2Error FramePayload -&gt; IO FramePayload
forall a. Either HTTP2Error a -&gt; IO a
</span><a href="Network.HTTP2.Arch.Receiver.html#guardIt"><span class="hs-identifier hs-var">guardIt</span></a></span><span> </span><span class="annot"><span class="annottext">(Either HTTP2Error FramePayload -&gt; IO FramePayload)
-&gt; Either HTTP2Error FramePayload -&gt; IO FramePayload
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FramePayloadDecoder
</span><a href="Network.HTTP2.Frame.Decode.html#decodePushPromiseFrame"><span class="hs-identifier hs-var">decodePushPromiseFrame</span></a></span><span> </span><span class="annot"><span class="annottext">FrameHeader
</span><a href="#local-6989586621679092811"><span class="hs-identifier hs-var">header</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092809"><span class="hs-identifier hs-var">pl</span></a></span><span>
</span><span id="line-104"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Bool
</span><a href="Network.HTTP2.Frame.Types.html#isServerInitiated"><span class="hs-identifier hs-var">isServerInitiated</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092807"><span class="hs-identifier hs-var">sid</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-105"></span><span>          </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO ()
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO ()) -&gt; HTTP2Error -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId -&gt; ByteString -&gt; HTTP2Error
</span><a href="Network.HTTP2.Frame.Types.html#ConnectionError"><span class="hs-identifier hs-var">ConnectionError</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId
</span><a href="Network.HTTP2.Frame.Types.html#ProtocolError"><span class="hs-identifier hs-var">ProtocolError</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;wrong sid for push promise&quot;</span></span><span>
</span><span id="line-106"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092806"><span class="hs-identifier hs-var">frag</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-107"></span><span>          </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO ()
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO ()) -&gt; HTTP2Error -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId -&gt; ByteString -&gt; HTTP2Error
</span><a href="Network.HTTP2.Frame.Types.html#ConnectionError"><span class="hs-identifier hs-var">ConnectionError</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId
</span><a href="Network.HTTP2.Frame.Types.html#ProtocolError"><span class="hs-identifier hs-var">ProtocolError</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;wrong header fragment for push promise&quot;</span></span><span>
</span><span id="line-108"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TokenHeaderList
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span id="local-6989586621679092802"><span class="annot"><span class="annottext">ValueTable
</span><a href="#local-6989586621679092802"><span class="hs-identifier hs-var">vt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Context -&gt; IO (TokenHeaderList, ValueTable)
</span><a href="Network.HTTP2.Arch.HPACK.html#hpackDecodeHeader"><span class="hs-identifier hs-var">hpackDecodeHeader</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092806"><span class="hs-identifier hs-var">frag</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679092814"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-109"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Network.HTTP2.Arch.Context.html#ClientInfo"><span class="hs-identifier hs-type">ClientInfo</span></a></span><span class="hs-special">{</span><span id="local-6989586621679092797"><span id="local-6989586621679092798"><span id="local-6989586621679092799"><span class="annot"><span class="annottext">IORef (Cache (ByteString, ByteString) Stream)
ByteString
cache :: RoleInfo -&gt; IORef (Cache (ByteString, ByteString) Stream)
authority :: RoleInfo -&gt; ByteString
scheme :: RoleInfo -&gt; ByteString
cache :: IORef (Cache (ByteString, ByteString) Stream)
authority :: ByteString
scheme :: ByteString
</span><a href="Network.HTTP2.Arch.Context.html#cache"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Context -&gt; RoleInfo
</span><a href="Network.HTTP2.Arch.Context.html#roleInfo"><span class="hs-identifier hs-var hs-var">roleInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679092814"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-110"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Token -&gt; ValueTable -&gt; Maybe ByteString
</span><a href="Network.HPACK.HeaderBlock.Decode.html#getHeaderValue"><span class="hs-identifier hs-var">getHeaderValue</span></a></span><span> </span><span class="annot"><span class="annottext">Token
</span><a href="Network.HPACK.Token.html#tokenAuthority"><span class="hs-identifier hs-var">tokenAuthority</span></a></span><span> </span><span class="annot"><span class="annottext">ValueTable
</span><a href="#local-6989586621679092802"><span class="hs-identifier hs-var">vt</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ByteString -&gt; Maybe ByteString -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Maybe ByteString
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092798"><span class="hs-identifier hs-var">authority</span></a></span><span>
</span><span id="line-111"></span><span>         </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Token -&gt; ValueTable -&gt; Maybe ByteString
</span><a href="Network.HPACK.HeaderBlock.Decode.html#getHeaderValue"><span class="hs-identifier hs-var">getHeaderValue</span></a></span><span> </span><span class="annot"><span class="annottext">Token
</span><a href="Network.HPACK.Token.html#tokenScheme"><span class="hs-identifier hs-var">tokenScheme</span></a></span><span>    </span><span class="annot"><span class="annottext">ValueTable
</span><a href="#local-6989586621679092802"><span class="hs-identifier hs-var">vt</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ByteString -&gt; Maybe ByteString -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Maybe ByteString
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092799"><span class="hs-identifier hs-var">scheme</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-112"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679092790"><span class="annot"><span class="annottext">mmethod :: Maybe ByteString
</span><a href="#local-6989586621679092790"><span class="hs-identifier hs-var hs-var">mmethod</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Token -&gt; ValueTable -&gt; Maybe ByteString
</span><a href="Network.HPACK.HeaderBlock.Decode.html#getHeaderValue"><span class="hs-identifier hs-var">getHeaderValue</span></a></span><span> </span><span class="annot"><span class="annottext">Token
</span><a href="Network.HPACK.Token.html#tokenMethod"><span class="hs-identifier hs-var">tokenMethod</span></a></span><span> </span><span class="annot"><span class="annottext">ValueTable
</span><a href="#local-6989586621679092802"><span class="hs-identifier hs-var">vt</span></a></span><span>
</span><span id="line-113"></span><span>              </span><span id="local-6989586621679092788"><span class="annot"><span class="annottext">mpath :: Maybe ByteString
</span><a href="#local-6989586621679092788"><span class="hs-identifier hs-var hs-var">mpath</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Token -&gt; ValueTable -&gt; Maybe ByteString
</span><a href="Network.HPACK.HeaderBlock.Decode.html#getHeaderValue"><span class="hs-identifier hs-var">getHeaderValue</span></a></span><span> </span><span class="annot"><span class="annottext">Token
</span><a href="Network.HPACK.Token.html#tokenPath"><span class="hs-identifier hs-var">tokenPath</span></a></span><span>   </span><span class="annot"><span class="annottext">ValueTable
</span><a href="#local-6989586621679092802"><span class="hs-identifier hs-var">vt</span></a></span><span>
</span><span id="line-114"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe ByteString
</span><a href="#local-6989586621679092790"><span class="hs-identifier hs-var">mmethod</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe ByteString
</span><a href="#local-6989586621679092788"><span class="hs-identifier hs-var">mpath</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-115"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679092786"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092786"><span class="hs-identifier hs-var">method</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679092785"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092785"><span class="hs-identifier hs-var">path</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-116"></span><span>                </span><span id="local-6989586621679092784"><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679092784"><span class="hs-identifier hs-var">strm</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; Int -&gt; FrameTypeId -&gt; IO Stream
</span><a href="Network.HTTP2.Arch.Context.html#openStream"><span class="hs-identifier hs-var">openStream</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679092814"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092807"><span class="hs-identifier hs-var">sid</span></a></span><span> </span><span class="annot"><span class="annottext">FrameTypeId
</span><a href="Network.HTTP2.Frame.Types.html#FramePushPromise"><span class="hs-identifier hs-var">FramePushPromise</span></a></span><span>
</span><span id="line-117"></span><span>                </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString -&gt; Stream -&gt; RoleInfo -&gt; IO ()
</span><a href="Network.HTTP2.Arch.Context.html#insertCache"><span class="hs-identifier hs-var">insertCache</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092786"><span class="hs-identifier hs-var">method</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092785"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679092784"><span class="hs-identifier hs-var">strm</span></a></span><span> </span><span class="annot"><span class="annottext">(RoleInfo -&gt; IO ()) -&gt; RoleInfo -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; RoleInfo
</span><a href="Network.HTTP2.Arch.Context.html#roleInfo"><span class="hs-identifier hs-var hs-var">roleInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679092814"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-118"></span><span>            </span><span class="annot"><span class="annottext">(Maybe ByteString, Maybe ByteString)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-119"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; IO Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-120"></span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#processFrame"><span class="hs-identifier hs-var">processFrame</span></a></span><span> </span><span id="local-6989586621679092781"><span class="annot"><span class="annottext">ctx :: Context
</span><a href="#local-6989586621679092781"><span class="hs-identifier hs-var">ctx</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Network.HTTP2.Arch.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span class="hs-special">{</span><span id="local-6989586621679092764"><span id="local-6989586621679092765"><span id="local-6989586621679092766"><span id="local-6989586621679092767"><span id="local-6989586621679092768"><span id="local-6989586621679092769"><span id="local-6989586621679092770"><span id="local-6989586621679092771"><span id="local-6989586621679092772"><span id="local-6989586621679092773"><span id="local-6989586621679092774"><span id="local-6989586621679092775"><span id="local-6989586621679092776"><span id="local-6989586621679092777"><span id="local-6989586621679092778"><span id="local-6989586621679092779"><span id="local-6989586621679092780"><span class="annot"><span class="annottext">TVar Int
IORef Bool
IORef Int
IORef (Maybe Int)
IORef Settings
TQueue Control
TQueue (Output Stream)
DynamicTable
Rate
StreamTable
RoleInfo
Role
emptyFrameRate :: Rate
settingsRate :: Rate
pingRate :: Rate
connectionWindow :: TVar Int
decodeDynamicTable :: DynamicTable
encodeDynamicTable :: DynamicTable
controlQ :: TQueue Control
outputQ :: TQueue (Output Stream)
peerStreamId :: IORef Int
myStreamId :: IORef Int
continued :: IORef (Maybe Int)
concurrency :: IORef Int
streamTable :: StreamTable
firstSettings :: IORef Bool
http2settings :: IORef Settings
roleInfo :: RoleInfo
role :: Role
emptyFrameRate :: Context -&gt; Rate
settingsRate :: Context -&gt; Rate
pingRate :: Context -&gt; Rate
connectionWindow :: Context -&gt; TVar Int
decodeDynamicTable :: Context -&gt; DynamicTable
encodeDynamicTable :: Context -&gt; DynamicTable
controlQ :: Context -&gt; TQueue Control
outputQ :: Context -&gt; TQueue (Output Stream)
peerStreamId :: Context -&gt; IORef Int
myStreamId :: Context -&gt; IORef Int
continued :: Context -&gt; IORef (Maybe Int)
concurrency :: Context -&gt; IORef Int
streamTable :: Context -&gt; StreamTable
firstSettings :: Context -&gt; IORef Bool
http2settings :: Context -&gt; IORef Settings
roleInfo :: Context -&gt; RoleInfo
role :: Context -&gt; Role
</span><a href="#local-6989586621679092764"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679092763"><span class="annot"><span class="annottext">RecvN
</span><a href="#local-6989586621679092763"><span class="hs-identifier hs-var">recvN</span></a></span></span><span> </span><span id="local-6989586621679092762"><span class="annot"><span class="annottext">typhdr :: (FrameTypeId, FrameHeader)
</span><a href="#local-6989586621679092762"><span class="hs-identifier hs-var">typhdr</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621679092761"><span class="annot"><span class="annottext">FrameTypeId
</span><a href="#local-6989586621679092761"><span class="hs-identifier hs-var">ftyp</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679092760"><span class="annot"><span class="annottext">header :: FrameHeader
</span><a href="#local-6989586621679092760"><span class="hs-identifier hs-var">header</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameHeader"><span class="hs-identifier hs-type">FrameHeader</span></a></span><span class="hs-special">{</span><span id="local-6989586621679092759"><span class="annot"><span class="annottext">Int
payloadLength :: Int
payloadLength :: FrameHeader -&gt; Int
</span><a href="#local-6989586621679092759"><span class="hs-identifier hs-var hs-var">payloadLength</span></a></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-121"></span><span>    </span><span id="local-6989586621679092758"><span class="annot"><span class="annottext">Settings
</span><a href="#local-6989586621679092758"><span class="hs-identifier hs-var">settings</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef Settings -&gt; IO Settings
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef Settings
</span><a href="#local-6989586621679092778"><span class="hs-identifier hs-var">http2settings</span></a></span><span>
</span><span id="line-122"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Settings
-&gt; (FrameTypeId, FrameHeader)
-&gt; Either HTTP2Error (FrameTypeId, FrameHeader)
</span><a href="Network.HTTP2.Frame.Decode.html#checkFrameHeader"><span class="hs-identifier hs-var">checkFrameHeader</span></a></span><span> </span><span class="annot"><span class="annottext">Settings
</span><a href="#local-6989586621679092758"><span class="hs-identifier hs-var">settings</span></a></span><span> </span><span class="annot"><span class="annottext">(FrameTypeId, FrameHeader)
</span><a href="#local-6989586621679092762"><span class="hs-identifier hs-var">typhdr</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-123"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679092756"><span class="annot"><span class="annottext">HTTP2Error
</span><a href="#local-6989586621679092756"><span class="hs-identifier hs-var">h2err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">HTTP2Error
</span><a href="#local-6989586621679092756"><span class="hs-identifier hs-var">h2err</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-124"></span><span>          </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#StreamError"><span class="hs-identifier hs-type">StreamError</span></a></span><span> </span><span id="local-6989586621679092754"><span class="annot"><span class="annottext">ErrorCodeId
</span><a href="#local-6989586621679092754"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span id="local-6989586621679092753"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092753"><span class="hs-identifier hs-var">sid</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-125"></span><span>              </span><span class="annot"><span class="annottext">ErrorCodeId -&gt; Int -&gt; IO ()
</span><a href="#local-6989586621679092752"><span class="hs-identifier hs-var">resetStream</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId
</span><a href="#local-6989586621679092754"><span class="hs-identifier hs-var">err</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092753"><span class="hs-identifier hs-var">sid</span></a></span><span>
</span><span id="line-126"></span><span>              </span><span class="annot"><span class="annottext">IO ByteString -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(IO ByteString -&gt; IO ()) -&gt; IO ByteString -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RecvN
</span><a href="#local-6989586621679092763"><span class="hs-identifier hs-var">recvN</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092759"><span class="hs-identifier hs-var">payloadLength</span></a></span><span>
</span><span id="line-127"></span><span>              </span><span class="annot"><span class="annottext">Bool -&gt; IO Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-128"></span><span>          </span><span id="local-6989586621679092751"><span class="annot"><span class="annottext">HTTP2Error
</span><a href="#local-6989586621679092751"><span class="hs-identifier hs-var">connErr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO Bool
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">HTTP2Error
</span><a href="#local-6989586621679092751"><span class="hs-identifier hs-var">connErr</span></a></span><span>
</span><span id="line-129"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="annot"><span class="annottext">(FrameTypeId, FrameHeader)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-130"></span><span>          </span><span id="local-6989586621679092750"><span class="annot"><span class="annottext">Either HTTP2Error Bool
</span><a href="#local-6989586621679092750"><span class="hs-identifier hs-var">ex</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO Bool -&gt; IO (Either HTTP2Error Bool)
forall e a. Exception e =&gt; IO a -&gt; IO (Either e a)
</span><span class="hs-identifier hs-var">E.try</span></span><span> </span><span class="annot"><span class="annottext">(IO Bool -&gt; IO (Either HTTP2Error Bool))
-&gt; IO Bool -&gt; IO (Either HTTP2Error Bool)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; RecvN -&gt; FrameTypeId -&gt; FrameHeader -&gt; IO Bool
</span><a href="Network.HTTP2.Arch.Receiver.html#controlOrStream"><span class="hs-identifier hs-var">controlOrStream</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679092781"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">RecvN
</span><a href="#local-6989586621679092763"><span class="hs-identifier hs-var">recvN</span></a></span><span> </span><span class="annot"><span class="annottext">FrameTypeId
</span><a href="#local-6989586621679092761"><span class="hs-identifier hs-var">ftyp</span></a></span><span> </span><span class="annot"><span class="annottext">FrameHeader
</span><a href="#local-6989586621679092760"><span class="hs-identifier hs-var">header</span></a></span><span>
</span><span id="line-131"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either HTTP2Error Bool
</span><a href="#local-6989586621679092750"><span class="hs-identifier hs-var">ex</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-132"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#StreamError"><span class="hs-identifier hs-type">StreamError</span></a></span><span> </span><span id="local-6989586621679092747"><span class="annot"><span class="annottext">ErrorCodeId
</span><a href="#local-6989586621679092747"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span id="local-6989586621679092746"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092746"><span class="hs-identifier hs-var">sid</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-133"></span><span>                  </span><span class="annot"><span class="annottext">ErrorCodeId -&gt; Int -&gt; IO ()
</span><a href="#local-6989586621679092752"><span class="hs-identifier hs-var">resetStream</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId
</span><a href="#local-6989586621679092747"><span class="hs-identifier hs-var">err</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092746"><span class="hs-identifier hs-var">sid</span></a></span><span>
</span><span id="line-134"></span><span>                  </span><span class="annot"><span class="annottext">Bool -&gt; IO Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-135"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679092745"><span class="annot"><span class="annottext">HTTP2Error
</span><a href="#local-6989586621679092745"><span class="hs-identifier hs-var">connErr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO Bool
forall a e. Exception e =&gt; e -&gt; a
</span><span class="hs-identifier hs-var">E.throw</span></span><span> </span><span class="annot"><span class="annottext">HTTP2Error
</span><a href="#local-6989586621679092745"><span class="hs-identifier hs-var">connErr</span></a></span><span>
</span><span id="line-136"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679092743"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679092743"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IO Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679092743"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-137"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-138"></span><span>    </span><span id="local-6989586621679092752"><span class="annot"><span class="annottext">resetStream :: ErrorCodeId -&gt; Int -&gt; IO ()
</span><a href="#local-6989586621679092752"><span class="hs-identifier hs-var hs-var">resetStream</span></a></span></span><span> </span><span id="local-6989586621679092742"><span class="annot"><span class="annottext">ErrorCodeId
</span><a href="#local-6989586621679092742"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span id="local-6989586621679092741"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092741"><span class="hs-identifier hs-var">sid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-139"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679092740"><span class="annot"><span class="annottext">frame :: ByteString
</span><a href="#local-6989586621679092740"><span class="hs-identifier hs-var hs-var">frame</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ErrorCodeId -&gt; Int -&gt; ByteString
</span><a href="Network.HTTP2.Arch.EncodeFrame.html#resetFrame"><span class="hs-identifier hs-var">resetFrame</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId
</span><a href="#local-6989586621679092742"><span class="hs-identifier hs-var">err</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092741"><span class="hs-identifier hs-var">sid</span></a></span><span>
</span><span id="line-140"></span><span>        </span><span class="annot"><span class="annottext">TQueue Control -&gt; Control -&gt; IO ()
</span><a href="Network.HTTP2.Arch.Queue.html#enqueueControl"><span class="hs-identifier hs-var">enqueueControl</span></a></span><span> </span><span class="annot"><span class="annottext">TQueue Control
</span><a href="#local-6989586621679092770"><span class="hs-identifier hs-var">controlQ</span></a></span><span> </span><span class="annot"><span class="annottext">(Control -&gt; IO ()) -&gt; Control -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Control
</span><a href="Network.HTTP2.Arch.Types.html#CFrame"><span class="hs-identifier hs-var">CFrame</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092740"><span class="hs-identifier hs-var">frame</span></a></span><span>
</span><span id="line-141"></span><span>
</span><span id="line-142"></span><span class="hs-comment">----------------------------------------------------------------</span><span>
</span><span id="line-143"></span><span>
</span><span id="line-144"></span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#controlOrStream"><span class="hs-identifier hs-type">controlOrStream</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP2.Arch.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#RecvN"><span class="hs-identifier hs-type">RecvN</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameTypeId"><span class="hs-identifier hs-type">FrameTypeId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameHeader"><span class="hs-identifier hs-type">FrameHeader</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-145"></span><span id="controlOrStream"><span class="annot"><span class="annottext">controlOrStream :: Context -&gt; RecvN -&gt; FrameTypeId -&gt; FrameHeader -&gt; IO Bool
</span><a href="Network.HTTP2.Arch.Receiver.html#controlOrStream"><span class="hs-identifier hs-var hs-var">controlOrStream</span></a></span></span><span> </span><span id="local-6989586621679092737"><span class="annot"><span class="annottext">ctx :: Context
</span><a href="#local-6989586621679092737"><span class="hs-identifier hs-var">ctx</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Network.HTTP2.Arch.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span class="hs-special">{</span><span id="local-6989586621679092720"><span id="local-6989586621679092721"><span id="local-6989586621679092722"><span id="local-6989586621679092723"><span id="local-6989586621679092724"><span id="local-6989586621679092725"><span id="local-6989586621679092726"><span id="local-6989586621679092727"><span id="local-6989586621679092728"><span id="local-6989586621679092729"><span id="local-6989586621679092730"><span id="local-6989586621679092731"><span id="local-6989586621679092732"><span id="local-6989586621679092733"><span id="local-6989586621679092734"><span id="local-6989586621679092735"><span id="local-6989586621679092736"><span class="annot"><span class="annottext">TVar Int
IORef Bool
IORef Int
IORef (Maybe Int)
IORef Settings
TQueue Control
TQueue (Output Stream)
DynamicTable
Rate
StreamTable
RoleInfo
Role
emptyFrameRate :: Rate
settingsRate :: Rate
pingRate :: Rate
connectionWindow :: TVar Int
decodeDynamicTable :: DynamicTable
encodeDynamicTable :: DynamicTable
controlQ :: TQueue Control
outputQ :: TQueue (Output Stream)
peerStreamId :: IORef Int
myStreamId :: IORef Int
continued :: IORef (Maybe Int)
concurrency :: IORef Int
streamTable :: StreamTable
firstSettings :: IORef Bool
http2settings :: IORef Settings
roleInfo :: RoleInfo
role :: Role
emptyFrameRate :: Context -&gt; Rate
settingsRate :: Context -&gt; Rate
pingRate :: Context -&gt; Rate
connectionWindow :: Context -&gt; TVar Int
decodeDynamicTable :: Context -&gt; DynamicTable
encodeDynamicTable :: Context -&gt; DynamicTable
controlQ :: Context -&gt; TQueue Control
outputQ :: Context -&gt; TQueue (Output Stream)
peerStreamId :: Context -&gt; IORef Int
myStreamId :: Context -&gt; IORef Int
continued :: Context -&gt; IORef (Maybe Int)
concurrency :: Context -&gt; IORef Int
streamTable :: Context -&gt; StreamTable
firstSettings :: Context -&gt; IORef Bool
http2settings :: Context -&gt; IORef Settings
roleInfo :: Context -&gt; RoleInfo
role :: Context -&gt; Role
</span><a href="#local-6989586621679092720"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679092719"><span class="annot"><span class="annottext">RecvN
</span><a href="#local-6989586621679092719"><span class="hs-identifier hs-var">recvN</span></a></span></span><span> </span><span id="local-6989586621679092718"><span class="annot"><span class="annottext">FrameTypeId
</span><a href="#local-6989586621679092718"><span class="hs-identifier hs-var">ftyp</span></a></span></span><span> </span><span id="local-6989586621679092717"><span class="annot"><span class="annottext">header :: FrameHeader
</span><a href="#local-6989586621679092717"><span class="hs-identifier hs-var">header</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameHeader"><span class="hs-identifier hs-type">FrameHeader</span></a></span><span class="hs-special">{</span><span id="local-6989586621679092716"><span class="annot"><span class="annottext">Int
streamId :: Int
streamId :: FrameHeader -&gt; Int
</span><a href="#local-6989586621679092716"><span class="hs-identifier hs-var hs-var">streamId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679092715"><span class="annot"><span class="annottext">Int
payloadLength :: Int
payloadLength :: FrameHeader -&gt; Int
</span><a href="#local-6989586621679092715"><span class="hs-identifier hs-var hs-var">payloadLength</span></a></span></span><span class="hs-special">}</span><span>
</span><span id="line-146"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Bool
</span><a href="Network.HTTP2.Frame.Types.html#isControl"><span class="hs-identifier hs-var">isControl</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092716"><span class="hs-identifier hs-var">streamId</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-147"></span><span>      </span><span id="local-6989586621679092713"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092713"><span class="hs-identifier hs-var">pl</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RecvN
</span><a href="#local-6989586621679092719"><span class="hs-identifier hs-var">recvN</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092715"><span class="hs-identifier hs-var">payloadLength</span></a></span><span>
</span><span id="line-148"></span><span>      </span><span class="annot"><span class="annottext">FrameTypeId -&gt; FrameHeader -&gt; ByteString -&gt; Context -&gt; IO Bool
</span><a href="Network.HTTP2.Arch.Receiver.html#control"><span class="hs-identifier hs-var">control</span></a></span><span> </span><span class="annot"><span class="annottext">FrameTypeId
</span><a href="#local-6989586621679092718"><span class="hs-identifier hs-var">ftyp</span></a></span><span> </span><span class="annot"><span class="annottext">FrameHeader
</span><a href="#local-6989586621679092717"><span class="hs-identifier hs-var">header</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092713"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679092737"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-149"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-150"></span><span>      </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679092711"><span class="hs-identifier hs-var">checkContinued</span></a></span><span>
</span><span id="line-151"></span><span>      </span><span id="local-6989586621679092710"><span class="annot"><span class="annottext">Maybe Stream
</span><a href="#local-6989586621679092710"><span class="hs-identifier hs-var">mstrm</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; FrameTypeId -&gt; Int -&gt; IO (Maybe Stream)
</span><a href="Network.HTTP2.Arch.Receiver.html#getStream"><span class="hs-identifier hs-var">getStream</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679092737"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">FrameTypeId
</span><a href="#local-6989586621679092718"><span class="hs-identifier hs-var">ftyp</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092716"><span class="hs-identifier hs-var">streamId</span></a></span><span>
</span><span id="line-152"></span><span>      </span><span id="local-6989586621679092708"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092708"><span class="hs-identifier hs-var">pl</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RecvN
</span><a href="#local-6989586621679092719"><span class="hs-identifier hs-var">recvN</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092715"><span class="hs-identifier hs-var">payloadLength</span></a></span><span>
</span><span id="line-153"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Stream
</span><a href="#local-6989586621679092710"><span class="hs-identifier hs-var">mstrm</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-154"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679092707"><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679092707"><span class="hs-identifier hs-var">strm</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-155"></span><span>            </span><span id="local-6989586621679092706"><span class="annot"><span class="annottext">StreamState
</span><a href="#local-6989586621679092706"><span class="hs-identifier hs-var">state0</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Stream -&gt; IO StreamState
</span><a href="Network.HTTP2.Arch.Stream.html#readStreamState"><span class="hs-identifier hs-var">readStreamState</span></a></span><span> </span><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679092707"><span class="hs-identifier hs-var">strm</span></a></span><span>
</span><span id="line-156"></span><span>            </span><span id="local-6989586621679092704"><span class="annot"><span class="annottext">StreamState
</span><a href="#local-6989586621679092704"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FrameTypeId
-&gt; FrameHeader
-&gt; ByteString
-&gt; Context
-&gt; StreamState
-&gt; Stream
-&gt; IO StreamState
</span><a href="Network.HTTP2.Arch.Receiver.html#stream"><span class="hs-identifier hs-var">stream</span></a></span><span> </span><span class="annot"><span class="annottext">FrameTypeId
</span><a href="#local-6989586621679092718"><span class="hs-identifier hs-var">ftyp</span></a></span><span> </span><span class="annot"><span class="annottext">FrameHeader
</span><a href="#local-6989586621679092717"><span class="hs-identifier hs-var">header</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092708"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679092737"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">StreamState
</span><a href="#local-6989586621679092706"><span class="hs-identifier hs-var">state0</span></a></span><span> </span><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679092707"><span class="hs-identifier hs-var">strm</span></a></span><span>
</span><span id="line-157"></span><span>            </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679092702"><span class="hs-identifier hs-var">resetContinued</span></a></span><span>
</span><span id="line-158"></span><span>            </span><span id="local-6989586621679092701"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679092701"><span class="hs-identifier hs-var">set</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StreamState -&gt; Context -&gt; Stream -&gt; Int -&gt; IO Bool
</span><a href="Network.HTTP2.Arch.Receiver.html#processState"><span class="hs-identifier hs-var">processState</span></a></span><span> </span><span class="annot"><span class="annottext">StreamState
</span><a href="#local-6989586621679092704"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679092737"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679092707"><span class="hs-identifier hs-var">strm</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092716"><span class="hs-identifier hs-var">streamId</span></a></span><span>
</span><span id="line-159"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679092701"><span class="hs-identifier hs-var">set</span></a></span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679092699"><span class="hs-identifier hs-var">setContinued</span></a></span><span>
</span><span id="line-160"></span><span>        </span><span class="annot"><span class="annottext">Maybe Stream
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-161"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">FrameTypeId
</span><a href="#local-6989586621679092718"><span class="hs-identifier hs-var">ftyp</span></a></span><span> </span><span class="annot"><span class="annottext">FrameTypeId -&gt; FrameTypeId -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">FrameTypeId
</span><a href="Network.HTTP2.Frame.Types.html#FramePriority"><span class="hs-identifier hs-var">FramePriority</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-162"></span><span>                </span><span class="hs-comment">-- for h2spec only</span><span>
</span><span id="line-163"></span><span>                </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#PriorityFrame"><span class="hs-identifier hs-type">PriorityFrame</span></a></span><span> </span><span id="local-6989586621679092697"><span class="annot"><span class="annottext">Priority
</span><a href="#local-6989586621679092697"><span class="hs-identifier hs-var">newpri</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Either HTTP2Error FramePayload -&gt; IO FramePayload
forall a. Either HTTP2Error a -&gt; IO a
</span><a href="Network.HTTP2.Arch.Receiver.html#guardIt"><span class="hs-identifier hs-var">guardIt</span></a></span><span> </span><span class="annot"><span class="annottext">(Either HTTP2Error FramePayload -&gt; IO FramePayload)
-&gt; Either HTTP2Error FramePayload -&gt; IO FramePayload
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FramePayloadDecoder
</span><a href="Network.HTTP2.Frame.Decode.html#decodePriorityFrame"><span class="hs-identifier hs-var">decodePriorityFrame</span></a></span><span> </span><span class="annot"><span class="annottext">FrameHeader
</span><a href="#local-6989586621679092717"><span class="hs-identifier hs-var">header</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092708"><span class="hs-identifier hs-var">pl</span></a></span><span>
</span><span id="line-164"></span><span>                </span><span class="annot"><span class="annottext">Priority -&gt; Int -&gt; IO ()
</span><a href="Network.HTTP2.Arch.Receiver.html#checkPriority"><span class="hs-identifier hs-var">checkPriority</span></a></span><span> </span><span class="annot"><span class="annottext">Priority
</span><a href="#local-6989586621679092697"><span class="hs-identifier hs-var">newpri</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092716"><span class="hs-identifier hs-var">streamId</span></a></span><span>
</span><span id="line-165"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-166"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; IO Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-167"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-168"></span><span>    </span><span id="local-6989586621679092699"><span class="annot"><span class="annottext">setContinued :: IO ()
</span><a href="#local-6989586621679092699"><span class="hs-identifier hs-var hs-var">setContinued</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IORef (Maybe Int) -&gt; Maybe Int -&gt; IO ()
forall a. IORef a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">writeIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef (Maybe Int)
</span><a href="#local-6989586621679092730"><span class="hs-identifier hs-var">continued</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe Int -&gt; IO ()) -&gt; Maybe Int -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Maybe Int
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092716"><span class="hs-identifier hs-var">streamId</span></a></span><span>
</span><span id="line-169"></span><span>    </span><span id="local-6989586621679092702"><span class="annot"><span class="annottext">resetContinued :: IO ()
</span><a href="#local-6989586621679092702"><span class="hs-identifier hs-var hs-var">resetContinued</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IORef (Maybe Int) -&gt; Maybe Int -&gt; IO ()
forall a. IORef a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">writeIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef (Maybe Int)
</span><a href="#local-6989586621679092730"><span class="hs-identifier hs-var">continued</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Int
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-170"></span><span>    </span><span id="local-6989586621679092711"><span class="annot"><span class="annottext">checkContinued :: IO ()
</span><a href="#local-6989586621679092711"><span class="hs-identifier hs-var hs-var">checkContinued</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-171"></span><span>        </span><span id="local-6989586621679092693"><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621679092693"><span class="hs-identifier hs-var">mx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef (Maybe Int) -&gt; IO (Maybe Int)
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef (Maybe Int)
</span><a href="#local-6989586621679092730"><span class="hs-identifier hs-var">continued</span></a></span><span>
</span><span id="line-172"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621679092693"><span class="hs-identifier hs-var">mx</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-173"></span><span>            </span><span class="annot"><span class="annottext">Maybe Int
</span><span class="hs-identifier hs-var">Nothing</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-174"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679092692"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092692"><span class="hs-identifier hs-var">sid</span></a></span></span><span>
</span><span id="line-175"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092692"><span class="hs-identifier hs-var">sid</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092716"><span class="hs-identifier hs-var">streamId</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">FrameTypeId
</span><a href="#local-6989586621679092718"><span class="hs-identifier hs-var">ftyp</span></a></span><span> </span><span class="annot"><span class="annottext">FrameTypeId -&gt; FrameTypeId -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">FrameTypeId
</span><a href="Network.HTTP2.Frame.Types.html#FrameContinuation"><span class="hs-identifier hs-var">FrameContinuation</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-176"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO ()
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO ()) -&gt; HTTP2Error -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId -&gt; ByteString -&gt; HTTP2Error
</span><a href="Network.HTTP2.Frame.Types.html#ConnectionError"><span class="hs-identifier hs-var">ConnectionError</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId
</span><a href="Network.HTTP2.Frame.Types.html#ProtocolError"><span class="hs-identifier hs-var">ProtocolError</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;continuation frame must follow&quot;</span></span><span>
</span><span id="line-177"></span><span>
</span><span id="line-178"></span><span class="hs-comment">----------------------------------------------------------------</span><span>
</span><span id="line-179"></span><span>
</span><span id="line-180"></span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#processState"><span class="hs-identifier hs-type">processState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP2.Arch.Types.html#StreamState"><span class="hs-identifier hs-type">StreamState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.Arch.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.Arch.Types.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#StreamId"><span class="hs-identifier hs-type">StreamId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-181"></span><span id="processState"><span class="annot"><span class="annottext">processState :: StreamState -&gt; Context -&gt; Stream -&gt; Int -&gt; IO Bool
</span><a href="Network.HTTP2.Arch.Receiver.html#processState"><span class="hs-identifier hs-var hs-var">processState</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.Arch.Types.html#Open"><span class="hs-identifier hs-type">Open</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.Arch.Types.html#NoBody"><span class="hs-identifier hs-type">NoBody</span></a></span><span> </span><span id="local-6989586621679092687"><span class="annot"><span class="annottext">tbl :: (TokenHeaderList, ValueTable)
</span><a href="#local-6989586621679092687"><span class="hs-identifier hs-var">tbl</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="annottext">TokenHeaderList
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span id="local-6989586621679092686"><span class="annot"><span class="annottext">ValueTable
</span><a href="#local-6989586621679092686"><span class="hs-identifier hs-var">reqvt</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621679092685"><span class="annot"><span class="annottext">ctx :: Context
</span><a href="#local-6989586621679092685"><span class="hs-identifier hs-var">ctx</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Network.HTTP2.Arch.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span class="hs-special">{</span><span id="local-6989586621679092668"><span id="local-6989586621679092669"><span id="local-6989586621679092670"><span id="local-6989586621679092671"><span id="local-6989586621679092672"><span id="local-6989586621679092673"><span id="local-6989586621679092674"><span id="local-6989586621679092675"><span id="local-6989586621679092676"><span id="local-6989586621679092677"><span id="local-6989586621679092678"><span id="local-6989586621679092679"><span id="local-6989586621679092680"><span id="local-6989586621679092681"><span id="local-6989586621679092682"><span id="local-6989586621679092683"><span id="local-6989586621679092684"><span class="annot"><span class="annottext">TVar Int
IORef Bool
IORef Int
IORef (Maybe Int)
IORef Settings
TQueue Control
TQueue (Output Stream)
DynamicTable
Rate
StreamTable
RoleInfo
Role
emptyFrameRate :: Rate
settingsRate :: Rate
pingRate :: Rate
connectionWindow :: TVar Int
decodeDynamicTable :: DynamicTable
encodeDynamicTable :: DynamicTable
controlQ :: TQueue Control
outputQ :: TQueue (Output Stream)
peerStreamId :: IORef Int
myStreamId :: IORef Int
continued :: IORef (Maybe Int)
concurrency :: IORef Int
streamTable :: StreamTable
firstSettings :: IORef Bool
http2settings :: IORef Settings
roleInfo :: RoleInfo
role :: Role
emptyFrameRate :: Context -&gt; Rate
settingsRate :: Context -&gt; Rate
pingRate :: Context -&gt; Rate
connectionWindow :: Context -&gt; TVar Int
decodeDynamicTable :: Context -&gt; DynamicTable
encodeDynamicTable :: Context -&gt; DynamicTable
controlQ :: Context -&gt; TQueue Control
outputQ :: Context -&gt; TQueue (Output Stream)
peerStreamId :: Context -&gt; IORef Int
myStreamId :: Context -&gt; IORef Int
continued :: Context -&gt; IORef (Maybe Int)
concurrency :: Context -&gt; IORef Int
streamTable :: Context -&gt; StreamTable
firstSettings :: Context -&gt; IORef Bool
http2settings :: Context -&gt; IORef Settings
roleInfo :: Context -&gt; RoleInfo
role :: Context -&gt; Role
</span><a href="#local-6989586621679092668"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679092667"><span class="annot"><span class="annottext">strm :: Stream
</span><a href="#local-6989586621679092667"><span class="hs-identifier hs-var">strm</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Network.HTTP2.Arch.Types.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span class="hs-special">{</span><span id="local-6989586621679092665"><span class="annot"><span class="annottext">MVar InpObj
streamInput :: Stream -&gt; MVar InpObj
streamInput :: MVar InpObj
</span><a href="Network.HTTP2.Arch.Types.html#streamInput"><span class="hs-identifier hs-var hs-var">streamInput</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679092663"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092663"><span class="hs-identifier hs-var">streamId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-182"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679092662"><span class="annot"><span class="annottext">mcl :: Maybe Int
</span><a href="#local-6989586621679092662"><span class="hs-identifier hs-var hs-var">mcl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Int, ByteString) -&gt; Int
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">((Int, ByteString) -&gt; Int) -&gt; Maybe (Int, ByteString) -&gt; Maybe Int
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Token -&gt; ValueTable -&gt; Maybe ByteString
</span><a href="Network.HPACK.HeaderBlock.Decode.html#getHeaderValue"><span class="hs-identifier hs-var">getHeaderValue</span></a></span><span> </span><span class="annot"><span class="annottext">Token
</span><a href="Network.HPACK.Token.html#tokenContentLength"><span class="hs-identifier hs-var">tokenContentLength</span></a></span><span> </span><span class="annot"><span class="annottext">ValueTable
</span><a href="#local-6989586621679092686"><span class="hs-identifier hs-var">reqvt</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ByteString
-&gt; (ByteString -&gt; Maybe (Int, ByteString))
-&gt; Maybe (Int, ByteString)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Maybe (Int, ByteString)
</span><span class="hs-identifier hs-var">C8.readInt</span></span><span class="hs-special">)</span><span>
</span><span id="line-183"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Int -&gt; (Int -&gt; Bool) -&gt; Bool
forall a. Maybe a -&gt; (a -&gt; Bool) -&gt; Bool
</span><a href="Network.HTTP2.Arch.HPACK.html#just"><span class="hs-identifier hs-var">just</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621679092662"><span class="hs-identifier hs-var">mcl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO ()
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO ()) -&gt; HTTP2Error -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId -&gt; Int -&gt; HTTP2Error
</span><a href="Network.HTTP2.Frame.Types.html#StreamError"><span class="hs-identifier hs-var">StreamError</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId
</span><a href="Network.HTTP2.Frame.Types.html#ProtocolError"><span class="hs-identifier hs-var">ProtocolError</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092663"><span class="hs-identifier hs-var">streamId</span></a></span><span>
</span><span id="line-184"></span><span>    </span><span class="annot"><span class="annottext">Context -&gt; Stream -&gt; IO ()
</span><a href="Network.HTTP2.Arch.Context.html#halfClosedRemote"><span class="hs-identifier hs-var">halfClosedRemote</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679092685"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679092667"><span class="hs-identifier hs-var">strm</span></a></span><span>
</span><span id="line-185"></span><span>    </span><span id="local-6989586621679092655"><span class="annot"><span class="annottext">IORef (Maybe (TokenHeaderList, ValueTable))
</span><a href="#local-6989586621679092655"><span class="hs-identifier hs-var">tlr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe (TokenHeaderList, ValueTable)
-&gt; IO (IORef (Maybe (TokenHeaderList, ValueTable)))
forall a. a -&gt; IO (IORef a)
</span><span class="hs-identifier hs-var">newIORef</span></span><span> </span><span class="annot"><span class="annottext">Maybe (TokenHeaderList, ValueTable)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-186"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679092653"><span class="annot"><span class="annottext">inpObj :: InpObj
</span><a href="#local-6989586621679092653"><span class="hs-identifier hs-var hs-var">inpObj</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TokenHeaderList, ValueTable)
-&gt; Maybe Int
-&gt; IO ByteString
-&gt; IORef (Maybe (TokenHeaderList, ValueTable))
-&gt; InpObj
</span><a href="Network.HTTP2.Arch.Types.html#InpObj"><span class="hs-identifier hs-var">InpObj</span></a></span><span> </span><span class="annot"><span class="annottext">(TokenHeaderList, ValueTable)
</span><a href="#local-6989586621679092687"><span class="hs-identifier hs-var">tbl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Maybe Int
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; IO ByteString
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IORef (Maybe (TokenHeaderList, ValueTable))
</span><a href="#local-6989586621679092655"><span class="hs-identifier hs-var">tlr</span></a></span><span>
</span><span id="line-187"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Context -&gt; Bool
</span><a href="Network.HTTP2.Arch.Context.html#isServer"><span class="hs-identifier hs-var">isServer</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679092685"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="hs-keyword">then</span><span>
</span><span id="line-188"></span><span>        </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TQueue (Input Stream) -&gt; Input Stream -&gt; STM ()
forall a. TQueue a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTQueue</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RoleInfo -&gt; TQueue (Input Stream)
</span><a href="Network.HTTP2.Arch.Context.html#inputQ"><span class="hs-identifier hs-var hs-var">inputQ</span></a></span><span> </span><span class="annot"><span class="annottext">RoleInfo
</span><a href="#local-6989586621679092683"><span class="hs-identifier hs-var">roleInfo</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Input Stream -&gt; STM ()) -&gt; Input Stream -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stream -&gt; InpObj -&gt; Input Stream
forall a. a -&gt; InpObj -&gt; Input a
</span><a href="Network.HTTP2.Arch.Types.html#Input"><span class="hs-identifier hs-var">Input</span></a></span><span> </span><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679092667"><span class="hs-identifier hs-var">strm</span></a></span><span> </span><span class="annot"><span class="annottext">InpObj
</span><a href="#local-6989586621679092653"><span class="hs-identifier hs-var">inpObj</span></a></span><span>
</span><span id="line-189"></span><span>      </span><span class="hs-keyword">else</span><span>
</span><span id="line-190"></span><span>        </span><span class="annot"><span class="annottext">MVar InpObj -&gt; InpObj -&gt; IO ()
forall a. MVar a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">putMVar</span></span><span> </span><span class="annot"><span class="annottext">MVar InpObj
</span><a href="#local-6989586621679092665"><span class="hs-identifier hs-var">streamInput</span></a></span><span> </span><span class="annot"><span class="annottext">InpObj
</span><a href="#local-6989586621679092653"><span class="hs-identifier hs-var">inpObj</span></a></span><span>
</span><span id="line-191"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-192"></span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#processState"><span class="hs-identifier hs-var">processState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.Arch.Types.html#Open"><span class="hs-identifier hs-type">Open</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.Arch.Types.html#HasBody"><span class="hs-identifier hs-type">HasBody</span></a></span><span> </span><span id="local-6989586621679092645"><span class="annot"><span class="annottext">tbl :: (TokenHeaderList, ValueTable)
</span><a href="#local-6989586621679092645"><span class="hs-identifier hs-var">tbl</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="annottext">TokenHeaderList
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span id="local-6989586621679092644"><span class="annot"><span class="annottext">ValueTable
</span><a href="#local-6989586621679092644"><span class="hs-identifier hs-var">reqvt</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621679092643"><span class="annot"><span class="annottext">ctx :: Context
</span><a href="#local-6989586621679092643"><span class="hs-identifier hs-var">ctx</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Network.HTTP2.Arch.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span class="hs-special">{</span><span id="local-6989586621679092626"><span id="local-6989586621679092627"><span id="local-6989586621679092628"><span id="local-6989586621679092629"><span id="local-6989586621679092630"><span id="local-6989586621679092631"><span id="local-6989586621679092632"><span id="local-6989586621679092633"><span id="local-6989586621679092634"><span id="local-6989586621679092635"><span id="local-6989586621679092636"><span id="local-6989586621679092637"><span id="local-6989586621679092638"><span id="local-6989586621679092639"><span id="local-6989586621679092640"><span id="local-6989586621679092641"><span id="local-6989586621679092642"><span class="annot"><span class="annottext">TVar Int
IORef Bool
IORef Int
IORef (Maybe Int)
IORef Settings
TQueue Control
TQueue (Output Stream)
DynamicTable
Rate
StreamTable
RoleInfo
Role
emptyFrameRate :: Rate
settingsRate :: Rate
pingRate :: Rate
connectionWindow :: TVar Int
decodeDynamicTable :: DynamicTable
encodeDynamicTable :: DynamicTable
controlQ :: TQueue Control
outputQ :: TQueue (Output Stream)
peerStreamId :: IORef Int
myStreamId :: IORef Int
continued :: IORef (Maybe Int)
concurrency :: IORef Int
streamTable :: StreamTable
firstSettings :: IORef Bool
http2settings :: IORef Settings
roleInfo :: RoleInfo
role :: Role
emptyFrameRate :: Context -&gt; Rate
settingsRate :: Context -&gt; Rate
pingRate :: Context -&gt; Rate
connectionWindow :: Context -&gt; TVar Int
decodeDynamicTable :: Context -&gt; DynamicTable
encodeDynamicTable :: Context -&gt; DynamicTable
controlQ :: Context -&gt; TQueue Control
outputQ :: Context -&gt; TQueue (Output Stream)
peerStreamId :: Context -&gt; IORef Int
myStreamId :: Context -&gt; IORef Int
continued :: Context -&gt; IORef (Maybe Int)
concurrency :: Context -&gt; IORef Int
streamTable :: Context -&gt; StreamTable
firstSettings :: Context -&gt; IORef Bool
http2settings :: Context -&gt; IORef Settings
roleInfo :: Context -&gt; RoleInfo
role :: Context -&gt; Role
</span><a href="#local-6989586621679092626"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679092625"><span class="annot"><span class="annottext">strm :: Stream
</span><a href="#local-6989586621679092625"><span class="hs-identifier hs-var">strm</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Network.HTTP2.Arch.Types.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span class="hs-special">{</span><span id="local-6989586621679092624"><span class="annot"><span class="annottext">MVar InpObj
streamInput :: MVar InpObj
streamInput :: Stream -&gt; MVar InpObj
</span><a href="#local-6989586621679092624"><span class="hs-identifier hs-var hs-var">streamInput</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679092623"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092623"><span class="hs-identifier hs-var">streamId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-193"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679092622"><span class="annot"><span class="annottext">mcl :: Maybe Int
</span><a href="#local-6989586621679092622"><span class="hs-identifier hs-var hs-var">mcl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Int, ByteString) -&gt; Int
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">((Int, ByteString) -&gt; Int) -&gt; Maybe (Int, ByteString) -&gt; Maybe Int
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Token -&gt; ValueTable -&gt; Maybe ByteString
</span><a href="Network.HPACK.HeaderBlock.Decode.html#getHeaderValue"><span class="hs-identifier hs-var">getHeaderValue</span></a></span><span> </span><span class="annot"><span class="annottext">Token
</span><a href="Network.HPACK.Token.html#tokenContentLength"><span class="hs-identifier hs-var">tokenContentLength</span></a></span><span> </span><span class="annot"><span class="annottext">ValueTable
</span><a href="#local-6989586621679092644"><span class="hs-identifier hs-var">reqvt</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ByteString
-&gt; (ByteString -&gt; Maybe (Int, ByteString))
-&gt; Maybe (Int, ByteString)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Maybe (Int, ByteString)
</span><span class="hs-identifier hs-var">C8.readInt</span></span><span class="hs-special">)</span><span>
</span><span id="line-194"></span><span>    </span><span id="local-6989586621679092621"><span class="annot"><span class="annottext">IORef Int
</span><a href="#local-6989586621679092621"><span class="hs-identifier hs-var">bodyLength</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO (IORef Int)
forall a. a -&gt; IO (IORef a)
</span><span class="hs-identifier hs-var">newIORef</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-195"></span><span>    </span><span id="local-6989586621679092620"><span class="annot"><span class="annottext">IORef (Maybe (TokenHeaderList, ValueTable))
</span><a href="#local-6989586621679092620"><span class="hs-identifier hs-var">tlr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe (TokenHeaderList, ValueTable)
-&gt; IO (IORef (Maybe (TokenHeaderList, ValueTable)))
forall a. a -&gt; IO (IORef a)
</span><span class="hs-identifier hs-var">newIORef</span></span><span> </span><span class="annot"><span class="annottext">Maybe (TokenHeaderList, ValueTable)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-196"></span><span>    </span><span id="local-6989586621679092619"><span class="annot"><span class="annottext">TQueue ByteString
</span><a href="#local-6989586621679092619"><span class="hs-identifier hs-var">q</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (TQueue ByteString)
forall a. IO (TQueue a)
</span><span class="hs-identifier hs-var">newTQueueIO</span></span><span>
</span><span id="line-197"></span><span>    </span><span class="annot"><span class="annottext">Context -&gt; Stream -&gt; StreamState -&gt; IO ()
</span><a href="Network.HTTP2.Arch.Context.html#setStreamState"><span class="hs-identifier hs-var">setStreamState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679092643"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679092625"><span class="hs-identifier hs-var">strm</span></a></span><span> </span><span class="annot"><span class="annottext">(StreamState -&gt; IO ()) -&gt; StreamState -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">OpenState -&gt; StreamState
</span><a href="Network.HTTP2.Arch.Types.html#Open"><span class="hs-identifier hs-var">Open</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TQueue ByteString
-&gt; Maybe Int
-&gt; IORef Int
-&gt; IORef (Maybe (TokenHeaderList, ValueTable))
-&gt; OpenState
</span><a href="Network.HTTP2.Arch.Types.html#Body"><span class="hs-identifier hs-var">Body</span></a></span><span> </span><span class="annot"><span class="annottext">TQueue ByteString
</span><a href="#local-6989586621679092619"><span class="hs-identifier hs-var">q</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621679092622"><span class="hs-identifier hs-var">mcl</span></a></span><span> </span><span class="annot"><span class="annottext">IORef Int
</span><a href="#local-6989586621679092621"><span class="hs-identifier hs-var">bodyLength</span></a></span><span> </span><span class="annot"><span class="annottext">IORef (Maybe (TokenHeaderList, ValueTable))
</span><a href="#local-6989586621679092620"><span class="hs-identifier hs-var">tlr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-198"></span><span>    </span><span id="local-6989586621679092615"><span class="annot"><span class="annottext">Source
</span><a href="#local-6989586621679092615"><span class="hs-identifier hs-var">bodySource</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Int -&gt; IO ()) -&gt; TQueue ByteString -&gt; IO Source
</span><a href="Network.HTTP2.Arch.Receiver.html#mkSource"><span class="hs-identifier hs-var">mkSource</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TQueue Control -&gt; Int -&gt; Int -&gt; IO ()
</span><a href="Network.HTTP2.Arch.Receiver.html#updateWindow"><span class="hs-identifier hs-var">updateWindow</span></a></span><span> </span><span class="annot"><span class="annottext">TQueue Control
</span><a href="#local-6989586621679092632"><span class="hs-identifier hs-var">controlQ</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092623"><span class="hs-identifier hs-var">streamId</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TQueue ByteString
</span><a href="#local-6989586621679092619"><span class="hs-identifier hs-var">q</span></a></span><span>
</span><span id="line-199"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679092612"><span class="annot"><span class="annottext">inpObj :: InpObj
</span><a href="#local-6989586621679092612"><span class="hs-identifier hs-var hs-var">inpObj</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TokenHeaderList, ValueTable)
-&gt; Maybe Int
-&gt; IO ByteString
-&gt; IORef (Maybe (TokenHeaderList, ValueTable))
-&gt; InpObj
</span><a href="Network.HTTP2.Arch.Types.html#InpObj"><span class="hs-identifier hs-var">InpObj</span></a></span><span> </span><span class="annot"><span class="annottext">(TokenHeaderList, ValueTable)
</span><a href="#local-6989586621679092645"><span class="hs-identifier hs-var">tbl</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621679092622"><span class="hs-identifier hs-var">mcl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Source -&gt; IO ByteString
</span><a href="Network.HTTP2.Arch.Receiver.html#readSource"><span class="hs-identifier hs-var">readSource</span></a></span><span> </span><span class="annot"><span class="annottext">Source
</span><a href="#local-6989586621679092615"><span class="hs-identifier hs-var">bodySource</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IORef (Maybe (TokenHeaderList, ValueTable))
</span><a href="#local-6989586621679092620"><span class="hs-identifier hs-var">tlr</span></a></span><span>
</span><span id="line-200"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Context -&gt; Bool
</span><a href="Network.HTTP2.Arch.Context.html#isServer"><span class="hs-identifier hs-var">isServer</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679092643"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="hs-keyword">then</span><span>
</span><span id="line-201"></span><span>        </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TQueue (Input Stream) -&gt; Input Stream -&gt; STM ()
forall a. TQueue a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTQueue</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RoleInfo -&gt; TQueue (Input Stream)
</span><a href="Network.HTTP2.Arch.Context.html#inputQ"><span class="hs-identifier hs-var hs-var">inputQ</span></a></span><span> </span><span class="annot"><span class="annottext">RoleInfo
</span><a href="#local-6989586621679092641"><span class="hs-identifier hs-var">roleInfo</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Input Stream -&gt; STM ()) -&gt; Input Stream -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stream -&gt; InpObj -&gt; Input Stream
forall a. a -&gt; InpObj -&gt; Input a
</span><a href="Network.HTTP2.Arch.Types.html#Input"><span class="hs-identifier hs-var">Input</span></a></span><span> </span><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679092625"><span class="hs-identifier hs-var">strm</span></a></span><span> </span><span class="annot"><span class="annottext">InpObj
</span><a href="#local-6989586621679092612"><span class="hs-identifier hs-var">inpObj</span></a></span><span>
</span><span id="line-202"></span><span>      </span><span class="hs-keyword">else</span><span>
</span><span id="line-203"></span><span>        </span><span class="annot"><span class="annottext">MVar InpObj -&gt; InpObj -&gt; IO ()
forall a. MVar a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">putMVar</span></span><span> </span><span class="annot"><span class="annottext">MVar InpObj
</span><a href="#local-6989586621679092624"><span class="hs-identifier hs-var">streamInput</span></a></span><span> </span><span class="annot"><span class="annottext">InpObj
</span><a href="#local-6989586621679092612"><span class="hs-identifier hs-var">inpObj</span></a></span><span>
</span><span id="line-204"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-205"></span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#processState"><span class="hs-identifier hs-var">processState</span></a></span><span> </span><span id="local-6989586621679092610"><span class="annot"><span class="annottext">s :: StreamState
</span><a href="#local-6989586621679092610"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.Arch.Types.html#Open"><span class="hs-identifier hs-type">Open</span></a></span><span> </span><span class="annot"><a href="Network.HTTP2.Arch.Types.html#Continued"><span class="hs-identifier hs-type">Continued</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621679092608"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679092608"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679092607"><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679092607"><span class="hs-identifier hs-var">strm</span></a></span></span><span> </span><span id="local-6989586621679092606"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092606"><span class="hs-identifier hs-var">_streamId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-206"></span><span>    </span><span class="annot"><span class="annottext">Context -&gt; Stream -&gt; StreamState -&gt; IO ()
</span><a href="Network.HTTP2.Arch.Context.html#setStreamState"><span class="hs-identifier hs-var">setStreamState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679092608"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679092607"><span class="hs-identifier hs-var">strm</span></a></span><span> </span><span class="annot"><span class="annottext">StreamState
</span><a href="#local-6989586621679092610"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-207"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-208"></span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#processState"><span class="hs-identifier hs-var">processState</span></a></span><span> </span><span class="annot"><span class="annottext">StreamState
</span><a href="Network.HTTP2.Arch.Types.html#HalfClosedRemote"><span class="hs-identifier hs-var">HalfClosedRemote</span></a></span><span> </span><span id="local-6989586621679092604"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679092604"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679092603"><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679092603"><span class="hs-identifier hs-var">strm</span></a></span></span><span> </span><span id="local-6989586621679092602"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092602"><span class="hs-identifier hs-var">_streamId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-209"></span><span>    </span><span class="annot"><span class="annottext">Context -&gt; Stream -&gt; IO ()
</span><a href="Network.HTTP2.Arch.Context.html#halfClosedRemote"><span class="hs-identifier hs-var">halfClosedRemote</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679092604"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679092603"><span class="hs-identifier hs-var">strm</span></a></span><span>
</span><span id="line-210"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-211"></span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#processState"><span class="hs-identifier hs-var">processState</span></a></span><span> </span><span id="local-6989586621679092601"><span class="annot"><span class="annottext">StreamState
</span><a href="#local-6989586621679092601"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621679092600"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679092600"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679092599"><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679092599"><span class="hs-identifier hs-var">strm</span></a></span></span><span> </span><span id="local-6989586621679092598"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092598"><span class="hs-identifier hs-var">_streamId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-212"></span><span>    </span><span class="hs-comment">-- Idle, Open Body, Closed</span><span>
</span><span id="line-213"></span><span>    </span><span class="annot"><span class="annottext">Context -&gt; Stream -&gt; StreamState -&gt; IO ()
</span><a href="Network.HTTP2.Arch.Context.html#setStreamState"><span class="hs-identifier hs-var">setStreamState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679092600"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679092599"><span class="hs-identifier hs-var">strm</span></a></span><span> </span><span class="annot"><span class="annottext">StreamState
</span><a href="#local-6989586621679092601"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-214"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-215"></span><span>
</span><span id="line-216"></span><span class="hs-comment">----------------------------------------------------------------</span><span>
</span><span id="line-217"></span><span>
</span><span id="line-218"></span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#getStream"><span class="hs-identifier hs-type">getStream</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP2.Arch.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameTypeId"><span class="hs-identifier hs-type">FrameTypeId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#StreamId"><span class="hs-identifier hs-type">StreamId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Network.HTTP2.Arch.Types.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-219"></span><span id="getStream"><span class="annot"><span class="annottext">getStream :: Context -&gt; FrameTypeId -&gt; Int -&gt; IO (Maybe Stream)
</span><a href="Network.HTTP2.Arch.Receiver.html#getStream"><span class="hs-identifier hs-var hs-var">getStream</span></a></span></span><span> </span><span id="local-6989586621679092597"><span class="annot"><span class="annottext">ctx :: Context
</span><a href="#local-6989586621679092597"><span class="hs-identifier hs-var">ctx</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Network.HTTP2.Arch.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span class="hs-special">{</span><span id="local-6989586621679092580"><span id="local-6989586621679092581"><span id="local-6989586621679092582"><span id="local-6989586621679092583"><span id="local-6989586621679092584"><span id="local-6989586621679092585"><span id="local-6989586621679092586"><span id="local-6989586621679092587"><span id="local-6989586621679092588"><span id="local-6989586621679092589"><span id="local-6989586621679092590"><span id="local-6989586621679092591"><span id="local-6989586621679092592"><span id="local-6989586621679092593"><span id="local-6989586621679092594"><span id="local-6989586621679092595"><span id="local-6989586621679092596"><span class="annot"><span class="annottext">TVar Int
IORef Bool
IORef Int
IORef (Maybe Int)
IORef Settings
TQueue Control
TQueue (Output Stream)
DynamicTable
Rate
StreamTable
RoleInfo
Role
emptyFrameRate :: Rate
settingsRate :: Rate
pingRate :: Rate
connectionWindow :: TVar Int
decodeDynamicTable :: DynamicTable
encodeDynamicTable :: DynamicTable
controlQ :: TQueue Control
outputQ :: TQueue (Output Stream)
peerStreamId :: IORef Int
myStreamId :: IORef Int
continued :: IORef (Maybe Int)
concurrency :: IORef Int
streamTable :: StreamTable
firstSettings :: IORef Bool
http2settings :: IORef Settings
roleInfo :: RoleInfo
role :: Role
emptyFrameRate :: Context -&gt; Rate
settingsRate :: Context -&gt; Rate
pingRate :: Context -&gt; Rate
connectionWindow :: Context -&gt; TVar Int
decodeDynamicTable :: Context -&gt; DynamicTable
encodeDynamicTable :: Context -&gt; DynamicTable
controlQ :: Context -&gt; TQueue Control
outputQ :: Context -&gt; TQueue (Output Stream)
peerStreamId :: Context -&gt; IORef Int
myStreamId :: Context -&gt; IORef Int
continued :: Context -&gt; IORef (Maybe Int)
concurrency :: Context -&gt; IORef Int
streamTable :: Context -&gt; StreamTable
firstSettings :: Context -&gt; IORef Bool
http2settings :: Context -&gt; IORef Settings
roleInfo :: Context -&gt; RoleInfo
role :: Context -&gt; Role
</span><a href="#local-6989586621679092580"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679092579"><span class="annot"><span class="annottext">FrameTypeId
</span><a href="#local-6989586621679092579"><span class="hs-identifier hs-var">ftyp</span></a></span></span><span> </span><span id="local-6989586621679092578"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092578"><span class="hs-identifier hs-var">streamId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-220"></span><span>    </span><span class="annot"><span class="annottext">StreamTable -&gt; Int -&gt; IO (Maybe Stream)
</span><a href="Network.HTTP2.Arch.Stream.html#search"><span class="hs-identifier hs-var">search</span></a></span><span> </span><span class="annot"><span class="annottext">StreamTable
</span><a href="#local-6989586621679092592"><span class="hs-identifier hs-var">streamTable</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092578"><span class="hs-identifier hs-var">streamId</span></a></span><span> </span><span class="annot"><span class="annottext">IO (Maybe Stream)
-&gt; (Maybe Stream -&gt; IO (Maybe Stream)) -&gt; IO (Maybe Stream)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; FrameTypeId -&gt; Int -&gt; Maybe Stream -&gt; IO (Maybe Stream)
</span><a href="Network.HTTP2.Arch.Receiver.html#getStream%27"><span class="hs-identifier hs-var">getStream'</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679092597"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">FrameTypeId
</span><a href="#local-6989586621679092579"><span class="hs-identifier hs-var">ftyp</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092578"><span class="hs-identifier hs-var">streamId</span></a></span><span>
</span><span id="line-221"></span><span>
</span><span id="line-222"></span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#getStream%27"><span class="hs-identifier hs-type">getStream'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP2.Arch.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameTypeId"><span class="hs-identifier hs-type">FrameTypeId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#StreamId"><span class="hs-identifier hs-type">StreamId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Network.HTTP2.Arch.Types.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Network.HTTP2.Arch.Types.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-223"></span><span id="getStream%27"><span class="annot"><span class="annottext">getStream' :: Context -&gt; FrameTypeId -&gt; Int -&gt; Maybe Stream -&gt; IO (Maybe Stream)
</span><a href="Network.HTTP2.Arch.Receiver.html#getStream%27"><span class="hs-identifier hs-var hs-var">getStream'</span></a></span></span><span> </span><span id="local-6989586621679092575"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679092575"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679092574"><span class="annot"><span class="annottext">FrameTypeId
</span><a href="#local-6989586621679092574"><span class="hs-identifier hs-var">ftyp</span></a></span></span><span> </span><span id="local-6989586621679092573"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092573"><span class="hs-identifier hs-var">_streamId</span></a></span></span><span> </span><span id="local-6989586621679092572"><span class="annot"><span class="annottext">js :: Maybe Stream
</span><a href="#local-6989586621679092572"><span class="hs-identifier hs-var">js</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679092571"><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679092571"><span class="hs-identifier hs-var">strm0</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-224"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FrameTypeId
</span><a href="#local-6989586621679092574"><span class="hs-identifier hs-var">ftyp</span></a></span><span> </span><span class="annot"><span class="annottext">FrameTypeId -&gt; FrameTypeId -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">FrameTypeId
</span><a href="Network.HTTP2.Frame.Types.html#FrameHeaders"><span class="hs-identifier hs-var">FrameHeaders</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-225"></span><span>        </span><span id="local-6989586621679092569"><span class="annot"><span class="annottext">StreamState
</span><a href="#local-6989586621679092569"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Stream -&gt; IO StreamState
</span><a href="Network.HTTP2.Arch.Stream.html#readStreamState"><span class="hs-identifier hs-var">readStreamState</span></a></span><span> </span><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679092571"><span class="hs-identifier hs-var">strm0</span></a></span><span>
</span><span id="line-226"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StreamState -&gt; Bool
</span><a href="Network.HTTP2.Arch.Stream.html#isHalfClosedRemote"><span class="hs-identifier hs-var">isHalfClosedRemote</span></a></span><span> </span><span class="annot"><span class="annottext">StreamState
</span><a href="#local-6989586621679092569"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO ()
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO ()) -&gt; HTTP2Error -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId -&gt; ByteString -&gt; HTTP2Error
</span><a href="Network.HTTP2.Frame.Types.html#ConnectionError"><span class="hs-identifier hs-var">ConnectionError</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId
</span><a href="Network.HTTP2.Frame.Types.html#StreamClosed"><span class="hs-identifier hs-var">StreamClosed</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;header must not be sent to half or fully closed stream&quot;</span></span><span>
</span><span id="line-227"></span><span>        </span><span class="hs-comment">-- Priority made an idle stream</span><span>
</span><span id="line-228"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StreamState -&gt; Bool
</span><a href="Network.HTTP2.Arch.Stream.html#isIdle"><span class="hs-identifier hs-var">isIdle</span></a></span><span> </span><span class="annot"><span class="annottext">StreamState
</span><a href="#local-6989586621679092569"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; Stream -&gt; IO ()
</span><a href="Network.HTTP2.Arch.Context.html#opened"><span class="hs-identifier hs-var">opened</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679092575"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679092571"><span class="hs-identifier hs-var">strm0</span></a></span><span>
</span><span id="line-229"></span><span>    </span><span class="annot"><span class="annottext">Maybe Stream -&gt; IO (Maybe Stream)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe Stream
</span><a href="#local-6989586621679092572"><span class="hs-identifier hs-var">js</span></a></span><span>
</span><span id="line-230"></span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#getStream%27"><span class="hs-identifier hs-var">getStream'</span></a></span><span> </span><span id="local-6989586621679092564"><span class="annot"><span class="annottext">ctx :: Context
</span><a href="#local-6989586621679092564"><span class="hs-identifier hs-var">ctx</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Network.HTTP2.Arch.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span class="hs-special">{</span><span id="local-6989586621679092547"><span id="local-6989586621679092548"><span id="local-6989586621679092549"><span id="local-6989586621679092550"><span id="local-6989586621679092551"><span id="local-6989586621679092552"><span id="local-6989586621679092553"><span id="local-6989586621679092554"><span id="local-6989586621679092555"><span id="local-6989586621679092556"><span id="local-6989586621679092557"><span id="local-6989586621679092558"><span id="local-6989586621679092559"><span id="local-6989586621679092560"><span id="local-6989586621679092561"><span id="local-6989586621679092562"><span id="local-6989586621679092563"><span class="annot"><span class="annottext">TVar Int
IORef Bool
IORef Int
IORef (Maybe Int)
IORef Settings
TQueue Control
TQueue (Output Stream)
DynamicTable
Rate
StreamTable
RoleInfo
Role
emptyFrameRate :: Rate
settingsRate :: Rate
pingRate :: Rate
connectionWindow :: TVar Int
decodeDynamicTable :: DynamicTable
encodeDynamicTable :: DynamicTable
controlQ :: TQueue Control
outputQ :: TQueue (Output Stream)
peerStreamId :: IORef Int
myStreamId :: IORef Int
continued :: IORef (Maybe Int)
concurrency :: IORef Int
streamTable :: StreamTable
firstSettings :: IORef Bool
http2settings :: IORef Settings
roleInfo :: RoleInfo
role :: Role
emptyFrameRate :: Context -&gt; Rate
settingsRate :: Context -&gt; Rate
pingRate :: Context -&gt; Rate
connectionWindow :: Context -&gt; TVar Int
decodeDynamicTable :: Context -&gt; DynamicTable
encodeDynamicTable :: Context -&gt; DynamicTable
controlQ :: Context -&gt; TQueue Control
outputQ :: Context -&gt; TQueue (Output Stream)
peerStreamId :: Context -&gt; IORef Int
myStreamId :: Context -&gt; IORef Int
continued :: Context -&gt; IORef (Maybe Int)
concurrency :: Context -&gt; IORef Int
streamTable :: Context -&gt; StreamTable
firstSettings :: Context -&gt; IORef Bool
http2settings :: Context -&gt; IORef Settings
roleInfo :: Context -&gt; RoleInfo
role :: Context -&gt; Role
</span><a href="#local-6989586621679092547"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679092546"><span class="annot"><span class="annottext">FrameTypeId
</span><a href="#local-6989586621679092546"><span class="hs-identifier hs-var">ftyp</span></a></span></span><span> </span><span id="local-6989586621679092545"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092545"><span class="hs-identifier hs-var">streamId</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe Stream
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-231"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Bool
</span><a href="Network.HTTP2.Frame.Types.html#isServerInitiated"><span class="hs-identifier hs-var">isServerInitiated</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092545"><span class="hs-identifier hs-var">streamId</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Stream -&gt; IO (Maybe Stream)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe Stream
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-232"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Context -&gt; Bool
</span><a href="Network.HTTP2.Arch.Context.html#isServer"><span class="hs-identifier hs-var">isServer</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679092564"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-233"></span><span>        </span><span id="local-6989586621679092544"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092544"><span class="hs-identifier hs-var">csid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO Int
</span><a href="Network.HTTP2.Arch.Context.html#getPeerStreamID"><span class="hs-identifier hs-var">getPeerStreamID</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679092564"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-234"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092545"><span class="hs-identifier hs-var">streamId</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092544"><span class="hs-identifier hs-var">csid</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-comment">-- consider the stream closed</span><span>
</span><span id="line-235"></span><span>          </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">FrameTypeId
</span><a href="#local-6989586621679092546"><span class="hs-identifier hs-var">ftyp</span></a></span><span> </span><span class="annot"><span class="annottext">FrameTypeId -&gt; [FrameTypeId] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">FrameTypeId
</span><a href="Network.HTTP2.Frame.Types.html#FrameWindowUpdate"><span class="hs-identifier hs-var">FrameWindowUpdate</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FrameTypeId
</span><a href="Network.HTTP2.Frame.Types.html#FrameRSTStream"><span class="hs-identifier hs-var">FrameRSTStream</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FrameTypeId
</span><a href="Network.HTTP2.Frame.Types.html#FramePriority"><span class="hs-identifier hs-var">FramePriority</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-keyword">then</span><span>
</span><span id="line-236"></span><span>              </span><span class="annot"><span class="annottext">Maybe Stream -&gt; IO (Maybe Stream)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe Stream
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-comment">-- will be ignored</span><span>
</span><span id="line-237"></span><span>            </span><span class="hs-keyword">else</span><span>
</span><span id="line-238"></span><span>              </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO (Maybe Stream)
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO (Maybe Stream))
-&gt; HTTP2Error -&gt; IO (Maybe Stream)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId -&gt; ByteString -&gt; HTTP2Error
</span><a href="Network.HTTP2.Frame.Types.html#ConnectionError"><span class="hs-identifier hs-var">ConnectionError</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId
</span><a href="Network.HTTP2.Frame.Types.html#ProtocolError"><span class="hs-identifier hs-var">ProtocolError</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;stream identifier must not decrease&quot;</span></span><span>
</span><span id="line-239"></span><span>          </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- consider the stream idle</span><span>
</span><span id="line-240"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FrameTypeId
</span><a href="#local-6989586621679092546"><span class="hs-identifier hs-var">ftyp</span></a></span><span> </span><span class="annot"><span class="annottext">FrameTypeId -&gt; [FrameTypeId] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`notElem`</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">FrameTypeId
</span><a href="Network.HTTP2.Frame.Types.html#FrameHeaders"><span class="hs-identifier hs-var">FrameHeaders</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">FrameTypeId
</span><a href="Network.HTTP2.Frame.Types.html#FramePriority"><span class="hs-identifier hs-var">FramePriority</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-241"></span><span>                </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO ()
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO ()) -&gt; HTTP2Error -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId -&gt; ByteString -&gt; HTTP2Error
</span><a href="Network.HTTP2.Frame.Types.html#ConnectionError"><span class="hs-identifier hs-var">ConnectionError</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId
</span><a href="Network.HTTP2.Frame.Types.html#ProtocolError"><span class="hs-identifier hs-var">ProtocolError</span></a></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; HTTP2Error) -&gt; ByteString -&gt; HTTP2Error
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;this frame is not allowed in an idle stream: &quot;</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString -&gt; ByteString
</span><span class="hs-operator hs-var">`BS.append`</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ByteString
</span><span class="hs-identifier hs-var">C8.pack</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FrameTypeId -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">FrameTypeId
</span><a href="#local-6989586621679092546"><span class="hs-identifier hs-var">ftyp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-242"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FrameTypeId
</span><a href="#local-6989586621679092546"><span class="hs-identifier hs-var">ftyp</span></a></span><span> </span><span class="annot"><span class="annottext">FrameTypeId -&gt; FrameTypeId -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">FrameTypeId
</span><a href="Network.HTTP2.Frame.Types.html#FrameHeaders"><span class="hs-identifier hs-var">FrameHeaders</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-243"></span><span>                </span><span class="annot"><span class="annottext">Context -&gt; Int -&gt; IO ()
</span><a href="Network.HTTP2.Arch.Context.html#setPeerStreamID"><span class="hs-identifier hs-var">setPeerStreamID</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679092564"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092545"><span class="hs-identifier hs-var">streamId</span></a></span><span>
</span><span id="line-244"></span><span>                </span><span id="local-6989586621679092537"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092537"><span class="hs-identifier hs-var">cnt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef Int -&gt; IO Int
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef Int
</span><a href="#local-6989586621679092558"><span class="hs-identifier hs-var">concurrency</span></a></span><span>
</span><span id="line-245"></span><span>                </span><span class="hs-comment">-- Checking the limitation of concurrency</span><span>
</span><span id="line-246"></span><span>                </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092537"><span class="hs-identifier hs-var">cnt</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="Network.HTTP2.Arch.Receiver.html#maxConcurrency"><span class="hs-identifier hs-var">maxConcurrency</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO ()
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO ()) -&gt; HTTP2Error -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId -&gt; Int -&gt; HTTP2Error
</span><a href="Network.HTTP2.Frame.Types.html#StreamError"><span class="hs-identifier hs-var">StreamError</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId
</span><a href="Network.HTTP2.Frame.Types.html#RefusedStream"><span class="hs-identifier hs-var">RefusedStream</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092545"><span class="hs-identifier hs-var">streamId</span></a></span><span>
</span><span id="line-247"></span><span>            </span><span class="annot"><span class="annottext">Stream -&gt; Maybe Stream
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Stream -&gt; Maybe Stream) -&gt; IO Stream -&gt; IO (Maybe Stream)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; Int -&gt; FrameTypeId -&gt; IO Stream
</span><a href="Network.HTTP2.Arch.Context.html#openStream"><span class="hs-identifier hs-var">openStream</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679092564"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092545"><span class="hs-identifier hs-var">streamId</span></a></span><span> </span><span class="annot"><span class="annottext">FrameTypeId
</span><a href="#local-6989586621679092546"><span class="hs-identifier hs-var">ftyp</span></a></span><span>
</span><span id="line-248"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO (Maybe Stream)
forall a. HasCallStack =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-comment">-- never reach</span><span>
</span><span id="line-249"></span><span>
</span><span id="line-250"></span><span class="hs-comment">----------------------------------------------------------------</span><span>
</span><span id="line-251"></span><span>
</span><span id="line-252"></span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#control"><span class="hs-identifier hs-type">control</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameTypeId"><span class="hs-identifier hs-type">FrameTypeId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameHeader"><span class="hs-identifier hs-type">FrameHeader</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.Arch.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-253"></span><span id="control"><span class="annot"><span class="annottext">control :: FrameTypeId -&gt; FrameHeader -&gt; ByteString -&gt; Context -&gt; IO Bool
</span><a href="Network.HTTP2.Arch.Receiver.html#control"><span class="hs-identifier hs-var hs-var">control</span></a></span></span><span> </span><span class="annot"><span class="annottext">FrameTypeId
</span><a href="Network.HTTP2.Frame.Types.html#FrameSettings"><span class="hs-identifier hs-var">FrameSettings</span></a></span><span> </span><span id="local-6989586621679092533"><span class="annot"><span class="annottext">header :: FrameHeader
</span><a href="#local-6989586621679092533"><span class="hs-identifier hs-var">header</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameHeader"><span class="hs-identifier hs-type">FrameHeader</span></a></span><span class="hs-special">{</span><span id="local-6989586621679092532"><span class="annot"><span class="annottext">FrameFlags
flags :: FrameHeader -&gt; FrameFlags
flags :: FrameFlags
</span><a href="Network.HTTP2.Frame.Types.html#flags"><span class="hs-identifier hs-var hs-var">flags</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679092530"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092530"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="annot"><a href="Network.HTTP2.Arch.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span class="hs-special">{</span><span id="local-6989586621679092529"><span class="annot"><span class="annottext">IORef Settings
http2settings :: IORef Settings
http2settings :: Context -&gt; IORef Settings
</span><a href="#local-6989586621679092529"><span class="hs-identifier hs-var hs-var">http2settings</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679092528"><span class="annot"><span class="annottext">TQueue Control
controlQ :: TQueue Control
controlQ :: Context -&gt; TQueue Control
</span><a href="#local-6989586621679092528"><span class="hs-identifier hs-var hs-var">controlQ</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679092527"><span class="annot"><span class="annottext">IORef Bool
firstSettings :: IORef Bool
firstSettings :: Context -&gt; IORef Bool
</span><a href="#local-6989586621679092527"><span class="hs-identifier hs-var hs-var">firstSettings</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679092526"><span class="annot"><span class="annottext">StreamTable
streamTable :: StreamTable
streamTable :: Context -&gt; StreamTable
</span><a href="#local-6989586621679092526"><span class="hs-identifier hs-var hs-var">streamTable</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679092525"><span class="annot"><span class="annottext">Rate
settingsRate :: Rate
settingsRate :: Context -&gt; Rate
</span><a href="#local-6989586621679092525"><span class="hs-identifier hs-var hs-var">settingsRate</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-254"></span><span>    </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#SettingsFrame"><span class="hs-identifier hs-type">SettingsFrame</span></a></span><span> </span><span id="local-6989586621679092523"><span class="annot"><span class="annottext">SettingsList
</span><a href="#local-6989586621679092523"><span class="hs-identifier hs-var">alist</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Either HTTP2Error FramePayload -&gt; IO FramePayload
forall a. Either HTTP2Error a -&gt; IO a
</span><a href="Network.HTTP2.Arch.Receiver.html#guardIt"><span class="hs-identifier hs-var">guardIt</span></a></span><span> </span><span class="annot"><span class="annottext">(Either HTTP2Error FramePayload -&gt; IO FramePayload)
-&gt; Either HTTP2Error FramePayload -&gt; IO FramePayload
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FramePayloadDecoder
</span><a href="Network.HTTP2.Frame.Decode.html#decodeSettingsFrame"><span class="hs-identifier hs-var">decodeSettingsFrame</span></a></span><span> </span><span class="annot"><span class="annottext">FrameHeader
</span><a href="#local-6989586621679092533"><span class="hs-identifier hs-var">header</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092530"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-255"></span><span>    </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO Any) -&gt; Maybe HTTP2Error -&gt; IO ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><span class="hs-identifier hs-var">traverse_</span></span><span> </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO Any
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(Maybe HTTP2Error -&gt; IO ()) -&gt; Maybe HTTP2Error -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SettingsList -&gt; Maybe HTTP2Error
</span><a href="Network.HTTP2.Frame.Types.html#checkSettingsList"><span class="hs-identifier hs-var">checkSettingsList</span></a></span><span> </span><span class="annot"><span class="annottext">SettingsList
</span><a href="#local-6989586621679092523"><span class="hs-identifier hs-var">alist</span></a></span><span>
</span><span id="line-256"></span><span>    </span><span class="hs-comment">-- HTTP/2 Setting from a browser</span><span>
</span><span id="line-257"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">FrameFlags -&gt; Bool
</span><a href="Network.HTTP2.Frame.Types.html#testAck"><span class="hs-identifier hs-var">testAck</span></a></span><span> </span><span class="annot"><span class="annottext">FrameFlags
</span><a href="#local-6989586621679092532"><span class="hs-identifier hs-var">flags</span></a></span><span> </span><span class="hs-keyword">then</span><span>
</span><span id="line-258"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; IO Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-259"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-260"></span><span>        </span><span class="hs-comment">-- Settings Flood - CVE-2019-9515</span><span>
</span><span id="line-261"></span><span>        </span><span id="local-6989586621679092518"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092518"><span class="hs-identifier hs-var">rate</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Rate -&gt; IO Int
</span><a href="Network.HTTP2.Arch.Rate.html#getRate"><span class="hs-identifier hs-var">getRate</span></a></span><span> </span><span class="annot"><span class="annottext">Rate
</span><a href="#local-6989586621679092525"><span class="hs-identifier hs-var">settingsRate</span></a></span><span>
</span><span id="line-262"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092518"><span class="hs-identifier hs-var">rate</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="Network.HTTP2.Arch.Receiver.html#settingsRateLimit"><span class="hs-identifier hs-var">settingsRateLimit</span></a></span><span> </span><span class="hs-keyword">then</span><span>
</span><span id="line-263"></span><span>            </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO Bool
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO Bool) -&gt; HTTP2Error -&gt; IO Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId -&gt; ByteString -&gt; HTTP2Error
</span><a href="Network.HTTP2.Frame.Types.html#ConnectionError"><span class="hs-identifier hs-var">ConnectionError</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId
</span><a href="Network.HTTP2.Frame.Types.html#ProtocolError"><span class="hs-identifier hs-var">ProtocolError</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;too many settings&quot;</span></span><span>
</span><span id="line-264"></span><span>          </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-265"></span><span>            </span><span id="local-6989586621679092515"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092515"><span class="hs-identifier hs-var">oldws</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Settings -&gt; Int
</span><a href="Network.HTTP2.Frame.Types.html#initialWindowSize"><span class="hs-identifier hs-var hs-var">initialWindowSize</span></a></span><span> </span><span class="annot"><span class="annottext">(Settings -&gt; Int) -&gt; IO Settings -&gt; IO Int
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">IORef Settings -&gt; IO Settings
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef Settings
</span><a href="#local-6989586621679092529"><span class="hs-identifier hs-var">http2settings</span></a></span><span>
</span><span id="line-266"></span><span>            </span><span class="annot"><span class="annottext">IORef Settings -&gt; (Settings -&gt; Settings) -&gt; IO ()
forall a. IORef a -&gt; (a -&gt; a) -&gt; IO ()
</span><span class="hs-identifier hs-var">modifyIORef'</span></span><span> </span><span class="annot"><span class="annottext">IORef Settings
</span><a href="#local-6989586621679092529"><span class="hs-identifier hs-var">http2settings</span></a></span><span> </span><span class="annot"><span class="annottext">((Settings -&gt; Settings) -&gt; IO ())
-&gt; (Settings -&gt; Settings) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679092512"><span class="annot"><span class="annottext">Settings
</span><a href="#local-6989586621679092512"><span class="hs-identifier hs-var">old</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Settings -&gt; SettingsList -&gt; Settings
</span><a href="Network.HTTP2.Frame.Types.html#updateSettings"><span class="hs-identifier hs-var">updateSettings</span></a></span><span> </span><span class="annot"><span class="annottext">Settings
</span><a href="#local-6989586621679092512"><span class="hs-identifier hs-var">old</span></a></span><span> </span><span class="annot"><span class="annottext">SettingsList
</span><a href="#local-6989586621679092523"><span class="hs-identifier hs-var">alist</span></a></span><span>
</span><span id="line-267"></span><span>            </span><span id="local-6989586621679092510"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092510"><span class="hs-identifier hs-var">newws</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Settings -&gt; Int
</span><a href="Network.HTTP2.Frame.Types.html#initialWindowSize"><span class="hs-identifier hs-var hs-var">initialWindowSize</span></a></span><span> </span><span class="annot"><span class="annottext">(Settings -&gt; Int) -&gt; IO Settings -&gt; IO Int
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">IORef Settings -&gt; IO Settings
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef Settings
</span><a href="#local-6989586621679092529"><span class="hs-identifier hs-var">http2settings</span></a></span><span>
</span><span id="line-268"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679092509"><span class="annot"><span class="annottext">diff :: Int
</span><a href="#local-6989586621679092509"><span class="hs-identifier hs-var hs-var">diff</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092510"><span class="hs-identifier hs-var">newws</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092515"><span class="hs-identifier hs-var">oldws</span></a></span><span>
</span><span id="line-269"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092509"><span class="hs-identifier hs-var">diff</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Int) -&gt; StreamTable -&gt; IO ()
</span><a href="Network.HTTP2.Arch.Stream.html#updateAllStreamWindow"><span class="hs-identifier hs-var">updateAllStreamWindow</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092509"><span class="hs-identifier hs-var">diff</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">StreamTable
</span><a href="#local-6989586621679092526"><span class="hs-identifier hs-var">streamTable</span></a></span><span>
</span><span id="line-270"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679092507"><span class="annot"><span class="annottext">frame :: ByteString
</span><a href="#local-6989586621679092507"><span class="hs-identifier hs-var hs-var">frame</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(FrameFlags -&gt; FrameFlags) -&gt; SettingsList -&gt; ByteString
</span><a href="Network.HTTP2.Arch.EncodeFrame.html#settingsFrame"><span class="hs-identifier hs-var">settingsFrame</span></a></span><span> </span><span class="annot"><span class="annottext">FrameFlags -&gt; FrameFlags
</span><a href="Network.HTTP2.Frame.Types.html#setAck"><span class="hs-identifier hs-var">setAck</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-271"></span><span>            </span><span id="local-6989586621679092505"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679092505"><span class="hs-identifier hs-var">sent</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef Bool -&gt; IO Bool
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef Bool
</span><a href="#local-6989586621679092527"><span class="hs-identifier hs-var">firstSettings</span></a></span><span>
</span><span id="line-272"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679092504"><span class="annot"><span class="annottext">setframe :: Control
</span><a href="#local-6989586621679092504"><span class="hs-identifier hs-var hs-var">setframe</span></a></span></span><span>
</span><span id="line-273"></span><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679092505"><span class="hs-identifier hs-var">sent</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; SettingsList -&gt; Control
</span><a href="Network.HTTP2.Arch.Types.html#CSettings"><span class="hs-identifier hs-var">CSettings</span></a></span><span>               </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092507"><span class="hs-identifier hs-var">frame</span></a></span><span> </span><span class="annot"><span class="annottext">SettingsList
</span><a href="#local-6989586621679092523"><span class="hs-identifier hs-var">alist</span></a></span><span>
</span><span id="line-274"></span><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString -&gt; SettingsList -&gt; Control
</span><a href="Network.HTTP2.Arch.Types.html#CSettings0"><span class="hs-identifier hs-var">CSettings0</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="Network.HTTP2.Arch.Receiver.html#initialFrame"><span class="hs-identifier hs-var">initialFrame</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092507"><span class="hs-identifier hs-var">frame</span></a></span><span> </span><span class="annot"><span class="annottext">SettingsList
</span><a href="#local-6989586621679092523"><span class="hs-identifier hs-var">alist</span></a></span><span>
</span><span id="line-275"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679092505"><span class="hs-identifier hs-var">sent</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IORef Bool -&gt; Bool -&gt; IO ()
forall a. IORef a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">writeIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef Bool
</span><a href="#local-6989586621679092527"><span class="hs-identifier hs-var">firstSettings</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-276"></span><span>            </span><span class="annot"><span class="annottext">TQueue Control -&gt; Control -&gt; IO ()
</span><a href="Network.HTTP2.Arch.Queue.html#enqueueControl"><span class="hs-identifier hs-var">enqueueControl</span></a></span><span> </span><span class="annot"><span class="annottext">TQueue Control
</span><a href="#local-6989586621679092528"><span class="hs-identifier hs-var">controlQ</span></a></span><span> </span><span class="annot"><span class="annottext">Control
</span><a href="#local-6989586621679092504"><span class="hs-identifier hs-var">setframe</span></a></span><span>
</span><span id="line-277"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; IO Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-278"></span><span>
</span><span id="line-279"></span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#control"><span class="hs-identifier hs-var">control</span></a></span><span> </span><span class="annot"><span class="annottext">FrameTypeId
</span><a href="Network.HTTP2.Frame.Types.html#FramePing"><span class="hs-identifier hs-var">FramePing</span></a></span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameHeader"><span class="hs-identifier hs-type">FrameHeader</span></a></span><span class="hs-special">{</span><span id="local-6989586621679092500"><span class="annot"><span class="annottext">FrameFlags
flags :: FrameFlags
flags :: FrameHeader -&gt; FrameFlags
</span><a href="#local-6989586621679092500"><span class="hs-identifier hs-var hs-var">flags</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679092499"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092499"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="annot"><a href="Network.HTTP2.Arch.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span class="hs-special">{</span><span id="local-6989586621679092498"><span class="annot"><span class="annottext">TQueue Control
controlQ :: TQueue Control
controlQ :: Context -&gt; TQueue Control
</span><a href="#local-6989586621679092498"><span class="hs-identifier hs-var hs-var">controlQ</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679092497"><span class="annot"><span class="annottext">Rate
pingRate :: Rate
pingRate :: Context -&gt; Rate
</span><a href="#local-6989586621679092497"><span class="hs-identifier hs-var hs-var">pingRate</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-280"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">FrameFlags -&gt; Bool
</span><a href="Network.HTTP2.Frame.Types.html#testAck"><span class="hs-identifier hs-var">testAck</span></a></span><span> </span><span class="annot"><span class="annottext">FrameFlags
</span><a href="#local-6989586621679092500"><span class="hs-identifier hs-var">flags</span></a></span><span> </span><span class="hs-keyword">then</span><span>
</span><span id="line-281"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; IO Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-282"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-283"></span><span>        </span><span class="hs-comment">-- Ping Flood - CVE-2019-9512</span><span>
</span><span id="line-284"></span><span>        </span><span id="local-6989586621679092496"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092496"><span class="hs-identifier hs-var">rate</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Rate -&gt; IO Int
</span><a href="Network.HTTP2.Arch.Rate.html#getRate"><span class="hs-identifier hs-var">getRate</span></a></span><span> </span><span class="annot"><span class="annottext">Rate
</span><a href="#local-6989586621679092497"><span class="hs-identifier hs-var">pingRate</span></a></span><span>
</span><span id="line-285"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092496"><span class="hs-identifier hs-var">rate</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="Network.HTTP2.Arch.Receiver.html#pingRateLimit"><span class="hs-identifier hs-var">pingRateLimit</span></a></span><span> </span><span class="hs-keyword">then</span><span>
</span><span id="line-286"></span><span>            </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO Bool
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO Bool) -&gt; HTTP2Error -&gt; IO Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId -&gt; ByteString -&gt; HTTP2Error
</span><a href="Network.HTTP2.Frame.Types.html#ConnectionError"><span class="hs-identifier hs-var">ConnectionError</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId
</span><a href="Network.HTTP2.Frame.Types.html#ProtocolError"><span class="hs-identifier hs-var">ProtocolError</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;too many ping&quot;</span></span><span>
</span><span id="line-287"></span><span>          </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-288"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679092495"><span class="annot"><span class="annottext">frame :: ByteString
</span><a href="#local-6989586621679092495"><span class="hs-identifier hs-var hs-var">frame</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString
</span><a href="Network.HTTP2.Arch.EncodeFrame.html#pingFrame"><span class="hs-identifier hs-var">pingFrame</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092499"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-289"></span><span>            </span><span class="annot"><span class="annottext">TQueue Control -&gt; Control -&gt; IO ()
</span><a href="Network.HTTP2.Arch.Queue.html#enqueueControl"><span class="hs-identifier hs-var">enqueueControl</span></a></span><span> </span><span class="annot"><span class="annottext">TQueue Control
</span><a href="#local-6989586621679092498"><span class="hs-identifier hs-var">controlQ</span></a></span><span> </span><span class="annot"><span class="annottext">(Control -&gt; IO ()) -&gt; Control -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Control
</span><a href="Network.HTTP2.Arch.Types.html#CFrame"><span class="hs-identifier hs-var">CFrame</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092495"><span class="hs-identifier hs-var">frame</span></a></span><span>
</span><span id="line-290"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; IO Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-291"></span><span>
</span><span id="line-292"></span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#control"><span class="hs-identifier hs-var">control</span></a></span><span> </span><span class="annot"><span class="annottext">FrameTypeId
</span><a href="Network.HTTP2.Frame.Types.html#FrameGoAway"><span class="hs-identifier hs-var">FrameGoAway</span></a></span><span> </span><span class="annot"><span class="annottext">FrameHeader
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="Network.HTTP2.Arch.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span class="hs-special">{</span><span id="local-6989586621679092492"><span class="annot"><span class="annottext">TQueue Control
controlQ :: TQueue Control
controlQ :: Context -&gt; TQueue Control
</span><a href="#local-6989586621679092492"><span class="hs-identifier hs-var hs-var">controlQ</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-293"></span><span>    </span><span class="annot"><span class="annottext">TQueue Control -&gt; Control -&gt; IO ()
</span><a href="Network.HTTP2.Arch.Queue.html#enqueueControl"><span class="hs-identifier hs-var">enqueueControl</span></a></span><span> </span><span class="annot"><span class="annottext">TQueue Control
</span><a href="#local-6989586621679092492"><span class="hs-identifier hs-var">controlQ</span></a></span><span> </span><span class="annot"><span class="annottext">Control
</span><a href="Network.HTTP2.Arch.Types.html#CFinish"><span class="hs-identifier hs-var">CFinish</span></a></span><span>
</span><span id="line-294"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-295"></span><span>
</span><span id="line-296"></span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#control"><span class="hs-identifier hs-var">control</span></a></span><span> </span><span class="annot"><span class="annottext">FrameTypeId
</span><a href="Network.HTTP2.Frame.Types.html#FrameWindowUpdate"><span class="hs-identifier hs-var">FrameWindowUpdate</span></a></span><span> </span><span id="local-6989586621679092491"><span class="annot"><span class="annottext">FrameHeader
</span><a href="#local-6989586621679092491"><span class="hs-identifier hs-var">header</span></a></span></span><span> </span><span id="local-6989586621679092490"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092490"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="annot"><a href="Network.HTTP2.Arch.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span class="hs-special">{</span><span id="local-6989586621679092489"><span class="annot"><span class="annottext">TVar Int
connectionWindow :: TVar Int
connectionWindow :: Context -&gt; TVar Int
</span><a href="#local-6989586621679092489"><span class="hs-identifier hs-var hs-var">connectionWindow</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-297"></span><span>    </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#WindowUpdateFrame"><span class="hs-identifier hs-type">WindowUpdateFrame</span></a></span><span> </span><span id="local-6989586621679092487"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092487"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Either HTTP2Error FramePayload -&gt; IO FramePayload
forall a. Either HTTP2Error a -&gt; IO a
</span><a href="Network.HTTP2.Arch.Receiver.html#guardIt"><span class="hs-identifier hs-var">guardIt</span></a></span><span> </span><span class="annot"><span class="annottext">(Either HTTP2Error FramePayload -&gt; IO FramePayload)
-&gt; Either HTTP2Error FramePayload -&gt; IO FramePayload
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FramePayloadDecoder
</span><a href="Network.HTTP2.Frame.Decode.html#decodeWindowUpdateFrame"><span class="hs-identifier hs-var">decodeWindowUpdateFrame</span></a></span><span> </span><span class="annot"><span class="annottext">FrameHeader
</span><a href="#local-6989586621679092491"><span class="hs-identifier hs-var">header</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092490"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-298"></span><span>    </span><span id="local-6989586621679092485"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092485"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM Int -&gt; IO Int
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM Int -&gt; IO Int) -&gt; STM Int -&gt; IO Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-299"></span><span>      </span><span id="local-6989586621679092484"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092484"><span class="hs-identifier hs-var">w0</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar Int -&gt; STM Int
forall a. TVar a -&gt; STM a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar Int
</span><a href="#local-6989586621679092489"><span class="hs-identifier hs-var">connectionWindow</span></a></span><span>
</span><span id="line-300"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679092482"><span class="annot"><span class="annottext">w1 :: Int
</span><a href="#local-6989586621679092482"><span class="hs-identifier hs-var hs-var">w1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092484"><span class="hs-identifier hs-var">w0</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092487"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-301"></span><span>      </span><span class="annot"><span class="annottext">TVar Int -&gt; Int -&gt; STM ()
forall a. TVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar Int
</span><a href="#local-6989586621679092489"><span class="hs-identifier hs-var">connectionWindow</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092482"><span class="hs-identifier hs-var">w1</span></a></span><span>
</span><span id="line-302"></span><span>      </span><span class="annot"><span class="annottext">Int -&gt; STM Int
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092482"><span class="hs-identifier hs-var">w1</span></a></span><span>
</span><span id="line-303"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Bool
</span><a href="Network.HTTP2.Frame.Types.html#isWindowOverflow"><span class="hs-identifier hs-var">isWindowOverflow</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092485"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO ()
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO ()) -&gt; HTTP2Error -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId -&gt; ByteString -&gt; HTTP2Error
</span><a href="Network.HTTP2.Frame.Types.html#ConnectionError"><span class="hs-identifier hs-var">ConnectionError</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId
</span><a href="Network.HTTP2.Frame.Types.html#FlowControlError"><span class="hs-identifier hs-var">FlowControlError</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;control window should be less than 2^31&quot;</span></span><span>
</span><span id="line-304"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-305"></span><span>
</span><span id="line-306"></span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#control"><span class="hs-identifier hs-var">control</span></a></span><span> </span><span class="annot"><span class="annottext">FrameTypeId
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">FrameHeader
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Context
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-307"></span><span>    </span><span class="hs-comment">-- must not reach here</span><span>
</span><span id="line-308"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-309"></span><span>
</span><span id="line-310"></span><span class="hs-comment">----------------------------------------------------------------</span><span>
</span><span id="line-311"></span><span>
</span><span id="line-312"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#guardIt"><span class="hs-pragma hs-type">guardIt</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-313"></span><span id="local-6989586621679092986"><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#guardIt"><span class="hs-identifier hs-type">guardIt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#HTTP2Error"><span class="hs-identifier hs-type">HTTP2Error</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679092986"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679092986"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-314"></span><span id="guardIt"><span class="annot"><span class="annottext">guardIt :: Either HTTP2Error a -&gt; IO a
</span><a href="Network.HTTP2.Arch.Receiver.html#guardIt"><span class="hs-identifier hs-var hs-var">guardIt</span></a></span></span><span> </span><span id="local-6989586621679092478"><span class="annot"><span class="annottext">Either HTTP2Error a
</span><a href="#local-6989586621679092478"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either HTTP2Error a
</span><a href="#local-6989586621679092478"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-315"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679092477"><span class="annot"><span class="annottext">HTTP2Error
</span><a href="#local-6989586621679092477"><span class="hs-identifier hs-var">err</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO a
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">HTTP2Error
</span><a href="#local-6989586621679092477"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-316"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679092476"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679092476"><span class="hs-identifier hs-var">frame</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679092476"><span class="hs-identifier hs-var">frame</span></a></span><span>
</span><span id="line-317"></span><span>
</span><span id="line-318"></span><span>
</span><span id="line-319"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#checkPriority"><span class="hs-pragma hs-type">checkPriority</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-320"></span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#checkPriority"><span class="hs-identifier hs-type">checkPriority</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#Priority"><span class="hs-identifier hs-type">Priority</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#StreamId"><span class="hs-identifier hs-type">StreamId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-321"></span><span id="checkPriority"><span class="annot"><span class="annottext">checkPriority :: Priority -&gt; Int -&gt; IO ()
</span><a href="Network.HTTP2.Arch.Receiver.html#checkPriority"><span class="hs-identifier hs-var hs-var">checkPriority</span></a></span></span><span> </span><span id="local-6989586621679092475"><span class="annot"><span class="annottext">Priority
</span><a href="#local-6989586621679092475"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621679092474"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092474"><span class="hs-identifier hs-var">me</span></a></span></span><span>
</span><span id="line-322"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092473"><span class="hs-identifier hs-var">dep</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092474"><span class="hs-identifier hs-var">me</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO ()
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO ()) -&gt; HTTP2Error -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId -&gt; Int -&gt; HTTP2Error
</span><a href="Network.HTTP2.Frame.Types.html#StreamError"><span class="hs-identifier hs-var">StreamError</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId
</span><a href="Network.HTTP2.Frame.Types.html#ProtocolError"><span class="hs-identifier hs-var">ProtocolError</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092474"><span class="hs-identifier hs-var">me</span></a></span><span>
</span><span id="line-323"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-324"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-325"></span><span>    </span><span id="local-6989586621679092473"><span class="annot"><span class="annottext">dep :: Int
</span><a href="#local-6989586621679092473"><span class="hs-identifier hs-var hs-var">dep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Priority -&gt; Int
</span><a href="Network.HTTP2.Frame.Types.html#streamDependency"><span class="hs-identifier hs-var hs-var">streamDependency</span></a></span><span> </span><span class="annot"><span class="annottext">Priority
</span><a href="#local-6989586621679092475"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-326"></span><span>
</span><span id="line-327"></span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#stream"><span class="hs-identifier hs-type">stream</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameTypeId"><span class="hs-identifier hs-type">FrameTypeId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameHeader"><span class="hs-identifier hs-type">FrameHeader</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.Arch.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.Arch.Types.html#StreamState"><span class="hs-identifier hs-type">StreamState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.Arch.Types.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Network.HTTP2.Arch.Types.html#StreamState"><span class="hs-identifier hs-type">StreamState</span></a></span><span>
</span><span id="line-328"></span><span id="stream"><span class="annot"><span class="annottext">stream :: FrameTypeId
-&gt; FrameHeader
-&gt; ByteString
-&gt; Context
-&gt; StreamState
-&gt; Stream
-&gt; IO StreamState
</span><a href="Network.HTTP2.Arch.Receiver.html#stream"><span class="hs-identifier hs-var hs-var">stream</span></a></span></span><span> </span><span class="annot"><span class="annottext">FrameTypeId
</span><a href="Network.HTTP2.Frame.Types.html#FrameHeaders"><span class="hs-identifier hs-var">FrameHeaders</span></a></span><span> </span><span id="local-6989586621679092471"><span class="annot"><span class="annottext">header :: FrameHeader
</span><a href="#local-6989586621679092471"><span class="hs-identifier hs-var">header</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameHeader"><span class="hs-identifier hs-type">FrameHeader</span></a></span><span class="hs-special">{</span><span id="local-6989586621679092470"><span class="annot"><span class="annottext">FrameFlags
flags :: FrameFlags
flags :: FrameHeader -&gt; FrameFlags
</span><a href="#local-6989586621679092470"><span class="hs-identifier hs-var hs-var">flags</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679092469"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092469"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621679092468"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679092468"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679092467"><span class="annot"><span class="annottext">s :: StreamState
</span><a href="#local-6989586621679092467"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.Arch.Types.html#Open"><span class="hs-identifier hs-type">Open</span></a></span><span> </span><span class="annot"><span class="annottext">OpenState
</span><a href="Network.HTTP2.Arch.Types.html#JustOpened"><span class="hs-identifier hs-var">JustOpened</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Network.HTTP2.Arch.Types.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span class="hs-special">{</span><span id="local-6989586621679092465"><span class="annot"><span class="annottext">Int
streamNumber :: Stream -&gt; Int
streamNumber :: Int
</span><a href="Network.HTTP2.Arch.Types.html#streamNumber"><span class="hs-identifier hs-var hs-var">streamNumber</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-329"></span><span>    </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#HeadersFrame"><span class="hs-identifier hs-type">HeadersFrame</span></a></span><span> </span><span id="local-6989586621679092462"><span class="annot"><span class="annottext">Maybe Priority
</span><a href="#local-6989586621679092462"><span class="hs-identifier hs-var">mp</span></a></span></span><span> </span><span id="local-6989586621679092461"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092461"><span class="hs-identifier hs-var">frag</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Either HTTP2Error FramePayload -&gt; IO FramePayload
forall a. Either HTTP2Error a -&gt; IO a
</span><a href="Network.HTTP2.Arch.Receiver.html#guardIt"><span class="hs-identifier hs-var">guardIt</span></a></span><span> </span><span class="annot"><span class="annottext">(Either HTTP2Error FramePayload -&gt; IO FramePayload)
-&gt; Either HTTP2Error FramePayload -&gt; IO FramePayload
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FramePayloadDecoder
</span><a href="Network.HTTP2.Frame.Decode.html#decodeHeadersFrame"><span class="hs-identifier hs-var">decodeHeadersFrame</span></a></span><span> </span><span class="annot"><span class="annottext">FrameHeader
</span><a href="#local-6989586621679092471"><span class="hs-identifier hs-var">header</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092469"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-330"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679092459"><span class="annot"><span class="annottext">endOfStream :: Bool
</span><a href="#local-6989586621679092459"><span class="hs-identifier hs-var hs-var">endOfStream</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FrameFlags -&gt; Bool
</span><a href="Network.HTTP2.Frame.Types.html#testEndStream"><span class="hs-identifier hs-var">testEndStream</span></a></span><span> </span><span class="annot"><span class="annottext">FrameFlags
</span><a href="#local-6989586621679092470"><span class="hs-identifier hs-var">flags</span></a></span><span>
</span><span id="line-331"></span><span>        </span><span id="local-6989586621679092457"><span class="annot"><span class="annottext">endOfHeader :: Bool
</span><a href="#local-6989586621679092457"><span class="hs-identifier hs-var hs-var">endOfHeader</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FrameFlags -&gt; Bool
</span><a href="Network.HTTP2.Frame.Types.html#testEndHeader"><span class="hs-identifier hs-var">testEndHeader</span></a></span><span> </span><span class="annot"><span class="annottext">FrameFlags
</span><a href="#local-6989586621679092470"><span class="hs-identifier hs-var">flags</span></a></span><span>
</span><span id="line-332"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092461"><span class="hs-identifier hs-var">frag</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679092459"><span class="hs-identifier hs-var">endOfStream</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679092457"><span class="hs-identifier hs-var">endOfHeader</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-333"></span><span>        </span><span class="hs-comment">-- Empty Frame Flooding - CVE-2019-9518</span><span>
</span><span id="line-334"></span><span>        </span><span id="local-6989586621679092454"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092454"><span class="hs-identifier hs-var">rate</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Rate -&gt; IO Int
</span><a href="Network.HTTP2.Arch.Rate.html#getRate"><span class="hs-identifier hs-var">getRate</span></a></span><span> </span><span class="annot"><span class="annottext">(Rate -&gt; IO Int) -&gt; Rate -&gt; IO Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; Rate
</span><a href="Network.HTTP2.Arch.Context.html#emptyFrameRate"><span class="hs-identifier hs-var hs-var">emptyFrameRate</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679092468"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-335"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092454"><span class="hs-identifier hs-var">rate</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="Network.HTTP2.Arch.Receiver.html#emptyFrameRateLimit"><span class="hs-identifier hs-var">emptyFrameRateLimit</span></a></span><span> </span><span class="hs-keyword">then</span><span>
</span><span id="line-336"></span><span>            </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO StreamState
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO StreamState) -&gt; HTTP2Error -&gt; IO StreamState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId -&gt; ByteString -&gt; HTTP2Error
</span><a href="Network.HTTP2.Frame.Types.html#ConnectionError"><span class="hs-identifier hs-var">ConnectionError</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId
</span><a href="Network.HTTP2.Frame.Types.html#ProtocolError"><span class="hs-identifier hs-var">ProtocolError</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;too many empty headers&quot;</span></span><span>
</span><span id="line-337"></span><span>          </span><span class="hs-keyword">else</span><span>
</span><span id="line-338"></span><span>            </span><span class="annot"><span class="annottext">StreamState -&gt; IO StreamState
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">StreamState
</span><a href="#local-6989586621679092467"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-339"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-340"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Priority
</span><a href="#local-6989586621679092462"><span class="hs-identifier hs-var">mp</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-341"></span><span>          </span><span class="annot"><span class="annottext">Maybe Priority
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-342"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679092453"><span class="annot"><span class="annottext">Priority
</span><a href="#local-6989586621679092453"><span class="hs-identifier hs-var">p</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Priority -&gt; Int -&gt; IO ()
</span><a href="Network.HTTP2.Arch.Receiver.html#checkPriority"><span class="hs-identifier hs-var">checkPriority</span></a></span><span> </span><span class="annot"><span class="annottext">Priority
</span><a href="#local-6989586621679092453"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092465"><span class="hs-identifier hs-var">streamNumber</span></a></span><span>
</span><span id="line-343"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679092457"><span class="hs-identifier hs-var">endOfHeader</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-344"></span><span>            </span><span id="local-6989586621679092452"><span class="annot"><span class="annottext">(TokenHeaderList, ValueTable)
</span><a href="#local-6989586621679092452"><span class="hs-identifier hs-var">tbl</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Context -&gt; IO (TokenHeaderList, ValueTable)
</span><a href="Network.HTTP2.Arch.HPACK.html#hpackDecodeHeader"><span class="hs-identifier hs-var">hpackDecodeHeader</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092461"><span class="hs-identifier hs-var">frag</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679092468"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-345"></span><span>            </span><span class="annot"><span class="annottext">StreamState -&gt; IO StreamState
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(StreamState -&gt; IO StreamState) -&gt; StreamState -&gt; IO StreamState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679092459"><span class="hs-identifier hs-var">endOfStream</span></a></span><span> </span><span class="hs-keyword">then</span><span>
</span><span id="line-346"></span><span>                        </span><span class="annot"><span class="annottext">OpenState -&gt; StreamState
</span><a href="Network.HTTP2.Arch.Types.html#Open"><span class="hs-identifier hs-var">Open</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TokenHeaderList, ValueTable) -&gt; OpenState
</span><a href="Network.HTTP2.Arch.Types.html#NoBody"><span class="hs-identifier hs-var">NoBody</span></a></span><span> </span><span class="annot"><span class="annottext">(TokenHeaderList, ValueTable)
</span><a href="#local-6989586621679092452"><span class="hs-identifier hs-var">tbl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-347"></span><span>                       </span><span class="hs-keyword">else</span><span>
</span><span id="line-348"></span><span>                        </span><span class="annot"><span class="annottext">OpenState -&gt; StreamState
</span><a href="Network.HTTP2.Arch.Types.html#Open"><span class="hs-identifier hs-var">Open</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TokenHeaderList, ValueTable) -&gt; OpenState
</span><a href="Network.HTTP2.Arch.Types.html#HasBody"><span class="hs-identifier hs-var">HasBody</span></a></span><span> </span><span class="annot"><span class="annottext">(TokenHeaderList, ValueTable)
</span><a href="#local-6989586621679092452"><span class="hs-identifier hs-var">tbl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-349"></span><span>          </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-350"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679092451"><span class="annot"><span class="annottext">siz :: Int
</span><a href="#local-6989586621679092451"><span class="hs-identifier hs-var hs-var">siz</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><span class="hs-identifier hs-var">BS.length</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092461"><span class="hs-identifier hs-var">frag</span></a></span><span>
</span><span id="line-351"></span><span>            </span><span class="annot"><span class="annottext">StreamState -&gt; IO StreamState
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(StreamState -&gt; IO StreamState) -&gt; StreamState -&gt; IO StreamState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">OpenState -&gt; StreamState
</span><a href="Network.HTTP2.Arch.Types.html#Open"><span class="hs-identifier hs-var">Open</span></a></span><span> </span><span class="annot"><span class="annottext">(OpenState -&gt; StreamState) -&gt; OpenState -&gt; StreamState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[ByteString] -&gt; Int -&gt; Int -&gt; Bool -&gt; OpenState
</span><a href="Network.HTTP2.Arch.Types.html#Continued"><span class="hs-identifier hs-var">Continued</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092461"><span class="hs-identifier hs-var">frag</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092451"><span class="hs-identifier hs-var">siz</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679092459"><span class="hs-identifier hs-var">endOfStream</span></a></span><span>
</span><span id="line-352"></span><span>
</span><span id="line-353"></span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#stream"><span class="hs-identifier hs-var">stream</span></a></span><span> </span><span class="annot"><span class="annottext">FrameTypeId
</span><a href="Network.HTTP2.Frame.Types.html#FrameHeaders"><span class="hs-identifier hs-var">FrameHeaders</span></a></span><span> </span><span id="local-6989586621679092449"><span class="annot"><span class="annottext">header :: FrameHeader
</span><a href="#local-6989586621679092449"><span class="hs-identifier hs-var">header</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameHeader"><span class="hs-identifier hs-type">FrameHeader</span></a></span><span class="hs-special">{</span><span id="local-6989586621679092448"><span class="annot"><span class="annottext">FrameFlags
flags :: FrameFlags
flags :: FrameHeader -&gt; FrameFlags
</span><a href="#local-6989586621679092448"><span class="hs-identifier hs-var hs-var">flags</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679092447"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092447"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621679092446"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679092446"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.Arch.Types.html#Open"><span class="hs-identifier hs-type">Open</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.Arch.Types.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span id="local-6989586621679092445"><span class="annot"><span class="annottext">TQueue ByteString
</span><a href="#local-6989586621679092445"><span class="hs-identifier hs-var">q</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">IORef Int
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679092444"><span class="annot"><span class="annottext">IORef (Maybe (TokenHeaderList, ValueTable))
</span><a href="#local-6989586621679092444"><span class="hs-identifier hs-var">tlr</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stream
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-354"></span><span>    </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#HeadersFrame"><span class="hs-identifier hs-type">HeadersFrame</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Priority
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679092443"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092443"><span class="hs-identifier hs-var">frag</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Either HTTP2Error FramePayload -&gt; IO FramePayload
forall a. Either HTTP2Error a -&gt; IO a
</span><a href="Network.HTTP2.Arch.Receiver.html#guardIt"><span class="hs-identifier hs-var">guardIt</span></a></span><span> </span><span class="annot"><span class="annottext">(Either HTTP2Error FramePayload -&gt; IO FramePayload)
-&gt; Either HTTP2Error FramePayload -&gt; IO FramePayload
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FramePayloadDecoder
</span><a href="Network.HTTP2.Frame.Decode.html#decodeHeadersFrame"><span class="hs-identifier hs-var">decodeHeadersFrame</span></a></span><span> </span><span class="annot"><span class="annottext">FrameHeader
</span><a href="#local-6989586621679092449"><span class="hs-identifier hs-var">header</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092447"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-355"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679092442"><span class="annot"><span class="annottext">endOfStream :: Bool
</span><a href="#local-6989586621679092442"><span class="hs-identifier hs-var hs-var">endOfStream</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FrameFlags -&gt; Bool
</span><a href="Network.HTTP2.Frame.Types.html#testEndStream"><span class="hs-identifier hs-var">testEndStream</span></a></span><span> </span><span class="annot"><span class="annottext">FrameFlags
</span><a href="#local-6989586621679092448"><span class="hs-identifier hs-var">flags</span></a></span><span>
</span><span id="line-356"></span><span>    </span><span class="hs-comment">-- checking frag == &quot;&quot; is not necessary</span><span>
</span><span id="line-357"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679092442"><span class="hs-identifier hs-var">endOfStream</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-358"></span><span>        </span><span id="local-6989586621679092441"><span class="annot"><span class="annottext">(TokenHeaderList, ValueTable)
</span><a href="#local-6989586621679092441"><span class="hs-identifier hs-var">tbl</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Context -&gt; IO (TokenHeaderList, ValueTable)
</span><a href="Network.HTTP2.Arch.HPACK.html#hpackDecodeTrailer"><span class="hs-identifier hs-var">hpackDecodeTrailer</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092443"><span class="hs-identifier hs-var">frag</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679092446"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-359"></span><span>        </span><span class="annot"><span class="annottext">IORef (Maybe (TokenHeaderList, ValueTable))
-&gt; Maybe (TokenHeaderList, ValueTable) -&gt; IO ()
forall a. IORef a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">writeIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef (Maybe (TokenHeaderList, ValueTable))
</span><a href="#local-6989586621679092444"><span class="hs-identifier hs-var">tlr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TokenHeaderList, ValueTable)
-&gt; Maybe (TokenHeaderList, ValueTable)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(TokenHeaderList, ValueTable)
</span><a href="#local-6989586621679092441"><span class="hs-identifier hs-var">tbl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-360"></span><span>        </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TQueue ByteString -&gt; ByteString -&gt; STM ()
forall a. TQueue a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTQueue</span></span><span> </span><span class="annot"><span class="annottext">TQueue ByteString
</span><a href="#local-6989586621679092445"><span class="hs-identifier hs-var">q</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;&quot;</span></span><span>
</span><span id="line-361"></span><span>        </span><span class="annot"><span class="annottext">StreamState -&gt; IO StreamState
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">StreamState
</span><a href="Network.HTTP2.Arch.Types.html#HalfClosedRemote"><span class="hs-identifier hs-var">HalfClosedRemote</span></a></span><span>
</span><span id="line-362"></span><span>      </span><span class="hs-keyword">else</span><span>
</span><span id="line-363"></span><span>        </span><span class="hs-comment">-- we don't support continuation here.</span><span>
</span><span id="line-364"></span><span>        </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO StreamState
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO StreamState) -&gt; HTTP2Error -&gt; IO StreamState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId -&gt; ByteString -&gt; HTTP2Error
</span><a href="Network.HTTP2.Frame.Types.html#ConnectionError"><span class="hs-identifier hs-var">ConnectionError</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId
</span><a href="Network.HTTP2.Frame.Types.html#ProtocolError"><span class="hs-identifier hs-var">ProtocolError</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;continuation in trailer is not supported&quot;</span></span><span>
</span><span id="line-365"></span><span>
</span><span id="line-366"></span><span class="hs-comment">-- ignore data-frame except for flow-control when we're done locally</span><span>
</span><span id="line-367"></span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#stream"><span class="hs-identifier hs-var">stream</span></a></span><span> </span><span class="annot"><span class="annottext">FrameTypeId
</span><a href="Network.HTTP2.Frame.Types.html#FrameData"><span class="hs-identifier hs-var">FrameData</span></a></span><span>
</span><span id="line-368"></span><span>       </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameHeader"><span class="hs-identifier hs-type">FrameHeader</span></a></span><span class="hs-special">{</span><span id="local-6989586621679092438"><span class="annot"><span class="annottext">FrameFlags
flags :: FrameFlags
flags :: FrameHeader -&gt; FrameFlags
</span><a href="#local-6989586621679092438"><span class="hs-identifier hs-var hs-var">flags</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679092437"><span class="annot"><span class="annottext">Int
payloadLength :: Int
payloadLength :: FrameHeader -&gt; Int
</span><a href="#local-6989586621679092437"><span class="hs-identifier hs-var hs-var">payloadLength</span></a></span></span><span class="hs-special">}</span><span>
</span><span id="line-369"></span><span>       </span><span id="local-6989586621679092436"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092436"><span class="hs-identifier hs-var">_bs</span></a></span></span><span>
</span><span id="line-370"></span><span>       </span><span class="annot"><a href="Network.HTTP2.Arch.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span class="hs-special">{</span><span id="local-6989586621679092435"><span class="annot"><span class="annottext">TQueue Control
controlQ :: TQueue Control
controlQ :: Context -&gt; TQueue Control
</span><a href="#local-6989586621679092435"><span class="hs-identifier hs-var hs-var">controlQ</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679092434"><span class="annot"><span class="annottext">s :: StreamState
</span><a href="#local-6989586621679092434"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.Arch.Types.html#HalfClosedLocal"><span class="hs-identifier hs-type">HalfClosedLocal</span></a></span><span> </span><span class="annot"><span class="annottext">ClosedCode
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-371"></span><span>       </span><span class="annot"><span class="annottext">Stream
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-372"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092437"><span class="hs-identifier hs-var">payloadLength</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-373"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679092432"><span class="annot"><span class="annottext">frame :: ByteString
</span><a href="#local-6989586621679092432"><span class="hs-identifier hs-var hs-var">frame</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; ByteString
</span><a href="Network.HTTP2.Arch.EncodeFrame.html#windowUpdateFrame"><span class="hs-identifier hs-var">windowUpdateFrame</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092437"><span class="hs-identifier hs-var">payloadLength</span></a></span><span>
</span><span id="line-374"></span><span>        </span><span class="annot"><span class="annottext">TQueue Control -&gt; Control -&gt; IO ()
</span><a href="Network.HTTP2.Arch.Queue.html#enqueueControl"><span class="hs-identifier hs-var">enqueueControl</span></a></span><span> </span><span class="annot"><span class="annottext">TQueue Control
</span><a href="#local-6989586621679092435"><span class="hs-identifier hs-var">controlQ</span></a></span><span> </span><span class="annot"><span class="annottext">(Control -&gt; IO ()) -&gt; Control -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Control
</span><a href="Network.HTTP2.Arch.Types.html#CFrame"><span class="hs-identifier hs-var">CFrame</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092432"><span class="hs-identifier hs-var">frame</span></a></span><span>
</span><span id="line-375"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679092430"><span class="annot"><span class="annottext">endOfStream :: Bool
</span><a href="#local-6989586621679092430"><span class="hs-identifier hs-var hs-var">endOfStream</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FrameFlags -&gt; Bool
</span><a href="Network.HTTP2.Frame.Types.html#testEndStream"><span class="hs-identifier hs-var">testEndStream</span></a></span><span> </span><span class="annot"><span class="annottext">FrameFlags
</span><a href="#local-6989586621679092438"><span class="hs-identifier hs-var">flags</span></a></span><span>
</span><span id="line-376"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679092430"><span class="hs-identifier hs-var">endOfStream</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-377"></span><span>        </span><span class="annot"><span class="annottext">StreamState -&gt; IO StreamState
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">StreamState
</span><a href="Network.HTTP2.Arch.Types.html#HalfClosedRemote"><span class="hs-identifier hs-var">HalfClosedRemote</span></a></span><span>
</span><span id="line-378"></span><span>      </span><span class="hs-keyword">else</span><span>
</span><span id="line-379"></span><span>        </span><span class="annot"><span class="annottext">StreamState -&gt; IO StreamState
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">StreamState
</span><a href="#local-6989586621679092434"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-380"></span><span>
</span><span id="line-381"></span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#stream"><span class="hs-identifier hs-var">stream</span></a></span><span> </span><span class="annot"><span class="annottext">FrameTypeId
</span><a href="Network.HTTP2.Frame.Types.html#FrameData"><span class="hs-identifier hs-var">FrameData</span></a></span><span>
</span><span id="line-382"></span><span>       </span><span id="local-6989586621679092429"><span class="annot"><span class="annottext">header :: FrameHeader
</span><a href="#local-6989586621679092429"><span class="hs-identifier hs-var">header</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameHeader"><span class="hs-identifier hs-type">FrameHeader</span></a></span><span class="hs-special">{</span><span id="local-6989586621679092428"><span class="annot"><span class="annottext">FrameFlags
flags :: FrameFlags
flags :: FrameHeader -&gt; FrameFlags
</span><a href="#local-6989586621679092428"><span class="hs-identifier hs-var hs-var">flags</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679092427"><span class="annot"><span class="annottext">Int
payloadLength :: Int
payloadLength :: FrameHeader -&gt; Int
</span><a href="#local-6989586621679092427"><span class="hs-identifier hs-var hs-var">payloadLength</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679092426"><span class="annot"><span class="annottext">Int
streamId :: Int
streamId :: FrameHeader -&gt; Int
</span><a href="#local-6989586621679092426"><span class="hs-identifier hs-var hs-var">streamId</span></a></span></span><span class="hs-special">}</span><span>
</span><span id="line-383"></span><span>       </span><span id="local-6989586621679092425"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092425"><span class="hs-identifier hs-var">bs</span></a></span></span><span>
</span><span id="line-384"></span><span>       </span><span class="annot"><a href="Network.HTTP2.Arch.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span class="hs-special">{</span><span id="local-6989586621679092424"><span class="annot"><span class="annottext">Rate
emptyFrameRate :: Rate
emptyFrameRate :: Context -&gt; Rate
</span><a href="#local-6989586621679092424"><span class="hs-identifier hs-var hs-var">emptyFrameRate</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679092423"><span class="annot"><span class="annottext">s :: StreamState
</span><a href="#local-6989586621679092423"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.Arch.Types.html#Open"><span class="hs-identifier hs-type">Open</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.Arch.Types.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span id="local-6989586621679092422"><span class="annot"><span class="annottext">TQueue ByteString
</span><a href="#local-6989586621679092422"><span class="hs-identifier hs-var">q</span></a></span></span><span> </span><span id="local-6989586621679092421"><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621679092421"><span class="hs-identifier hs-var">mcl</span></a></span></span><span> </span><span id="local-6989586621679092420"><span class="annot"><span class="annottext">IORef Int
</span><a href="#local-6989586621679092420"><span class="hs-identifier hs-var">bodyLength</span></a></span></span><span> </span><span class="annot"><span class="annottext">IORef (Maybe (TokenHeaderList, ValueTable))
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-385"></span><span>       </span><span class="annot"><span class="annottext">Stream
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-386"></span><span>    </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#DataFrame"><span class="hs-identifier hs-type">DataFrame</span></a></span><span> </span><span id="local-6989586621679092418"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092418"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Either HTTP2Error FramePayload -&gt; IO FramePayload
forall a. Either HTTP2Error a -&gt; IO a
</span><a href="Network.HTTP2.Arch.Receiver.html#guardIt"><span class="hs-identifier hs-var">guardIt</span></a></span><span> </span><span class="annot"><span class="annottext">(Either HTTP2Error FramePayload -&gt; IO FramePayload)
-&gt; Either HTTP2Error FramePayload -&gt; IO FramePayload
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FramePayloadDecoder
</span><a href="Network.HTTP2.Frame.Decode.html#decodeDataFrame"><span class="hs-identifier hs-var">decodeDataFrame</span></a></span><span> </span><span class="annot"><span class="annottext">FrameHeader
</span><a href="#local-6989586621679092429"><span class="hs-identifier hs-var">header</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092425"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-387"></span><span>    </span><span id="local-6989586621679092416"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092416"><span class="hs-identifier hs-var">len0</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef Int -&gt; IO Int
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef Int
</span><a href="#local-6989586621679092420"><span class="hs-identifier hs-var">bodyLength</span></a></span><span>
</span><span id="line-388"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679092415"><span class="annot"><span class="annottext">len :: Int
</span><a href="#local-6989586621679092415"><span class="hs-identifier hs-var hs-var">len</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092416"><span class="hs-identifier hs-var">len0</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092427"><span class="hs-identifier hs-var">payloadLength</span></a></span><span>
</span><span id="line-389"></span><span>        </span><span id="local-6989586621679092414"><span class="annot"><span class="annottext">endOfStream :: Bool
</span><a href="#local-6989586621679092414"><span class="hs-identifier hs-var hs-var">endOfStream</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FrameFlags -&gt; Bool
</span><a href="Network.HTTP2.Frame.Types.html#testEndStream"><span class="hs-identifier hs-var">testEndStream</span></a></span><span> </span><span class="annot"><span class="annottext">FrameFlags
</span><a href="#local-6989586621679092428"><span class="hs-identifier hs-var">flags</span></a></span><span>
</span><span id="line-390"></span><span>    </span><span class="hs-comment">-- Empty Frame Flooding - CVE-2019-9518</span><span>
</span><span id="line-391"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092418"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="hs-keyword">then</span><span>
</span><span id="line-392"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679092414"><span class="hs-identifier hs-var">endOfStream</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-393"></span><span>            </span><span id="local-6989586621679092413"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092413"><span class="hs-identifier hs-var">rate</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Rate -&gt; IO Int
</span><a href="Network.HTTP2.Arch.Rate.html#getRate"><span class="hs-identifier hs-var">getRate</span></a></span><span> </span><span class="annot"><span class="annottext">Rate
</span><a href="#local-6989586621679092424"><span class="hs-identifier hs-var">emptyFrameRate</span></a></span><span>
</span><span id="line-394"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092413"><span class="hs-identifier hs-var">rate</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="Network.HTTP2.Arch.Receiver.html#emptyFrameRateLimit"><span class="hs-identifier hs-var">emptyFrameRateLimit</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-395"></span><span>                </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO ()
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO ()) -&gt; HTTP2Error -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId -&gt; ByteString -&gt; HTTP2Error
</span><a href="Network.HTTP2.Frame.Types.html#ConnectionError"><span class="hs-identifier hs-var">ConnectionError</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId
</span><a href="Network.HTTP2.Frame.Types.html#ProtocolError"><span class="hs-identifier hs-var">ProtocolError</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;too many empty data&quot;</span></span><span>
</span><span id="line-396"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-397"></span><span>        </span><span class="annot"><span class="annottext">IORef Int -&gt; Int -&gt; IO ()
forall a. IORef a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">writeIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef Int
</span><a href="#local-6989586621679092420"><span class="hs-identifier hs-var">bodyLength</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092415"><span class="hs-identifier hs-var">len</span></a></span><span>
</span><span id="line-398"></span><span>        </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TQueue ByteString -&gt; ByteString -&gt; STM ()
forall a. TQueue a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTQueue</span></span><span> </span><span class="annot"><span class="annottext">TQueue ByteString
</span><a href="#local-6989586621679092422"><span class="hs-identifier hs-var">q</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092418"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-399"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679092414"><span class="hs-identifier hs-var">endOfStream</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-400"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621679092421"><span class="hs-identifier hs-var">mcl</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-401"></span><span>            </span><span class="annot"><span class="annottext">Maybe Int
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-402"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679092412"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092412"><span class="hs-identifier hs-var">cl</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092412"><span class="hs-identifier hs-var">cl</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092415"><span class="hs-identifier hs-var">len</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO ()
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO ()) -&gt; HTTP2Error -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId -&gt; Int -&gt; HTTP2Error
</span><a href="Network.HTTP2.Frame.Types.html#StreamError"><span class="hs-identifier hs-var">StreamError</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId
</span><a href="Network.HTTP2.Frame.Types.html#ProtocolError"><span class="hs-identifier hs-var">ProtocolError</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092426"><span class="hs-identifier hs-var">streamId</span></a></span><span>
</span><span id="line-403"></span><span>        </span><span class="hs-comment">-- no trailers</span><span>
</span><span id="line-404"></span><span>        </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TQueue ByteString -&gt; ByteString -&gt; STM ()
forall a. TQueue a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTQueue</span></span><span> </span><span class="annot"><span class="annottext">TQueue ByteString
</span><a href="#local-6989586621679092422"><span class="hs-identifier hs-var">q</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;&quot;</span></span><span>
</span><span id="line-405"></span><span>        </span><span class="annot"><span class="annottext">StreamState -&gt; IO StreamState
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">StreamState
</span><a href="Network.HTTP2.Arch.Types.html#HalfClosedRemote"><span class="hs-identifier hs-var">HalfClosedRemote</span></a></span><span>
</span><span id="line-406"></span><span>      </span><span class="hs-keyword">else</span><span>
</span><span id="line-407"></span><span>        </span><span class="annot"><span class="annottext">StreamState -&gt; IO StreamState
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">StreamState
</span><a href="#local-6989586621679092423"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-408"></span><span>
</span><span id="line-409"></span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#stream"><span class="hs-identifier hs-var">stream</span></a></span><span> </span><span class="annot"><span class="annottext">FrameTypeId
</span><a href="Network.HTTP2.Frame.Types.html#FrameContinuation"><span class="hs-identifier hs-var">FrameContinuation</span></a></span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameHeader"><span class="hs-identifier hs-type">FrameHeader</span></a></span><span class="hs-special">{</span><span id="local-6989586621679092411"><span class="annot"><span class="annottext">FrameFlags
flags :: FrameFlags
flags :: FrameHeader -&gt; FrameFlags
</span><a href="#local-6989586621679092411"><span class="hs-identifier hs-var hs-var">flags</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679092410"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092410"><span class="hs-identifier hs-var">frag</span></a></span></span><span> </span><span id="local-6989586621679092409"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679092409"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679092408"><span class="annot"><span class="annottext">s :: StreamState
</span><a href="#local-6989586621679092408"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.Arch.Types.html#Open"><span class="hs-identifier hs-type">Open</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.Arch.Types.html#Continued"><span class="hs-identifier hs-type">Continued</span></a></span><span> </span><span id="local-6989586621679092407"><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679092407"><span class="hs-identifier hs-var">rfrags</span></a></span></span><span> </span><span id="local-6989586621679092406"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092406"><span class="hs-identifier hs-var">siz</span></a></span></span><span> </span><span id="local-6989586621679092405"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092405"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621679092404"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679092404"><span class="hs-identifier hs-var">endOfStream</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stream
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-410"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679092403"><span class="annot"><span class="annottext">endOfHeader :: Bool
</span><a href="#local-6989586621679092403"><span class="hs-identifier hs-var hs-var">endOfHeader</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FrameFlags -&gt; Bool
</span><a href="Network.HTTP2.Frame.Types.html#testEndHeader"><span class="hs-identifier hs-var">testEndHeader</span></a></span><span> </span><span class="annot"><span class="annottext">FrameFlags
</span><a href="#local-6989586621679092411"><span class="hs-identifier hs-var">flags</span></a></span><span>
</span><span id="line-411"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092410"><span class="hs-identifier hs-var">frag</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679092403"><span class="hs-identifier hs-var">endOfHeader</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-412"></span><span>        </span><span class="hs-comment">-- Empty Frame Flooding - CVE-2019-9518</span><span>
</span><span id="line-413"></span><span>        </span><span id="local-6989586621679092402"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092402"><span class="hs-identifier hs-var">rate</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Rate -&gt; IO Int
</span><a href="Network.HTTP2.Arch.Rate.html#getRate"><span class="hs-identifier hs-var">getRate</span></a></span><span> </span><span class="annot"><span class="annottext">(Rate -&gt; IO Int) -&gt; Rate -&gt; IO Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; Rate
</span><a href="Network.HTTP2.Arch.Context.html#emptyFrameRate"><span class="hs-identifier hs-var hs-var">emptyFrameRate</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679092409"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-414"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092402"><span class="hs-identifier hs-var">rate</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="Network.HTTP2.Arch.Receiver.html#emptyFrameRateLimit"><span class="hs-identifier hs-var">emptyFrameRateLimit</span></a></span><span> </span><span class="hs-keyword">then</span><span>
</span><span id="line-415"></span><span>            </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO StreamState
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO StreamState) -&gt; HTTP2Error -&gt; IO StreamState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId -&gt; ByteString -&gt; HTTP2Error
</span><a href="Network.HTTP2.Frame.Types.html#ConnectionError"><span class="hs-identifier hs-var">ConnectionError</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId
</span><a href="Network.HTTP2.Frame.Types.html#ProtocolError"><span class="hs-identifier hs-var">ProtocolError</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;too many empty continuation&quot;</span></span><span>
</span><span id="line-416"></span><span>          </span><span class="hs-keyword">else</span><span>
</span><span id="line-417"></span><span>            </span><span class="annot"><span class="annottext">StreamState -&gt; IO StreamState
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">StreamState
</span><a href="#local-6989586621679092408"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-418"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-419"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679092401"><span class="annot"><span class="annottext">rfrags' :: [ByteString]
</span><a href="#local-6989586621679092401"><span class="hs-identifier hs-var hs-var">rfrags'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092410"><span class="hs-identifier hs-var">frag</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; [ByteString] -&gt; [ByteString]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679092407"><span class="hs-identifier hs-var">rfrags</span></a></span><span>
</span><span id="line-420"></span><span>            </span><span id="local-6989586621679092400"><span class="annot"><span class="annottext">siz' :: Int
</span><a href="#local-6989586621679092400"><span class="hs-identifier hs-var hs-var">siz'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092406"><span class="hs-identifier hs-var">siz</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><span class="hs-identifier hs-var">BS.length</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092410"><span class="hs-identifier hs-var">frag</span></a></span><span>
</span><span id="line-421"></span><span>            </span><span id="local-6989586621679092399"><span class="annot"><span class="annottext">n' :: Int
</span><a href="#local-6989586621679092399"><span class="hs-identifier hs-var hs-var">n'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092405"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-422"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092400"><span class="hs-identifier hs-var">siz'</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="Network.HTTP2.Arch.Receiver.html#headerFragmentLimit"><span class="hs-identifier hs-var">headerFragmentLimit</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-423"></span><span>          </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO ()
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO ()) -&gt; HTTP2Error -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId -&gt; ByteString -&gt; HTTP2Error
</span><a href="Network.HTTP2.Frame.Types.html#ConnectionError"><span class="hs-identifier hs-var">ConnectionError</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId
</span><a href="Network.HTTP2.Frame.Types.html#EnhanceYourCalm"><span class="hs-identifier hs-var">EnhanceYourCalm</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;Header is too big&quot;</span></span><span>
</span><span id="line-424"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092399"><span class="hs-identifier hs-var">n'</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="Network.HTTP2.Arch.Receiver.html#continuationLimit"><span class="hs-identifier hs-var">continuationLimit</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-425"></span><span>          </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO ()
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO ()) -&gt; HTTP2Error -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId -&gt; ByteString -&gt; HTTP2Error
</span><a href="Network.HTTP2.Frame.Types.html#ConnectionError"><span class="hs-identifier hs-var">ConnectionError</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId
</span><a href="Network.HTTP2.Frame.Types.html#EnhanceYourCalm"><span class="hs-identifier hs-var">EnhanceYourCalm</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;Header is too fragmented&quot;</span></span><span>
</span><span id="line-426"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679092403"><span class="hs-identifier hs-var">endOfHeader</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-427"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679092397"><span class="annot"><span class="annottext">hdrblk :: ByteString
</span><a href="#local-6989586621679092397"><span class="hs-identifier hs-var hs-var">hdrblk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ByteString] -&gt; ByteString
</span><span class="hs-identifier hs-var">BS.concat</span></span><span> </span><span class="annot"><span class="annottext">([ByteString] -&gt; ByteString) -&gt; [ByteString] -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[ByteString] -&gt; [ByteString]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679092401"><span class="hs-identifier hs-var">rfrags'</span></a></span><span>
</span><span id="line-428"></span><span>            </span><span id="local-6989586621679092394"><span class="annot"><span class="annottext">(TokenHeaderList, ValueTable)
</span><a href="#local-6989586621679092394"><span class="hs-identifier hs-var">tbl</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Context -&gt; IO (TokenHeaderList, ValueTable)
</span><a href="Network.HTTP2.Arch.HPACK.html#hpackDecodeHeader"><span class="hs-identifier hs-var">hpackDecodeHeader</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092397"><span class="hs-identifier hs-var">hdrblk</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679092409"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-429"></span><span>            </span><span class="annot"><span class="annottext">StreamState -&gt; IO StreamState
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(StreamState -&gt; IO StreamState) -&gt; StreamState -&gt; IO StreamState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679092404"><span class="hs-identifier hs-var">endOfStream</span></a></span><span> </span><span class="hs-keyword">then</span><span>
</span><span id="line-430"></span><span>                        </span><span class="annot"><span class="annottext">OpenState -&gt; StreamState
</span><a href="Network.HTTP2.Arch.Types.html#Open"><span class="hs-identifier hs-var">Open</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TokenHeaderList, ValueTable) -&gt; OpenState
</span><a href="Network.HTTP2.Arch.Types.html#NoBody"><span class="hs-identifier hs-var">NoBody</span></a></span><span> </span><span class="annot"><span class="annottext">(TokenHeaderList, ValueTable)
</span><a href="#local-6989586621679092394"><span class="hs-identifier hs-var">tbl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-431"></span><span>                       </span><span class="hs-keyword">else</span><span>
</span><span id="line-432"></span><span>                        </span><span class="annot"><span class="annottext">OpenState -&gt; StreamState
</span><a href="Network.HTTP2.Arch.Types.html#Open"><span class="hs-identifier hs-var">Open</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TokenHeaderList, ValueTable) -&gt; OpenState
</span><a href="Network.HTTP2.Arch.Types.html#HasBody"><span class="hs-identifier hs-var">HasBody</span></a></span><span> </span><span class="annot"><span class="annottext">(TokenHeaderList, ValueTable)
</span><a href="#local-6989586621679092394"><span class="hs-identifier hs-var">tbl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-433"></span><span>          </span><span class="hs-keyword">else</span><span>
</span><span id="line-434"></span><span>            </span><span class="annot"><span class="annottext">StreamState -&gt; IO StreamState
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(StreamState -&gt; IO StreamState) -&gt; StreamState -&gt; IO StreamState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">OpenState -&gt; StreamState
</span><a href="Network.HTTP2.Arch.Types.html#Open"><span class="hs-identifier hs-var">Open</span></a></span><span> </span><span class="annot"><span class="annottext">(OpenState -&gt; StreamState) -&gt; OpenState -&gt; StreamState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[ByteString] -&gt; Int -&gt; Int -&gt; Bool -&gt; OpenState
</span><a href="Network.HTTP2.Arch.Types.html#Continued"><span class="hs-identifier hs-var">Continued</span></a></span><span> </span><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679092401"><span class="hs-identifier hs-var">rfrags'</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092400"><span class="hs-identifier hs-var">siz'</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092399"><span class="hs-identifier hs-var">n'</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679092404"><span class="hs-identifier hs-var">endOfStream</span></a></span><span>
</span><span id="line-435"></span><span>
</span><span id="line-436"></span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#stream"><span class="hs-identifier hs-var">stream</span></a></span><span> </span><span class="annot"><span class="annottext">FrameTypeId
</span><a href="Network.HTTP2.Frame.Types.html#FrameWindowUpdate"><span class="hs-identifier hs-var">FrameWindowUpdate</span></a></span><span> </span><span id="local-6989586621679092393"><span class="annot"><span class="annottext">header :: FrameHeader
</span><a href="#local-6989586621679092393"><span class="hs-identifier hs-var">header</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameHeader"><span class="hs-identifier hs-type">FrameHeader</span></a></span><span class="hs-special">{</span><span id="local-6989586621679092392"><span class="annot"><span class="annottext">Int
streamId :: Int
streamId :: FrameHeader -&gt; Int
</span><a href="#local-6989586621679092392"><span class="hs-identifier hs-var hs-var">streamId</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679092391"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092391"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="annot"><span class="annottext">Context
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679092390"><span class="annot"><span class="annottext">StreamState
</span><a href="#local-6989586621679092390"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="annot"><a href="Network.HTTP2.Arch.Types.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span class="hs-special">{</span><span id="local-6989586621679092389"><span class="annot"><span class="annottext">TVar Int
streamWindow :: Stream -&gt; TVar Int
streamWindow :: TVar Int
</span><a href="Network.HTTP2.Arch.Types.html#streamWindow"><span class="hs-identifier hs-var hs-var">streamWindow</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-437"></span><span>    </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#WindowUpdateFrame"><span class="hs-identifier hs-type">WindowUpdateFrame</span></a></span><span> </span><span id="local-6989586621679092387"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092387"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Either HTTP2Error FramePayload -&gt; IO FramePayload
forall a. Either HTTP2Error a -&gt; IO a
</span><a href="Network.HTTP2.Arch.Receiver.html#guardIt"><span class="hs-identifier hs-var">guardIt</span></a></span><span> </span><span class="annot"><span class="annottext">(Either HTTP2Error FramePayload -&gt; IO FramePayload)
-&gt; Either HTTP2Error FramePayload -&gt; IO FramePayload
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FramePayloadDecoder
</span><a href="Network.HTTP2.Frame.Decode.html#decodeWindowUpdateFrame"><span class="hs-identifier hs-var">decodeWindowUpdateFrame</span></a></span><span> </span><span class="annot"><span class="annottext">FrameHeader
</span><a href="#local-6989586621679092393"><span class="hs-identifier hs-var">header</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092391"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-438"></span><span>    </span><span id="local-6989586621679092386"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092386"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM Int -&gt; IO Int
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM Int -&gt; IO Int) -&gt; STM Int -&gt; IO Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-439"></span><span>      </span><span id="local-6989586621679092385"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092385"><span class="hs-identifier hs-var">w0</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar Int -&gt; STM Int
forall a. TVar a -&gt; STM a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar Int
</span><a href="#local-6989586621679092389"><span class="hs-identifier hs-var">streamWindow</span></a></span><span>
</span><span id="line-440"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679092384"><span class="annot"><span class="annottext">w1 :: Int
</span><a href="#local-6989586621679092384"><span class="hs-identifier hs-var hs-var">w1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092385"><span class="hs-identifier hs-var">w0</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092387"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-441"></span><span>      </span><span class="annot"><span class="annottext">TVar Int -&gt; Int -&gt; STM ()
forall a. TVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar Int
</span><a href="#local-6989586621679092389"><span class="hs-identifier hs-var">streamWindow</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092384"><span class="hs-identifier hs-var">w1</span></a></span><span>
</span><span id="line-442"></span><span>      </span><span class="annot"><span class="annottext">Int -&gt; STM Int
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092384"><span class="hs-identifier hs-var">w1</span></a></span><span>
</span><span id="line-443"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Bool
</span><a href="Network.HTTP2.Frame.Types.html#isWindowOverflow"><span class="hs-identifier hs-var">isWindowOverflow</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092386"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO ()
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO ()) -&gt; HTTP2Error -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId -&gt; Int -&gt; HTTP2Error
</span><a href="Network.HTTP2.Frame.Types.html#StreamError"><span class="hs-identifier hs-var">StreamError</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId
</span><a href="Network.HTTP2.Frame.Types.html#FlowControlError"><span class="hs-identifier hs-var">FlowControlError</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092392"><span class="hs-identifier hs-var">streamId</span></a></span><span>
</span><span id="line-444"></span><span>    </span><span class="annot"><span class="annottext">StreamState -&gt; IO StreamState
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">StreamState
</span><a href="#local-6989586621679092390"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-445"></span><span>
</span><span id="line-446"></span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#stream"><span class="hs-identifier hs-var">stream</span></a></span><span> </span><span class="annot"><span class="annottext">FrameTypeId
</span><a href="Network.HTTP2.Frame.Types.html#FrameRSTStream"><span class="hs-identifier hs-var">FrameRSTStream</span></a></span><span> </span><span id="local-6989586621679092383"><span class="annot"><span class="annottext">FrameHeader
</span><a href="#local-6989586621679092383"><span class="hs-identifier hs-var">header</span></a></span></span><span> </span><span id="local-6989586621679092382"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092382"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621679092381"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679092381"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="annot"><span class="annottext">StreamState
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679092380"><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679092380"><span class="hs-identifier hs-var">strm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-447"></span><span>    </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#RSTStreamFrame"><span class="hs-identifier hs-type">RSTStreamFrame</span></a></span><span> </span><span id="local-6989586621679092378"><span class="annot"><span class="annottext">ErrorCodeId
</span><a href="#local-6989586621679092378"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Either HTTP2Error FramePayload -&gt; IO FramePayload
forall a. Either HTTP2Error a -&gt; IO a
</span><a href="Network.HTTP2.Arch.Receiver.html#guardIt"><span class="hs-identifier hs-var">guardIt</span></a></span><span> </span><span class="annot"><span class="annottext">(Either HTTP2Error FramePayload -&gt; IO FramePayload)
-&gt; Either HTTP2Error FramePayload -&gt; IO FramePayload
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FramePayloadDecoder
</span><a href="Network.HTTP2.Frame.Decode.html#decoderstStreamFrame"><span class="hs-identifier hs-var">decoderstStreamFrame</span></a></span><span> </span><span class="annot"><span class="annottext">FrameHeader
</span><a href="#local-6989586621679092383"><span class="hs-identifier hs-var">header</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092382"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-448"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679092376"><span class="annot"><span class="annottext">cc :: ClosedCode
</span><a href="#local-6989586621679092376"><span class="hs-identifier hs-var hs-var">cc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ErrorCodeId -&gt; ClosedCode
</span><a href="Network.HTTP2.Arch.Types.html#Reset"><span class="hs-identifier hs-var">Reset</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId
</span><a href="#local-6989586621679092378"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-449"></span><span>    </span><span class="annot"><span class="annottext">Context -&gt; Stream -&gt; ClosedCode -&gt; IO ()
</span><a href="Network.HTTP2.Arch.Context.html#closed"><span class="hs-identifier hs-var">closed</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679092381"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679092380"><span class="hs-identifier hs-var">strm</span></a></span><span> </span><span class="annot"><span class="annottext">ClosedCode
</span><a href="#local-6989586621679092376"><span class="hs-identifier hs-var">cc</span></a></span><span>
</span><span id="line-450"></span><span>    </span><span class="annot"><span class="annottext">StreamState -&gt; IO StreamState
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(StreamState -&gt; IO StreamState) -&gt; StreamState -&gt; IO StreamState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ClosedCode -&gt; StreamState
</span><a href="Network.HTTP2.Arch.Types.html#Closed"><span class="hs-identifier hs-var">Closed</span></a></span><span> </span><span class="annot"><span class="annottext">ClosedCode
</span><a href="#local-6989586621679092376"><span class="hs-identifier hs-var">cc</span></a></span><span> </span><span class="hs-comment">-- will be written to streamState again</span><span>
</span><span id="line-451"></span><span>
</span><span id="line-452"></span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#stream"><span class="hs-identifier hs-var">stream</span></a></span><span> </span><span class="annot"><span class="annottext">FrameTypeId
</span><a href="Network.HTTP2.Frame.Types.html#FramePriority"><span class="hs-identifier hs-var">FramePriority</span></a></span><span> </span><span id="local-6989586621679092372"><span class="annot"><span class="annottext">FrameHeader
</span><a href="#local-6989586621679092372"><span class="hs-identifier hs-var">header</span></a></span></span><span> </span><span id="local-6989586621679092371"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092371"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="annot"><span class="annottext">Context
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679092370"><span class="annot"><span class="annottext">StreamState
</span><a href="#local-6989586621679092370"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="annot"><a href="Network.HTTP2.Arch.Types.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span class="hs-special">{</span><span id="local-6989586621679092369"><span class="annot"><span class="annottext">Int
streamNumber :: Int
streamNumber :: Stream -&gt; Int
</span><a href="#local-6989586621679092369"><span class="hs-identifier hs-var hs-var">streamNumber</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-453"></span><span>    </span><span class="hs-comment">-- ignore</span><span>
</span><span id="line-454"></span><span>    </span><span class="hs-comment">-- Resource Loop - CVE-2019-9513</span><span>
</span><span id="line-455"></span><span>    </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#PriorityFrame"><span class="hs-identifier hs-type">PriorityFrame</span></a></span><span> </span><span id="local-6989586621679092368"><span class="annot"><span class="annottext">Priority
</span><a href="#local-6989586621679092368"><span class="hs-identifier hs-var">newpri</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Either HTTP2Error FramePayload -&gt; IO FramePayload
forall a. Either HTTP2Error a -&gt; IO a
</span><a href="Network.HTTP2.Arch.Receiver.html#guardIt"><span class="hs-identifier hs-var">guardIt</span></a></span><span> </span><span class="annot"><span class="annottext">(Either HTTP2Error FramePayload -&gt; IO FramePayload)
-&gt; Either HTTP2Error FramePayload -&gt; IO FramePayload
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FramePayloadDecoder
</span><a href="Network.HTTP2.Frame.Decode.html#decodePriorityFrame"><span class="hs-identifier hs-var">decodePriorityFrame</span></a></span><span> </span><span class="annot"><span class="annottext">FrameHeader
</span><a href="#local-6989586621679092372"><span class="hs-identifier hs-var">header</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092371"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-456"></span><span>    </span><span class="annot"><span class="annottext">Priority -&gt; Int -&gt; IO ()
</span><a href="Network.HTTP2.Arch.Receiver.html#checkPriority"><span class="hs-identifier hs-var">checkPriority</span></a></span><span> </span><span class="annot"><span class="annottext">Priority
</span><a href="#local-6989586621679092368"><span class="hs-identifier hs-var">newpri</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092369"><span class="hs-identifier hs-var">streamNumber</span></a></span><span>
</span><span id="line-457"></span><span>    </span><span class="annot"><span class="annottext">StreamState -&gt; IO StreamState
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">StreamState
</span><a href="#local-6989586621679092370"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-458"></span><span>
</span><span id="line-459"></span><span class="hs-comment">-- this ordering is important</span><span>
</span><span id="line-460"></span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#stream"><span class="hs-identifier hs-var">stream</span></a></span><span> </span><span class="annot"><span class="annottext">FrameTypeId
</span><a href="Network.HTTP2.Frame.Types.html#FrameContinuation"><span class="hs-identifier hs-var">FrameContinuation</span></a></span><span> </span><span class="annot"><span class="annottext">FrameHeader
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Context
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StreamState
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Stream
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO StreamState
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO StreamState) -&gt; HTTP2Error -&gt; IO StreamState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId -&gt; ByteString -&gt; HTTP2Error
</span><a href="Network.HTTP2.Frame.Types.html#ConnectionError"><span class="hs-identifier hs-var">ConnectionError</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId
</span><a href="Network.HTTP2.Frame.Types.html#ProtocolError"><span class="hs-identifier hs-var">ProtocolError</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;continue frame cannot come here&quot;</span></span><span>
</span><span id="line-461"></span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#stream"><span class="hs-identifier hs-var">stream</span></a></span><span> </span><span class="annot"><span class="annottext">FrameTypeId
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">FrameHeader
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Context
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.Arch.Types.html#Open"><span class="hs-identifier hs-type">Open</span></a></span><span> </span><span class="annot"><a href="Network.HTTP2.Arch.Types.html#Continued"><span class="hs-identifier hs-type">Continued</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stream
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO StreamState
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO StreamState) -&gt; HTTP2Error -&gt; IO StreamState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId -&gt; ByteString -&gt; HTTP2Error
</span><a href="Network.HTTP2.Frame.Types.html#ConnectionError"><span class="hs-identifier hs-var">ConnectionError</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId
</span><a href="Network.HTTP2.Frame.Types.html#ProtocolError"><span class="hs-identifier hs-var">ProtocolError</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;an illegal frame follows header/continuation frames&quot;</span></span><span>
</span><span id="line-462"></span><span class="hs-comment">-- Ignore frames to streams we have just reset, per section 5.1.</span><span>
</span><span id="line-463"></span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#stream"><span class="hs-identifier hs-var">stream</span></a></span><span> </span><span class="annot"><span class="annottext">FrameTypeId
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">FrameHeader
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Context
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679092367"><span class="annot"><span class="annottext">st :: StreamState
</span><a href="#local-6989586621679092367"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.Arch.Types.html#Closed"><span class="hs-identifier hs-type">Closed</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.Arch.Types.html#ResetByMe"><span class="hs-identifier hs-type">ResetByMe</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stream
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StreamState -&gt; IO StreamState
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">StreamState
</span><a href="#local-6989586621679092367"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-464"></span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#stream"><span class="hs-identifier hs-var">stream</span></a></span><span> </span><span class="annot"><span class="annottext">FrameTypeId
</span><a href="Network.HTTP2.Frame.Types.html#FrameData"><span class="hs-identifier hs-var">FrameData</span></a></span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameHeader"><span class="hs-identifier hs-type">FrameHeader</span></a></span><span class="hs-special">{</span><span id="local-6989586621679092365"><span class="annot"><span class="annottext">Int
streamId :: Int
streamId :: FrameHeader -&gt; Int
</span><a href="#local-6989586621679092365"><span class="hs-identifier hs-var hs-var">streamId</span></a></span></span><span class="hs-special">}</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Context
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StreamState
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Stream
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO StreamState
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO StreamState) -&gt; HTTP2Error -&gt; IO StreamState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId -&gt; Int -&gt; HTTP2Error
</span><a href="Network.HTTP2.Frame.Types.html#StreamError"><span class="hs-identifier hs-var">StreamError</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId
</span><a href="Network.HTTP2.Frame.Types.html#StreamClosed"><span class="hs-identifier hs-var">StreamClosed</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092365"><span class="hs-identifier hs-var">streamId</span></a></span><span>
</span><span id="line-465"></span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#stream"><span class="hs-identifier hs-var">stream</span></a></span><span> </span><span class="annot"><span class="annottext">FrameTypeId
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameHeader"><span class="hs-identifier hs-type">FrameHeader</span></a></span><span class="hs-special">{</span><span id="local-6989586621679092364"><span class="annot"><span class="annottext">Int
streamId :: Int
streamId :: FrameHeader -&gt; Int
</span><a href="#local-6989586621679092364"><span class="hs-identifier hs-var hs-var">streamId</span></a></span></span><span class="hs-special">}</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Context
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StreamState
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Stream
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO StreamState
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO StreamState) -&gt; HTTP2Error -&gt; IO StreamState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId -&gt; Int -&gt; HTTP2Error
</span><a href="Network.HTTP2.Frame.Types.html#StreamError"><span class="hs-identifier hs-var">StreamError</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCodeId
</span><a href="Network.HTTP2.Frame.Types.html#ProtocolError"><span class="hs-identifier hs-var">ProtocolError</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092364"><span class="hs-identifier hs-var">streamId</span></a></span><span>
</span><span id="line-466"></span><span>
</span><span id="line-467"></span><span class="hs-comment">----------------------------------------------------------------</span><span>
</span><span id="line-468"></span><span>
</span><span id="line-469"></span><span class="hs-comment">-- | Type for input streaming.</span><span>
</span><span id="line-470"></span><span class="hs-keyword">data</span><span> </span><span id="Source"><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#Source"><span class="hs-identifier hs-var">Source</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Source"><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#Source"><span class="hs-identifier hs-var">Source</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-471"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TQueue</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span class="hs-special">)</span><span>
</span><span id="line-472"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IORef</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span class="hs-special">)</span><span>
</span><span id="line-473"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IORef</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span>
</span><span id="line-474"></span><span>
</span><span id="line-475"></span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#mkSource"><span class="hs-identifier hs-type">mkSource</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TQueue</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#Source"><span class="hs-identifier hs-type">Source</span></a></span><span>
</span><span id="line-476"></span><span id="mkSource"><span class="annot"><span class="annottext">mkSource :: (Int -&gt; IO ()) -&gt; TQueue ByteString -&gt; IO Source
</span><a href="Network.HTTP2.Arch.Receiver.html#mkSource"><span class="hs-identifier hs-var hs-var">mkSource</span></a></span></span><span> </span><span id="local-6989586621679092362"><span class="annot"><span class="annottext">Int -&gt; IO ()
</span><a href="#local-6989586621679092362"><span class="hs-identifier hs-var">update</span></a></span></span><span> </span><span id="local-6989586621679092361"><span class="annot"><span class="annottext">TQueue ByteString
</span><a href="#local-6989586621679092361"><span class="hs-identifier hs-var">q</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Int -&gt; IO ())
-&gt; TQueue ByteString -&gt; IORef ByteString -&gt; IORef Bool -&gt; Source
</span><a href="Network.HTTP2.Arch.Receiver.html#Source"><span class="hs-identifier hs-var">Source</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO ()
</span><a href="#local-6989586621679092362"><span class="hs-identifier hs-var">update</span></a></span><span> </span><span class="annot"><span class="annottext">TQueue ByteString
</span><a href="#local-6989586621679092361"><span class="hs-identifier hs-var">q</span></a></span><span> </span><span class="annot"><span class="annottext">(IORef ByteString -&gt; IORef Bool -&gt; Source)
-&gt; IO (IORef ByteString) -&gt; IO (IORef Bool -&gt; Source)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; IO (IORef ByteString)
forall a. a -&gt; IO (IORef a)
</span><span class="hs-identifier hs-var">newIORef</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="annot"><span class="annottext">IO (IORef Bool -&gt; Source) -&gt; IO (IORef Bool) -&gt; IO Source
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IO (IORef Bool)
forall a. a -&gt; IO (IORef a)
</span><span class="hs-identifier hs-var">newIORef</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-477"></span><span>
</span><span id="line-478"></span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#updateWindow"><span class="hs-identifier hs-type">updateWindow</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TQueue</span></span><span> </span><span class="annot"><a href="Network.HTTP2.Arch.Types.html#Control"><span class="hs-identifier hs-type">Control</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#StreamId"><span class="hs-identifier hs-type">StreamId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-479"></span><span id="updateWindow"><span class="annot"><span class="annottext">updateWindow :: TQueue Control -&gt; Int -&gt; Int -&gt; IO ()
</span><a href="Network.HTTP2.Arch.Receiver.html#updateWindow"><span class="hs-identifier hs-var hs-var">updateWindow</span></a></span></span><span> </span><span class="annot"><span class="annottext">TQueue Control
</span><span class="hs-identifier">_</span></span><span>        </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span>   </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-480"></span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#updateWindow"><span class="hs-identifier hs-var">updateWindow</span></a></span><span> </span><span id="local-6989586621679092360"><span class="annot"><span class="annottext">TQueue Control
</span><a href="#local-6989586621679092360"><span class="hs-identifier hs-var">controlQ</span></a></span></span><span> </span><span id="local-6989586621679092359"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092359"><span class="hs-identifier hs-var">sid</span></a></span></span><span> </span><span id="local-6989586621679092358"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092358"><span class="hs-identifier hs-var">len</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TQueue Control -&gt; Control -&gt; IO ()
</span><a href="Network.HTTP2.Arch.Queue.html#enqueueControl"><span class="hs-identifier hs-var">enqueueControl</span></a></span><span> </span><span class="annot"><span class="annottext">TQueue Control
</span><a href="#local-6989586621679092360"><span class="hs-identifier hs-var">controlQ</span></a></span><span> </span><span class="annot"><span class="annottext">(Control -&gt; IO ()) -&gt; Control -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Control
</span><a href="Network.HTTP2.Arch.Types.html#CFrame"><span class="hs-identifier hs-var">CFrame</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092357"><span class="hs-identifier hs-var">frame</span></a></span><span>
</span><span id="line-481"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-482"></span><span>    </span><span id="local-6989586621679092356"><span class="annot"><span class="annottext">frame1 :: ByteString
</span><a href="#local-6989586621679092356"><span class="hs-identifier hs-var hs-var">frame1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; ByteString
</span><a href="Network.HTTP2.Arch.EncodeFrame.html#windowUpdateFrame"><span class="hs-identifier hs-var">windowUpdateFrame</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092358"><span class="hs-identifier hs-var">len</span></a></span><span>
</span><span id="line-483"></span><span>    </span><span id="local-6989586621679092355"><span class="annot"><span class="annottext">frame2 :: ByteString
</span><a href="#local-6989586621679092355"><span class="hs-identifier hs-var hs-var">frame2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; ByteString
</span><a href="Network.HTTP2.Arch.EncodeFrame.html#windowUpdateFrame"><span class="hs-identifier hs-var">windowUpdateFrame</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092359"><span class="hs-identifier hs-var">sid</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092358"><span class="hs-identifier hs-var">len</span></a></span><span>
</span><span id="line-484"></span><span>    </span><span id="local-6989586621679092357"><span class="annot"><span class="annottext">frame :: ByteString
</span><a href="#local-6989586621679092357"><span class="hs-identifier hs-var hs-var">frame</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092356"><span class="hs-identifier hs-var">frame1</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString -&gt; ByteString
</span><span class="hs-operator hs-var">`BS.append`</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092355"><span class="hs-identifier hs-var">frame2</span></a></span><span>
</span><span id="line-485"></span><span>
</span><span id="line-486"></span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#readSource"><span class="hs-identifier hs-type">readSource</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#Source"><span class="hs-identifier hs-type">Source</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span>
</span><span id="line-487"></span><span id="readSource"><span class="annot"><span class="annottext">readSource :: Source -&gt; IO ByteString
</span><a href="Network.HTTP2.Arch.Receiver.html#readSource"><span class="hs-identifier hs-var hs-var">readSource</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.Arch.Receiver.html#Source"><span class="hs-identifier hs-type">Source</span></a></span><span> </span><span id="local-6989586621679092354"><span class="annot"><span class="annottext">Int -&gt; IO ()
</span><a href="#local-6989586621679092354"><span class="hs-identifier hs-var">update</span></a></span></span><span> </span><span id="local-6989586621679092353"><span class="annot"><span class="annottext">TQueue ByteString
</span><a href="#local-6989586621679092353"><span class="hs-identifier hs-var">q</span></a></span></span><span> </span><span id="local-6989586621679092352"><span class="annot"><span class="annottext">IORef ByteString
</span><a href="#local-6989586621679092352"><span class="hs-identifier hs-var">refBS</span></a></span></span><span> </span><span id="local-6989586621679092351"><span class="annot"><span class="annottext">IORef Bool
</span><a href="#local-6989586621679092351"><span class="hs-identifier hs-var">refEOF</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-488"></span><span>    </span><span id="local-6989586621679092350"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679092350"><span class="hs-identifier hs-var">eof</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef Bool -&gt; IO Bool
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef Bool
</span><a href="#local-6989586621679092351"><span class="hs-identifier hs-var">refEOF</span></a></span><span>
</span><span id="line-489"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679092350"><span class="hs-identifier hs-var">eof</span></a></span><span> </span><span class="hs-keyword">then</span><span>
</span><span id="line-490"></span><span>        </span><span class="annot"><span class="annottext">ByteString -&gt; IO ByteString
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;&quot;</span></span><span>
</span><span id="line-491"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-492"></span><span>        </span><span id="local-6989586621679092349"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092349"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO ByteString
</span><a href="#local-6989586621679092348"><span class="hs-identifier hs-var">readBS</span></a></span><span>
</span><span id="line-493"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679092347"><span class="annot"><span class="annottext">len :: Int
</span><a href="#local-6989586621679092347"><span class="hs-identifier hs-var hs-var">len</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><span class="hs-identifier hs-var">BS.length</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092349"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-494"></span><span>        </span><span class="annot"><span class="annottext">Int -&gt; IO ()
</span><a href="#local-6989586621679092354"><span class="hs-identifier hs-var">update</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679092347"><span class="hs-identifier hs-var">len</span></a></span><span>
</span><span id="line-495"></span><span>        </span><span class="annot"><span class="annottext">ByteString -&gt; IO ByteString
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092349"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-496"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-497"></span><span>    </span><span id="local-6989586621679092348"><span class="annot"><span class="annottext">readBS :: IO ByteString
</span><a href="#local-6989586621679092348"><span class="hs-identifier hs-var hs-var">readBS</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-498"></span><span>        </span><span id="local-6989586621679092346"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092346"><span class="hs-identifier hs-var">bs0</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef ByteString -&gt; IO ByteString
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef ByteString
</span><a href="#local-6989586621679092352"><span class="hs-identifier hs-var">refBS</span></a></span><span>
</span><span id="line-499"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092346"><span class="hs-identifier hs-var">bs0</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-500"></span><span>            </span><span id="local-6989586621679092345"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092345"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM ByteString -&gt; IO ByteString
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM ByteString -&gt; IO ByteString)
-&gt; STM ByteString -&gt; IO ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TQueue ByteString -&gt; STM ByteString
forall a. TQueue a -&gt; STM a
</span><span class="hs-identifier hs-var">readTQueue</span></span><span> </span><span class="annot"><span class="annottext">TQueue ByteString
</span><a href="#local-6989586621679092353"><span class="hs-identifier hs-var">q</span></a></span><span>
</span><span id="line-501"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092345"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IORef Bool -&gt; Bool -&gt; IO ()
forall a. IORef a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">writeIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef Bool
</span><a href="#local-6989586621679092351"><span class="hs-identifier hs-var">refEOF</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-502"></span><span>            </span><span class="annot"><span class="annottext">ByteString -&gt; IO ByteString
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092345"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-503"></span><span>          </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-504"></span><span>            </span><span class="annot"><span class="annottext">IORef ByteString -&gt; ByteString -&gt; IO ()
forall a. IORef a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">writeIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef ByteString
</span><a href="#local-6989586621679092352"><span class="hs-identifier hs-var">refBS</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;&quot;</span></span><span>
</span><span id="line-505"></span><span>            </span><span class="annot"><span class="annottext">ByteString -&gt; IO ByteString
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679092346"><span class="hs-identifier hs-var">bs0</span></a></span><span>
</span><span id="line-506"></span></pre></body></html>