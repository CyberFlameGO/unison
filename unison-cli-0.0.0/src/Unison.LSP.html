<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DataKinds #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE PolyKinds #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE RecordWildCards #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE TypeOperators #-}</span><span>
</span><span id="line-5"></span><span>
</span><span id="line-6"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Unison.LSP</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-7"></span><span>
</span><span id="line-8"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Colog.Core</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">LogAction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">LogAction</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-9"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Colog.Core</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Colog</span></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Reader</span></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Aeson</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Options</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">defaultOptions</span></span><span class="hs-special">)</span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Ki</span></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Language.LSP.Logging</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">LSP</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Language.LSP.Server</span></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Language.LSP.Types</span></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Language.LSP.Types.SMethodMap</span></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Language.LSP.Types.SMethodMap</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">SMM</span></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Language.LSP.VFS</span></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Network.Simple.TCP</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TCP</span></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Network.Socket</span></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.Environment</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">lookupEnv</span></span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Codebase</span></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Codebase.Branch</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Branch</span></span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Codebase.Path</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Path</span></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Codebase.Runtime</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Runtime</span></span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Unison.LSP.FileAnalysis.html"><span class="hs-identifier">Unison.LSP.FileAnalysis</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Analysis</span></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.LSP.Hover.html"><span class="hs-identifier">Unison.LSP.Hover</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.LSP.Hover.html#hoverHandler"><span class="hs-identifier">hoverHandler</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.LSP.NotificationHandlers.html"><span class="hs-identifier">Unison.LSP.NotificationHandlers</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Notifications</span></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.LSP.Orphans.html"><span class="hs-identifier">Unison.LSP.Orphans</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.LSP.Types.html"><span class="hs-identifier">Unison.LSP.Types</span></a></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.LSP.UCMWorker.html"><span class="hs-identifier">Unison.LSP.UCMWorker</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.LSP.UCMWorker.html#ucmWorker"><span class="hs-identifier">ucmWorker</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Unison.LSP.VFS.html"><span class="hs-identifier">Unison.LSP.VFS</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">VFS</span></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Parser.Ann</span></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Prelude</span></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Unison.PrettyPrintEnvDecl</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">PPED</span></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Symbol</span></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">UnliftIO</span></span><span>
</span><span id="line-38"></span><span>
</span><span id="line-39"></span><span class="annot"><a href="Unison.LSP.html#getLspPort"><span class="hs-identifier hs-type">getLspPort</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-40"></span><span id="getLspPort"><span class="annot"><span class="annottext">getLspPort :: IO String
</span><a href="Unison.LSP.html#getLspPort"><span class="hs-identifier hs-var hs-var">getLspPort</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe String -&gt; String
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;5757&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Maybe String -&gt; String) -&gt; IO (Maybe String) -&gt; IO String
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; IO (Maybe String)
</span><span class="hs-identifier hs-var">lookupEnv</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;UNISON_LSP_PORT&quot;</span></span><span>
</span><span id="line-41"></span><span>
</span><span id="line-42"></span><span class="hs-comment">-- | Spawn an LSP server on the configured port.</span><span>
</span><span id="line-43"></span><span class="annot"><a href="Unison.LSP.html#spawnLsp"><span class="hs-identifier hs-type">spawnLsp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Codebase</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Runtime</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Branch</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Path.Absolute</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span id="spawnLsp"><span class="annot"><span class="annottext">spawnLsp :: Codebase IO Symbol Ann
-&gt; Runtime Symbol -&gt; STM (Branch IO, Absolute) -&gt; IO ()
</span><a href="Unison.LSP.html#spawnLsp"><span class="hs-identifier hs-var hs-var">spawnLsp</span></a></span></span><span> </span><span id="local-6989586621679407569"><span class="annot"><span class="annottext">Codebase IO Symbol Ann
</span><a href="#local-6989586621679407569"><span class="hs-identifier hs-var">codebase</span></a></span></span><span> </span><span id="local-6989586621679407568"><span class="annot"><span class="annottext">Runtime Symbol
</span><a href="#local-6989586621679407568"><span class="hs-identifier hs-var">runtime</span></a></span></span><span> </span><span id="local-6989586621679407567"><span class="annot"><span class="annottext">STM (Branch IO, Absolute)
</span><a href="#local-6989586621679407567"><span class="hs-identifier hs-var">ucmState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall a. IO a -&gt; IO a
</span><span class="hs-identifier hs-var">withSocketsDo</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-45"></span><span>  </span><span id="local-6989586621679407565"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679407565"><span class="hs-identifier hs-var">lspPort</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO String
</span><a href="Unison.LSP.html#getLspPort"><span class="hs-identifier hs-var">getLspPort</span></a></span><span>
</span><span id="line-46"></span><span>  </span><span class="annot"><span class="annottext">HostPreference -&gt; String -&gt; ((Socket, SockAddr) -&gt; IO ()) -&gt; IO ()
forall (m :: * -&gt; *) a.
MonadIO m =&gt;
HostPreference -&gt; String -&gt; ((Socket, SockAddr) -&gt; IO ()) -&gt; m a
</span><span class="hs-identifier hs-var">TCP.serve</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; HostPreference
</span><span class="hs-identifier hs-var">TCP.Host</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;127.0.0.1&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679407565"><span class="hs-identifier hs-var">lspPort</span></a></span><span> </span><span class="annot"><span class="annottext">(((Socket, SockAddr) -&gt; IO ()) -&gt; IO ())
-&gt; ((Socket, SockAddr) -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679407562"><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621679407562"><span class="hs-identifier hs-var">sock</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679407561"><span class="annot"><span class="annottext">SockAddr
</span><a href="#local-6989586621679407561"><span class="hs-identifier hs-var">_sockaddr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-47"></span><span>    </span><span id="local-6989586621679407560"><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679407560"><span class="hs-identifier hs-var">sockHandle</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Socket -&gt; IOMode -&gt; IO Handle
</span><span class="hs-identifier hs-var">socketToHandle</span></span><span> </span><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621679407562"><span class="hs-identifier hs-var">sock</span></a></span><span> </span><span class="annot"><span class="annottext">IOMode
</span><span class="hs-identifier hs-var">ReadWriteMode</span></span><span>
</span><span id="line-48"></span><span>    </span><span class="annot"><span class="annottext">(Scope -&gt; IO ()) -&gt; IO ()
forall a. (Scope -&gt; IO a) -&gt; IO a
</span><span class="hs-identifier hs-var">Ki.scoped</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679407556"><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621679407556"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-49"></span><span>      </span><span class="hs-comment">-- currently we have an independent VFS for each LSP client since each client might have</span><span>
</span><span id="line-50"></span><span>      </span><span class="hs-comment">-- different un-saved state for the same file.</span><span>
</span><span id="line-51"></span><span>      </span><span class="annot"><span class="annottext">(VFS -&gt; IO ()) -&gt; IO ()
forall r. (VFS -&gt; IO r) -&gt; IO r
</span><span class="hs-identifier hs-var">initVFS</span></span><span> </span><span class="annot"><span class="annottext">((VFS -&gt; IO ()) -&gt; IO ()) -&gt; (VFS -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679407554"><span class="annot"><span class="annottext">VFS
</span><a href="#local-6989586621679407554"><span class="hs-identifier hs-var">vfs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-52"></span><span>        </span><span id="local-6989586621679407553"><span class="annot"><span class="annottext">MVar VFS
</span><a href="#local-6989586621679407553"><span class="hs-identifier hs-var">vfsVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VFS -&gt; IO (MVar VFS)
forall (m :: * -&gt; *) a. MonadIO m =&gt; a -&gt; m (MVar a)
</span><span class="hs-identifier hs-var">newMVar</span></span><span> </span><span class="annot"><span class="annottext">VFS
</span><a href="#local-6989586621679407554"><span class="hs-identifier hs-var">vfs</span></a></span><span>
</span><span id="line-53"></span><span>        </span><span class="annot"><span class="annottext">IO Int -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(IO Int -&gt; IO ()) -&gt; IO Int -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LogAction IO (WithSeverity LspServerLog)
-&gt; LogAction (LspM Config) (WithSeverity LspServerLog)
-&gt; Handle
-&gt; Handle
-&gt; ServerDefinition Config
-&gt; IO Int
forall config.
LogAction IO (WithSeverity LspServerLog)
-&gt; LogAction (LspM config) (WithSeverity LspServerLog)
-&gt; Handle
-&gt; Handle
-&gt; ServerDefinition config
-&gt; IO Int
</span><span class="hs-identifier hs-var">runServerWithHandles</span></span><span> </span><span class="annot"><span class="annottext">LogAction IO (WithSeverity LspServerLog)
</span><a href="#local-6989586621679407549"><span class="hs-identifier hs-var">lspServerLogger</span></a></span><span> </span><span class="annot"><span class="annottext">LogAction (LspM Config) (WithSeverity LspServerLog)
</span><a href="#local-6989586621679407548"><span class="hs-identifier hs-var">lspClientLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679407560"><span class="hs-identifier hs-var">sockHandle</span></a></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679407560"><span class="hs-identifier hs-var">sockHandle</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MVar VFS
-&gt; Codebase IO Symbol Ann
-&gt; Runtime Symbol
-&gt; Scope
-&gt; STM (Branch IO, Absolute)
-&gt; ServerDefinition Config
</span><a href="Unison.LSP.html#serverDefinition"><span class="hs-identifier hs-var">serverDefinition</span></a></span><span> </span><span class="annot"><span class="annottext">MVar VFS
</span><a href="#local-6989586621679407553"><span class="hs-identifier hs-var">vfsVar</span></a></span><span> </span><span class="annot"><span class="annottext">Codebase IO Symbol Ann
</span><a href="#local-6989586621679407569"><span class="hs-identifier hs-var">codebase</span></a></span><span> </span><span class="annot"><span class="annottext">Runtime Symbol
</span><a href="#local-6989586621679407568"><span class="hs-identifier hs-var">runtime</span></a></span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621679407556"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="annot"><span class="annottext">STM (Branch IO, Absolute)
</span><a href="#local-6989586621679407567"><span class="hs-identifier hs-var">ucmState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-55"></span><span>    </span><span class="hs-comment">-- Where to send logs that occur before a client connects</span><span>
</span><span id="line-56"></span><span>    </span><span id="local-6989586621679407549"><span class="annot"><span class="annottext">lspServerLogger :: LogAction IO (WithSeverity LspServerLog)
</span><a href="#local-6989586621679407549"><span class="hs-identifier hs-var hs-var">lspServerLogger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Severity
-&gt; (WithSeverity LspServerLog -&gt; Severity)
-&gt; LogAction IO (WithSeverity LspServerLog)
-&gt; LogAction IO (WithSeverity LspServerLog)
forall (m :: * -&gt; *) a.
Applicative m =&gt;
Severity -&gt; (a -&gt; Severity) -&gt; LogAction m a -&gt; LogAction m a
</span><span class="hs-identifier hs-var">Colog.filterBySeverity</span></span><span> </span><span class="annot"><span class="annottext">Severity
</span><span class="hs-identifier hs-var">Colog.Error</span></span><span> </span><span class="annot"><span class="annottext">WithSeverity LspServerLog -&gt; Severity
forall msg. WithSeverity msg -&gt; Severity
</span><span class="hs-identifier hs-var hs-var">Colog.getSeverity</span></span><span> </span><span class="annot"><span class="annottext">(LogAction IO (WithSeverity LspServerLog)
 -&gt; LogAction IO (WithSeverity LspServerLog))
-&gt; LogAction IO (WithSeverity LspServerLog)
-&gt; LogAction IO (WithSeverity LspServerLog)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(WithSeverity LspServerLog -&gt; WithSeverity Text)
-&gt; LogAction IO (WithSeverity Text)
-&gt; LogAction IO (WithSeverity LspServerLog)
forall a b (m :: * -&gt; *).
(a -&gt; b) -&gt; LogAction m b -&gt; LogAction m a
</span><span class="hs-identifier hs-var">Colog.cmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(LspServerLog -&gt; Text)
-&gt; WithSeverity LspServerLog -&gt; WithSeverity Text
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">LspServerLog -&gt; Text
forall a. Show a =&gt; a -&gt; Text
</span><span class="hs-identifier hs-var">tShow</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(WithSeverity Text -&gt; IO ()) -&gt; LogAction IO (WithSeverity Text)
forall (m :: * -&gt; *) msg. (msg -&gt; m ()) -&gt; LogAction m msg
</span><span class="hs-identifier hs-var">LogAction</span></span><span> </span><span class="annot"><span class="annottext">WithSeverity Text -&gt; IO ()
forall a. Show a =&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">print</span></span><span class="hs-special">)</span><span>
</span><span id="line-57"></span><span>    </span><span class="hs-comment">-- Where to send logs that occur after a client connects</span><span>
</span><span id="line-58"></span><span>    </span><span id="local-6989586621679407548"><span class="annot"><span class="annottext">lspClientLogger :: LogAction (LspM Config) (WithSeverity LspServerLog)
</span><a href="#local-6989586621679407548"><span class="hs-identifier hs-var hs-var">lspClientLogger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(WithSeverity LspServerLog -&gt; WithSeverity Text)
-&gt; LogAction (LspM Config) (WithSeverity Text)
-&gt; LogAction (LspM Config) (WithSeverity LspServerLog)
forall a b (m :: * -&gt; *).
(a -&gt; b) -&gt; LogAction m b -&gt; LogAction m a
</span><span class="hs-identifier hs-var">Colog.cmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(LspServerLog -&gt; Text)
-&gt; WithSeverity LspServerLog -&gt; WithSeverity Text
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">LspServerLog -&gt; Text
forall a. Show a =&gt; a -&gt; Text
</span><span class="hs-identifier hs-var">tShow</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LogAction (LspM Config) (WithSeverity Text)
forall c (m :: * -&gt; *).
MonadLsp c m =&gt;
LogAction m (WithSeverity Text)
</span><span class="hs-identifier hs-var">LSP.defaultClientLogger</span></span><span>
</span><span id="line-59"></span><span>
</span><span id="line-60"></span><span class="annot"><a href="Unison.LSP.html#serverDefinition"><span class="hs-identifier hs-type">serverDefinition</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-61"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">MVar</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">VFS</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-62"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Codebase</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-63"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Runtime</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-64"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Ki.Scope</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-65"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Branch</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Path.Absolute</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-66"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">ServerDefinition</span></span><span> </span><span class="annot"><a href="Unison.LSP.Types.html#Config"><span class="hs-identifier hs-type">Config</span></a></span><span>
</span><span id="line-67"></span><span id="serverDefinition"><span class="annot"><span class="annottext">serverDefinition :: MVar VFS
-&gt; Codebase IO Symbol Ann
-&gt; Runtime Symbol
-&gt; Scope
-&gt; STM (Branch IO, Absolute)
-&gt; ServerDefinition Config
</span><a href="Unison.LSP.html#serverDefinition"><span class="hs-identifier hs-var hs-var">serverDefinition</span></a></span></span><span> </span><span id="local-6989586621679407540"><span class="annot"><span class="annottext">MVar VFS
</span><a href="#local-6989586621679407540"><span class="hs-identifier hs-var">vfsVar</span></a></span></span><span> </span><span id="local-6989586621679407539"><span class="annot"><span class="annottext">Codebase IO Symbol Ann
</span><a href="#local-6989586621679407539"><span class="hs-identifier hs-var">codebase</span></a></span></span><span> </span><span id="local-6989586621679407538"><span class="annot"><span class="annottext">Runtime Symbol
</span><a href="#local-6989586621679407538"><span class="hs-identifier hs-var">runtime</span></a></span></span><span> </span><span id="local-6989586621679407537"><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621679407537"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span id="local-6989586621679407536"><span class="annot"><span class="annottext">STM (Branch IO, Absolute)
</span><a href="#local-6989586621679407536"><span class="hs-identifier hs-var">ucmState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-68"></span><span>  </span><span class="annot"><span class="annottext">ServerDefinition :: forall config (m :: * -&gt; *) a.
config
-&gt; (config -&gt; Value -&gt; Either Text config)
-&gt; (LanguageContextEnv config
    -&gt; Message 'Initialize -&gt; IO (Either ResponseError a))
-&gt; Handlers m
-&gt; (a -&gt; m &lt;~&gt; IO)
-&gt; Options
-&gt; ServerDefinition config
</span><span class="hs-identifier hs-type">ServerDefinition</span></span><span>
</span><span id="line-69"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">defaultConfig :: Config
</span><span class="hs-identifier hs-var">defaultConfig</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Config
</span><a href="Unison.LSP.html#lspDefaultConfig"><span class="hs-identifier hs-var">lspDefaultConfig</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-70"></span><span>      </span><span class="annot"><span class="annottext">onConfigurationChange :: Config -&gt; Value -&gt; Either Text Config
</span><span class="hs-identifier hs-var">onConfigurationChange</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Config -&gt; Value -&gt; Either Text Config
</span><a href="Unison.LSP.html#lspOnConfigurationChange"><span class="hs-identifier hs-var">lspOnConfigurationChange</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-71"></span><span>      </span><span class="annot"><span class="annottext">doInitialize :: LanguageContextEnv Config
-&gt; Message 'Initialize -&gt; IO (Either ResponseError Env)
</span><span class="hs-identifier hs-var">doInitialize</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MVar VFS
-&gt; Codebase IO Symbol Ann
-&gt; Runtime Symbol
-&gt; Scope
-&gt; STM (Branch IO, Absolute)
-&gt; LanguageContextEnv Config
-&gt; Message 'Initialize
-&gt; IO (Either ResponseError Env)
</span><a href="Unison.LSP.html#lspDoInitialize"><span class="hs-identifier hs-var">lspDoInitialize</span></a></span><span> </span><span class="annot"><span class="annottext">MVar VFS
</span><a href="#local-6989586621679407540"><span class="hs-identifier hs-var">vfsVar</span></a></span><span> </span><span class="annot"><span class="annottext">Codebase IO Symbol Ann
</span><a href="#local-6989586621679407539"><span class="hs-identifier hs-var">codebase</span></a></span><span> </span><span class="annot"><span class="annottext">Runtime Symbol
</span><a href="#local-6989586621679407538"><span class="hs-identifier hs-var">runtime</span></a></span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621679407537"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="annot"><span class="annottext">STM (Branch IO, Absolute)
</span><a href="#local-6989586621679407536"><span class="hs-identifier hs-var">ucmState</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-72"></span><span>      </span><span class="annot"><span class="annottext">staticHandlers :: Handlers Lsp
</span><span class="hs-identifier hs-var">staticHandlers</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Handlers Lsp
</span><a href="Unison.LSP.html#lspStaticHandlers"><span class="hs-identifier hs-var">lspStaticHandlers</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-73"></span><span>      </span><span class="annot"><span class="annottext">interpretHandler :: Env -&gt; Lsp &lt;~&gt; IO
</span><span class="hs-identifier hs-var">interpretHandler</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Env -&gt; Lsp &lt;~&gt; IO
</span><a href="Unison.LSP.html#lspInterpretHandler"><span class="hs-identifier hs-var">lspInterpretHandler</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-74"></span><span>      </span><span class="annot"><span class="annottext">options :: Options
</span><span class="hs-identifier hs-var">options</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="Unison.LSP.html#lspOptions"><span class="hs-identifier hs-var">lspOptions</span></a></span><span>
</span><span id="line-75"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-76"></span><span>
</span><span id="line-77"></span><span class="hs-comment">-- | Detect user LSP configuration changes.</span><span>
</span><span id="line-78"></span><span class="annot"><a href="Unison.LSP.html#lspOnConfigurationChange"><span class="hs-identifier hs-type">lspOnConfigurationChange</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Unison.LSP.Types.html#Config"><span class="hs-identifier hs-type">Config</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Value</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="annot"><a href="Unison.LSP.Types.html#Config"><span class="hs-identifier hs-type">Config</span></a></span><span>
</span><span id="line-79"></span><span id="lspOnConfigurationChange"><span class="annot"><span class="annottext">lspOnConfigurationChange :: Config -&gt; Value -&gt; Either Text Config
</span><a href="Unison.LSP.html#lspOnConfigurationChange"><span class="hs-identifier hs-var hs-var">lspOnConfigurationChange</span></a></span></span><span> </span><span class="annot"><span class="annottext">Config
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Value
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Config -&gt; Either Text Config
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Config
</span><a href="Unison.LSP.Types.html#Config"><span class="hs-identifier hs-var">Config</span></a></span><span>
</span><span id="line-80"></span><span>
</span><span id="line-81"></span><span class="annot"><a href="Unison.LSP.html#lspDefaultConfig"><span class="hs-identifier hs-type">lspDefaultConfig</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Unison.LSP.Types.html#Config"><span class="hs-identifier hs-type">Config</span></a></span><span>
</span><span id="line-82"></span><span id="lspDefaultConfig"><span class="annot"><span class="annottext">lspDefaultConfig :: Config
</span><a href="Unison.LSP.html#lspDefaultConfig"><span class="hs-identifier hs-var hs-var">lspDefaultConfig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Config
</span><a href="Unison.LSP.Types.html#Config"><span class="hs-identifier hs-var">Config</span></a></span><span>
</span><span id="line-83"></span><span>
</span><span id="line-84"></span><span class="hs-comment">-- | Initialize any context needed by the LSP server</span><span>
</span><span id="line-85"></span><span class="annot"><a href="Unison.LSP.html#lspDoInitialize"><span class="hs-identifier hs-type">lspDoInitialize</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-86"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">MVar</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">VFS</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-87"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Codebase</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-88"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Runtime</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-89"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Ki.Scope</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-90"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Branch</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Path.Absolute</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-91"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">LanguageContextEnv</span></span><span> </span><span class="annot"><a href="Unison.LSP.Types.html#Config"><span class="hs-identifier hs-type">Config</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-92"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Message</span></span><span> </span><span class="hs-special">'</span><span class="annot"><span class="hs-identifier hs-type">Initialize</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-93"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ResponseError</span></span><span> </span><span class="annot"><a href="Unison.LSP.Types.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-94"></span><span id="lspDoInitialize"><span class="annot"><span class="annottext">lspDoInitialize :: MVar VFS
-&gt; Codebase IO Symbol Ann
-&gt; Runtime Symbol
-&gt; Scope
-&gt; STM (Branch IO, Absolute)
-&gt; LanguageContextEnv Config
-&gt; Message 'Initialize
-&gt; IO (Either ResponseError Env)
</span><a href="Unison.LSP.html#lspDoInitialize"><span class="hs-identifier hs-var hs-var">lspDoInitialize</span></a></span></span><span> </span><span id="local-6989586621679407521"><span class="annot"><span class="annottext">MVar VFS
</span><a href="#local-6989586621679407521"><span class="hs-identifier hs-var">vfsVar</span></a></span></span><span> </span><span id="local-6989586621679407520"><span class="annot"><span class="annottext">Codebase IO Symbol Ann
</span><a href="#local-6989586621679407520"><span class="hs-identifier hs-var">codebase</span></a></span></span><span> </span><span id="local-6989586621679407519"><span class="annot"><span class="annottext">Runtime Symbol
</span><a href="#local-6989586621679407519"><span class="hs-identifier hs-var">runtime</span></a></span></span><span> </span><span id="local-6989586621679407518"><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621679407518"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span id="local-6989586621679407517"><span class="annot"><span class="annottext">STM (Branch IO, Absolute)
</span><a href="#local-6989586621679407517"><span class="hs-identifier hs-var">ucmState</span></a></span></span><span> </span><span id="local-6989586621679407516"><span class="annot"><span class="annottext">LanguageContextEnv Config
</span><a href="#local-6989586621679407516"><span class="hs-identifier hs-var">lspContext</span></a></span></span><span> </span><span id="local-6989586621679407515"><span class="annot"><span class="annottext">Message 'Initialize
</span><a href="#local-6989586621679407515"><span class="hs-identifier hs-var">_initMsg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-95"></span><span>  </span><span class="hs-comment">-- TODO: some of these should probably be MVars so that we correctly wait for names and</span><span>
</span><span id="line-96"></span><span>  </span><span class="hs-comment">-- things to be generated before serving requests.</span><span>
</span><span id="line-97"></span><span>  </span><span id="local-6989586621679407514"><span class="annot"><span class="annottext">TVar (Map Uri FileAnalysis)
</span><a href="#local-6989586621679407514"><span class="hs-identifier hs-var">checkedFilesVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Map Uri FileAnalysis -&gt; IO (TVar (Map Uri FileAnalysis))
forall (m :: * -&gt; *) a. MonadIO m =&gt; a -&gt; m (TVar a)
</span><span class="hs-identifier hs-var">newTVarIO</span></span><span> </span><span class="annot"><span class="annottext">Map Uri FileAnalysis
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-98"></span><span>  </span><span id="local-6989586621679407512"><span class="annot"><span class="annottext">TVar (Set Uri)
</span><a href="#local-6989586621679407512"><span class="hs-identifier hs-var">dirtyFilesVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Set Uri -&gt; IO (TVar (Set Uri))
forall (m :: * -&gt; *) a. MonadIO m =&gt; a -&gt; m (TVar a)
</span><span class="hs-identifier hs-var">newTVarIO</span></span><span> </span><span class="annot"><span class="annottext">Set Uri
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-99"></span><span>  </span><span id="local-6989586621679407511"><span class="annot"><span class="annottext">TVar PrettyPrintEnvDecl
</span><a href="#local-6989586621679407511"><span class="hs-identifier hs-var">ppeCacheVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PrettyPrintEnvDecl -&gt; IO (TVar PrettyPrintEnvDecl)
forall (m :: * -&gt; *) a. MonadIO m =&gt; a -&gt; m (TVar a)
</span><span class="hs-identifier hs-var">newTVarIO</span></span><span> </span><span class="annot"><span class="annottext">PrettyPrintEnvDecl
</span><span class="hs-identifier hs-var">PPED.empty</span></span><span>
</span><span id="line-100"></span><span>  </span><span id="local-6989586621679407509"><span class="annot"><span class="annottext">TVar NamesWithHistory
</span><a href="#local-6989586621679407509"><span class="hs-identifier hs-var">parseNamesCacheVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">NamesWithHistory -&gt; IO (TVar NamesWithHistory)
forall (m :: * -&gt; *) a. MonadIO m =&gt; a -&gt; m (TVar a)
</span><span class="hs-identifier hs-var">newTVarIO</span></span><span> </span><span class="annot"><span class="annottext">NamesWithHistory
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-101"></span><span>  </span><span id="local-6989586621679407508"><span class="annot"><span class="annottext">TVar Absolute
</span><a href="#local-6989586621679407508"><span class="hs-identifier hs-var">currentPathCacheVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Absolute -&gt; IO (TVar Absolute)
forall (m :: * -&gt; *) a. MonadIO m =&gt; a -&gt; m (TVar a)
</span><span class="hs-identifier hs-var">newTVarIO</span></span><span> </span><span class="annot"><span class="annottext">Absolute
</span><span class="hs-identifier hs-var">Path.absoluteEmpty</span></span><span>
</span><span id="line-102"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679407506"><span class="annot"><span class="annottext">env :: Env
</span><a href="#local-6989586621679407506"><span class="hs-identifier hs-var hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Env :: LanguageContextEnv Config
-&gt; Codebase IO Symbol Ann
-&gt; IO NamesWithHistory
-&gt; IO PrettyPrintEnvDecl
-&gt; IO Absolute
-&gt; MVar VFS
-&gt; Runtime Symbol
-&gt; TVar (Map Uri FileAnalysis)
-&gt; TVar (Set Uri)
-&gt; Scope
-&gt; Env
</span><a href="Unison.LSP.Types.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">$sel:ppeCache:Env :: IO PrettyPrintEnvDecl
</span><a href="Unison.LSP.Types.html#%24sel%3AppeCache%3AEnv"><span class="hs-identifier hs-var">ppeCache</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TVar PrettyPrintEnvDecl -&gt; IO PrettyPrintEnvDecl
forall (m :: * -&gt; *) a. MonadIO m =&gt; TVar a -&gt; m a
</span><span class="hs-identifier hs-var">readTVarIO</span></span><span> </span><span class="annot"><span class="annottext">TVar PrettyPrintEnvDecl
</span><a href="#local-6989586621679407511"><span class="hs-identifier hs-var">ppeCacheVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:parseNamesCache:Env :: IO NamesWithHistory
</span><a href="Unison.LSP.Types.html#%24sel%3AparseNamesCache%3AEnv"><span class="hs-identifier hs-var">parseNamesCache</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TVar NamesWithHistory -&gt; IO NamesWithHistory
forall (m :: * -&gt; *) a. MonadIO m =&gt; TVar a -&gt; m a
</span><span class="hs-identifier hs-var">readTVarIO</span></span><span> </span><span class="annot"><span class="annottext">TVar NamesWithHistory
</span><a href="#local-6989586621679407509"><span class="hs-identifier hs-var">parseNamesCacheVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:currentPathCache:Env :: IO Absolute
</span><a href="Unison.LSP.Types.html#%24sel%3AcurrentPathCache%3AEnv"><span class="hs-identifier hs-var">currentPathCache</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TVar Absolute -&gt; IO Absolute
forall (m :: * -&gt; *) a. MonadIO m =&gt; TVar a -&gt; m a
</span><span class="hs-identifier hs-var">readTVarIO</span></span><span> </span><span class="annot"><span class="annottext">TVar Absolute
</span><a href="#local-6989586621679407508"><span class="hs-identifier hs-var">currentPathCacheVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TVar (Map Uri FileAnalysis)
TVar (Set Uri)
MVar VFS
Scope
LanguageContextEnv Config
Codebase IO Symbol Ann
Runtime Symbol
$sel:scope:Env :: Scope
$sel:dirtyFilesVar:Env :: TVar (Set Uri)
$sel:checkedFilesVar:Env :: TVar (Map Uri FileAnalysis)
$sel:runtime:Env :: Runtime Symbol
$sel:vfsVar:Env :: MVar VFS
$sel:codebase:Env :: Codebase IO Symbol Ann
$sel:lspContext:Env :: LanguageContextEnv Config
dirtyFilesVar :: TVar (Set Uri)
checkedFilesVar :: TVar (Map Uri FileAnalysis)
lspContext :: LanguageContextEnv Config
scope :: Scope
runtime :: Runtime Symbol
codebase :: Codebase IO Symbol Ann
vfsVar :: MVar VFS
</span><a href="Unison.LSP.Types.html#%24sel%3Ascope%3AEnv"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-103"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679407493"><span class="annot"><span class="annottext">lspToIO :: Lsp () -&gt; IO ()
</span><a href="#local-6989586621679407493"><span class="hs-identifier hs-var hs-var">lspToIO</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ReaderT (LanguageContextEnv Config) IO ()
 -&gt; LanguageContextEnv Config -&gt; IO ())
-&gt; LanguageContextEnv Config
-&gt; ReaderT (LanguageContextEnv Config) IO ()
-&gt; IO ()
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">ReaderT (LanguageContextEnv Config) IO ()
-&gt; LanguageContextEnv Config -&gt; IO ()
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var hs-var">runReaderT</span></span><span> </span><span class="annot"><span class="annottext">LanguageContextEnv Config
</span><a href="#local-6989586621679407516"><span class="hs-identifier hs-var">lspContext</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT (LanguageContextEnv Config) IO () -&gt; IO ())
-&gt; (Lsp () -&gt; ReaderT (LanguageContextEnv Config) IO ())
-&gt; Lsp ()
-&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">LspT Config IO () -&gt; ReaderT (LanguageContextEnv Config) IO ()
forall config (m :: * -&gt; *) a.
LspT config m a -&gt; ReaderT (LanguageContextEnv config) m a
</span><span class="hs-identifier hs-var hs-var">unLspT</span></span><span> </span><span class="annot"><span class="annottext">(LspT Config IO () -&gt; ReaderT (LanguageContextEnv Config) IO ())
-&gt; (Lsp () -&gt; LspT Config IO ())
-&gt; Lsp ()
-&gt; ReaderT (LanguageContextEnv Config) IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(ReaderT Env (LspM Config) () -&gt; Env -&gt; LspT Config IO ())
-&gt; Env -&gt; ReaderT Env (LspM Config) () -&gt; LspT Config IO ()
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">ReaderT Env (LspM Config) () -&gt; Env -&gt; LspT Config IO ()
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var hs-var">runReaderT</span></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679407506"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT Env (LspM Config) () -&gt; LspT Config IO ())
-&gt; (Lsp () -&gt; ReaderT Env (LspM Config) ())
-&gt; Lsp ()
-&gt; LspT Config IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Lsp () -&gt; ReaderT Env (LspM Config) ()
forall a. Lsp a -&gt; ReaderT Env (LspM Config) a
</span><a href="Unison.LSP.Types.html#%24sel%3ArunLspM%3ALsp"><span class="hs-identifier hs-var hs-var">runLspM</span></a></span><span>
</span><span id="line-104"></span><span>  </span><span class="annot"><span class="annottext">Scope -&gt; IO () -&gt; IO (Thread ())
forall a. Scope -&gt; IO a -&gt; IO (Thread a)
</span><span class="hs-identifier hs-var">Ki.fork</span></span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621679407518"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lsp () -&gt; IO ()
</span><a href="#local-6989586621679407493"><span class="hs-identifier hs-var">lspToIO</span></a></span><span> </span><span class="annot"><span class="annottext">Lsp ()
</span><a href="Unison.LSP.FileAnalysis.html#fileAnalysisWorker"><span class="hs-identifier hs-var">Analysis.fileAnalysisWorker</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-105"></span><span>  </span><span class="annot"><span class="annottext">Scope -&gt; IO () -&gt; IO (Thread ())
forall a. Scope -&gt; IO a -&gt; IO (Thread a)
</span><span class="hs-identifier hs-var">Ki.fork</span></span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621679407518"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lsp () -&gt; IO ()
</span><a href="#local-6989586621679407493"><span class="hs-identifier hs-var">lspToIO</span></a></span><span> </span><span class="annot"><span class="annottext">(Lsp () -&gt; IO ()) -&gt; Lsp () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TVar PrettyPrintEnvDecl
-&gt; TVar NamesWithHistory -&gt; STM (Branch IO, Absolute) -&gt; Lsp ()
</span><a href="Unison.LSP.UCMWorker.html#ucmWorker"><span class="hs-identifier hs-var">ucmWorker</span></a></span><span> </span><span class="annot"><span class="annottext">TVar PrettyPrintEnvDecl
</span><a href="#local-6989586621679407511"><span class="hs-identifier hs-var">ppeCacheVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVar NamesWithHistory
</span><a href="#local-6989586621679407509"><span class="hs-identifier hs-var">parseNamesCacheVar</span></a></span><span> </span><span class="annot"><span class="annottext">STM (Branch IO, Absolute)
</span><a href="#local-6989586621679407517"><span class="hs-identifier hs-var">ucmState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-106"></span><span>  </span><span class="hs-identifier">pure</span><span> </span><span class="hs-operator">$</span><span> </span><span class="annot"><span class="annottext">Env -&gt; Either ResponseError Env
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">(Env -&gt; Either ResponseError Env)
-&gt; Env -&gt; Either ResponseError Env
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679407506"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-107"></span><span>
</span><span id="line-108"></span><span class="hs-comment">-- | LSP request handlers that don't register/unregister dynamically</span><span>
</span><span id="line-109"></span><span class="annot"><a href="Unison.LSP.html#lspStaticHandlers"><span class="hs-identifier hs-type">lspStaticHandlers</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Handlers</span></span><span> </span><span class="annot"><a href="Unison.LSP.Types.html#Lsp"><span class="hs-identifier hs-type">Lsp</span></a></span><span>
</span><span id="line-110"></span><span id="lspStaticHandlers"><span class="annot"><span class="annottext">lspStaticHandlers :: Handlers Lsp
</span><a href="Unison.LSP.html#lspStaticHandlers"><span class="hs-identifier hs-var hs-var">lspStaticHandlers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-111"></span><span>  </span><span class="annot"><span class="annottext">Handlers :: forall (m :: * -&gt; *).
SMethodMap (ClientMessageHandler m 'Request)
-&gt; SMethodMap (ClientMessageHandler m 'Notification) -&gt; Handlers m
</span><span class="hs-identifier hs-type">Handlers</span></span><span>
</span><span id="line-112"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">reqHandlers :: SMethodMap (ClientMessageHandler Lsp 'Request)
</span><span class="hs-identifier hs-var">reqHandlers</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SMethodMap (ClientMessageHandler Lsp 'Request)
</span><a href="Unison.LSP.html#lspRequestHandlers"><span class="hs-identifier hs-var">lspRequestHandlers</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-113"></span><span>      </span><span class="annot"><span class="annottext">notHandlers :: SMethodMap (ClientMessageHandler Lsp 'Notification)
</span><span class="hs-identifier hs-var">notHandlers</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SMethodMap (ClientMessageHandler Lsp 'Notification)
</span><a href="Unison.LSP.html#lspNotificationHandlers"><span class="hs-identifier hs-var">lspNotificationHandlers</span></a></span><span>
</span><span id="line-114"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-115"></span><span>
</span><span id="line-116"></span><span class="hs-comment">-- | LSP request handlers</span><span>
</span><span id="line-117"></span><span class="annot"><a href="Unison.LSP.html#lspRequestHandlers"><span class="hs-identifier hs-type">lspRequestHandlers</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SMethodMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ClientMessageHandler</span></span><span> </span><span class="annot"><a href="Unison.LSP.Types.html#Lsp"><span class="hs-identifier hs-type">Lsp</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><span class="hs-identifier hs-type">Request</span></span><span class="hs-special">)</span><span>
</span><span id="line-118"></span><span id="lspRequestHandlers"><span class="annot"><span class="annottext">lspRequestHandlers :: SMethodMap (ClientMessageHandler Lsp 'Request)
</span><a href="Unison.LSP.html#lspRequestHandlers"><span class="hs-identifier hs-var hs-var">lspRequestHandlers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-119"></span><span>  </span><span class="annot"><span class="annottext">SMethodMap (ClientMessageHandler Lsp 'Request)
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-120"></span><span>    </span><span class="annot"><span class="annottext">SMethodMap (ClientMessageHandler Lsp 'Request)
-&gt; (SMethodMap (ClientMessageHandler Lsp 'Request)
    -&gt; SMethodMap (ClientMessageHandler Lsp 'Request))
-&gt; SMethodMap (ClientMessageHandler Lsp 'Request)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">SMethod 'TextDocumentHover
-&gt; ClientMessageHandler Lsp 'Request 'TextDocumentHover
-&gt; SMethodMap (ClientMessageHandler Lsp 'Request)
-&gt; SMethodMap (ClientMessageHandler Lsp 'Request)
forall (f :: From) (t :: MethodType) (a :: Method f t)
       (v :: Method f t -&gt; *).
SMethod a -&gt; v a -&gt; SMethodMap v -&gt; SMethodMap v
</span><span class="hs-identifier hs-var">SMM.insert</span></span><span> </span><span class="annot"><span class="annottext">SMethod 'TextDocumentHover
</span><span class="hs-identifier hs-var">STextDocumentHover</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Handler Lsp 'TextDocumentHover
-&gt; ClientMessageHandler Lsp 'Request 'TextDocumentHover
forall (f :: * -&gt; *) (t :: MethodType) (m :: Method 'FromClient t).
Handler f m -&gt; ClientMessageHandler f t m
</span><span class="hs-identifier hs-var">ClientMessageHandler</span></span><span> </span><span class="annot"><span class="annottext">Handler Lsp 'TextDocumentHover
RequestMessage 'TextDocumentHover
-&gt; (Either ResponseError (ResponseResult 'TextDocumentHover)
    -&gt; Lsp ())
-&gt; Lsp ()
</span><a href="Unison.LSP.Hover.html#hoverHandler"><span class="hs-identifier hs-var">hoverHandler</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-121"></span><span>
</span><span id="line-122"></span><span class="hs-comment">-- &amp; SMM.insert STextDocumentCompletion (ClientMessageHandler completionHandler)</span><span>
</span><span id="line-123"></span><span>
</span><span id="line-124"></span><span class="hs-comment">-- | LSP notification handlers</span><span>
</span><span id="line-125"></span><span class="annot"><a href="Unison.LSP.html#lspNotificationHandlers"><span class="hs-identifier hs-type">lspNotificationHandlers</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SMethodMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ClientMessageHandler</span></span><span> </span><span class="annot"><a href="Unison.LSP.Types.html#Lsp"><span class="hs-identifier hs-type">Lsp</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><span class="hs-identifier hs-type">Notification</span></span><span class="hs-special">)</span><span>
</span><span id="line-126"></span><span id="lspNotificationHandlers"><span class="annot"><span class="annottext">lspNotificationHandlers :: SMethodMap (ClientMessageHandler Lsp 'Notification)
</span><a href="Unison.LSP.html#lspNotificationHandlers"><span class="hs-identifier hs-var hs-var">lspNotificationHandlers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-127"></span><span>  </span><span class="annot"><span class="annottext">SMethodMap (ClientMessageHandler Lsp 'Notification)
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-128"></span><span>    </span><span class="annot"><span class="annottext">SMethodMap (ClientMessageHandler Lsp 'Notification)
-&gt; (SMethodMap (ClientMessageHandler Lsp 'Notification)
    -&gt; SMethodMap (ClientMessageHandler Lsp 'Notification))
-&gt; SMethodMap (ClientMessageHandler Lsp 'Notification)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">SMethod 'TextDocumentDidOpen
-&gt; ClientMessageHandler Lsp 'Notification 'TextDocumentDidOpen
-&gt; SMethodMap (ClientMessageHandler Lsp 'Notification)
-&gt; SMethodMap (ClientMessageHandler Lsp 'Notification)
forall (f :: From) (t :: MethodType) (a :: Method f t)
       (v :: Method f t -&gt; *).
SMethod a -&gt; v a -&gt; SMethodMap v -&gt; SMethodMap v
</span><span class="hs-identifier hs-var">SMM.insert</span></span><span> </span><span class="annot"><span class="annottext">SMethod 'TextDocumentDidOpen
</span><span class="hs-identifier hs-var">STextDocumentDidOpen</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Handler Lsp 'TextDocumentDidOpen
-&gt; ClientMessageHandler Lsp 'Notification 'TextDocumentDidOpen
forall (f :: * -&gt; *) (t :: MethodType) (m :: Method 'FromClient t).
Handler f m -&gt; ClientMessageHandler f t m
</span><span class="hs-identifier hs-var">ClientMessageHandler</span></span><span> </span><span class="annot"><span class="annottext">Handler Lsp 'TextDocumentDidOpen
NotificationMessage 'TextDocumentDidOpen -&gt; Lsp ()
</span><a href="Unison.LSP.VFS.html#lspOpenFile"><span class="hs-identifier hs-var">VFS.lspOpenFile</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-129"></span><span>    </span><span class="annot"><span class="annottext">SMethodMap (ClientMessageHandler Lsp 'Notification)
-&gt; (SMethodMap (ClientMessageHandler Lsp 'Notification)
    -&gt; SMethodMap (ClientMessageHandler Lsp 'Notification))
-&gt; SMethodMap (ClientMessageHandler Lsp 'Notification)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">SMethod 'TextDocumentDidClose
-&gt; ClientMessageHandler Lsp 'Notification 'TextDocumentDidClose
-&gt; SMethodMap (ClientMessageHandler Lsp 'Notification)
-&gt; SMethodMap (ClientMessageHandler Lsp 'Notification)
forall (f :: From) (t :: MethodType) (a :: Method f t)
       (v :: Method f t -&gt; *).
SMethod a -&gt; v a -&gt; SMethodMap v -&gt; SMethodMap v
</span><span class="hs-identifier hs-var">SMM.insert</span></span><span> </span><span class="annot"><span class="annottext">SMethod 'TextDocumentDidClose
</span><span class="hs-identifier hs-var">STextDocumentDidClose</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Handler Lsp 'TextDocumentDidClose
-&gt; ClientMessageHandler Lsp 'Notification 'TextDocumentDidClose
forall (f :: * -&gt; *) (t :: MethodType) (m :: Method 'FromClient t).
Handler f m -&gt; ClientMessageHandler f t m
</span><span class="hs-identifier hs-var">ClientMessageHandler</span></span><span> </span><span class="annot"><span class="annottext">Handler Lsp 'TextDocumentDidClose
NotificationMessage 'TextDocumentDidClose -&gt; Lsp ()
</span><a href="Unison.LSP.VFS.html#lspCloseFile"><span class="hs-identifier hs-var">VFS.lspCloseFile</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-130"></span><span>    </span><span class="annot"><span class="annottext">SMethodMap (ClientMessageHandler Lsp 'Notification)
-&gt; (SMethodMap (ClientMessageHandler Lsp 'Notification)
    -&gt; SMethodMap (ClientMessageHandler Lsp 'Notification))
-&gt; SMethodMap (ClientMessageHandler Lsp 'Notification)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">SMethod 'TextDocumentDidChange
-&gt; ClientMessageHandler Lsp 'Notification 'TextDocumentDidChange
-&gt; SMethodMap (ClientMessageHandler Lsp 'Notification)
-&gt; SMethodMap (ClientMessageHandler Lsp 'Notification)
forall (f :: From) (t :: MethodType) (a :: Method f t)
       (v :: Method f t -&gt; *).
SMethod a -&gt; v a -&gt; SMethodMap v -&gt; SMethodMap v
</span><span class="hs-identifier hs-var">SMM.insert</span></span><span> </span><span class="annot"><span class="annottext">SMethod 'TextDocumentDidChange
</span><span class="hs-identifier hs-var">STextDocumentDidChange</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Handler Lsp 'TextDocumentDidChange
-&gt; ClientMessageHandler Lsp 'Notification 'TextDocumentDidChange
forall (f :: * -&gt; *) (t :: MethodType) (m :: Method 'FromClient t).
Handler f m -&gt; ClientMessageHandler f t m
</span><span class="hs-identifier hs-var">ClientMessageHandler</span></span><span> </span><span class="annot"><span class="annottext">Handler Lsp 'TextDocumentDidChange
NotificationMessage 'TextDocumentDidChange -&gt; Lsp ()
</span><a href="Unison.LSP.VFS.html#lspChangeFile"><span class="hs-identifier hs-var">VFS.lspChangeFile</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-131"></span><span>    </span><span class="annot"><span class="annottext">SMethodMap (ClientMessageHandler Lsp 'Notification)
-&gt; (SMethodMap (ClientMessageHandler Lsp 'Notification)
    -&gt; SMethodMap (ClientMessageHandler Lsp 'Notification))
-&gt; SMethodMap (ClientMessageHandler Lsp 'Notification)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">SMethod 'Initialized
-&gt; ClientMessageHandler Lsp 'Notification 'Initialized
-&gt; SMethodMap (ClientMessageHandler Lsp 'Notification)
-&gt; SMethodMap (ClientMessageHandler Lsp 'Notification)
forall (f :: From) (t :: MethodType) (a :: Method f t)
       (v :: Method f t -&gt; *).
SMethod a -&gt; v a -&gt; SMethodMap v -&gt; SMethodMap v
</span><span class="hs-identifier hs-var">SMM.insert</span></span><span> </span><span class="annot"><span class="annottext">SMethod 'Initialized
</span><span class="hs-identifier hs-var">SInitialized</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Handler Lsp 'Initialized
-&gt; ClientMessageHandler Lsp 'Notification 'Initialized
forall (f :: * -&gt; *) (t :: MethodType) (m :: Method 'FromClient t).
Handler f m -&gt; ClientMessageHandler f t m
</span><span class="hs-identifier hs-var">ClientMessageHandler</span></span><span> </span><span class="annot"><span class="annottext">Handler Lsp 'Initialized
NotificationMessage 'Initialized -&gt; Lsp ()
</span><a href="Unison.LSP.NotificationHandlers.html#initializedHandler"><span class="hs-identifier hs-var">Notifications.initializedHandler</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-132"></span><span>
</span><span id="line-133"></span><span class="hs-comment">-- | A natural transformation into IO, required by the LSP lib.</span><span>
</span><span id="line-134"></span><span class="annot"><a href="Unison.LSP.html#lspInterpretHandler"><span class="hs-identifier hs-type">lspInterpretHandler</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Unison.LSP.Types.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Unison.LSP.Types.html#Lsp"><span class="hs-identifier hs-type">Lsp</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;~&gt;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span>
</span><span id="line-135"></span><span id="lspInterpretHandler"><span class="annot"><span class="annottext">lspInterpretHandler :: Env -&gt; Lsp &lt;~&gt; IO
</span><a href="Unison.LSP.html#lspInterpretHandler"><span class="hs-identifier hs-var hs-var">lspInterpretHandler</span></a></span></span><span> </span><span id="local-6989586621679407468"><span class="annot"><span class="annottext">env :: Env
</span><a href="#local-6989586621679407468"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Unison.LSP.Types.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679407467"><span class="annot"><span class="annottext">LanguageContextEnv Config
lspContext :: LanguageContextEnv Config
$sel:lspContext:Env :: Env -&gt; LanguageContextEnv Config
</span><a href="#local-6989586621679407467"><span class="hs-identifier hs-var hs-var">lspContext</span></a></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-136"></span><span>  </span><span class="annot"><span class="annottext">(forall a. Lsp a -&gt; IO a)
-&gt; (forall a. IO a -&gt; Lsp a) -&gt; Lsp &lt;~&gt; IO
forall k (m :: k -&gt; *) (n :: k -&gt; *).
(forall (a :: k). m a -&gt; n a)
-&gt; (forall (a :: k). n a -&gt; m a) -&gt; m &lt;~&gt; n
</span><span class="hs-identifier hs-var">Iso</span></span><span> </span><span class="annot"><span class="annottext">forall a. Lsp a -&gt; IO a
</span><a href="#local-6989586621679407465"><span class="hs-identifier hs-var">toIO</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. IO a -&gt; Lsp a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="#local-6989586621679407464"><span class="hs-identifier hs-var">fromIO</span></a></span><span>
</span><span id="line-137"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-138"></span><span>    </span><span class="annot"><a href="#local-6989586621679407465"><span class="hs-identifier hs-type">toIO</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679407463"><span class="annot"><a href="#local-6989586621679407463"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Unison.LSP.Types.html#Lsp"><span class="hs-identifier hs-type">Lsp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679407463"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679407463"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-139"></span><span>    </span><span id="local-6989586621679407465"><span class="annot"><span class="annottext">toIO :: Lsp a -&gt; IO a
</span><a href="#local-6989586621679407465"><span class="hs-identifier hs-var hs-var">toIO</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.LSP.Types.html#Lsp"><span class="hs-identifier hs-type">Lsp</span></a></span><span> </span><span id="local-6989586621679407461"><span class="annot"><span class="annottext">ReaderT Env (LspM Config) a
</span><a href="#local-6989586621679407461"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ReaderT (LanguageContextEnv Config) IO a
 -&gt; LanguageContextEnv Config -&gt; IO a)
-&gt; LanguageContextEnv Config
-&gt; ReaderT (LanguageContextEnv Config) IO a
-&gt; IO a
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">ReaderT (LanguageContextEnv Config) IO a
-&gt; LanguageContextEnv Config -&gt; IO a
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var hs-var">runReaderT</span></span><span> </span><span class="annot"><span class="annottext">LanguageContextEnv Config
</span><a href="#local-6989586621679407467"><span class="hs-identifier hs-var">lspContext</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT (LanguageContextEnv Config) IO a -&gt; IO a)
-&gt; (ReaderT Env (LspM Config) a
    -&gt; ReaderT (LanguageContextEnv Config) IO a)
-&gt; ReaderT Env (LspM Config) a
-&gt; IO a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">LspT Config IO a -&gt; ReaderT (LanguageContextEnv Config) IO a
forall config (m :: * -&gt; *) a.
LspT config m a -&gt; ReaderT (LanguageContextEnv config) m a
</span><span class="hs-identifier hs-var hs-var">unLspT</span></span><span> </span><span class="annot"><span class="annottext">(LspT Config IO a -&gt; ReaderT (LanguageContextEnv Config) IO a)
-&gt; (ReaderT Env (LspM Config) a -&gt; LspT Config IO a)
-&gt; ReaderT Env (LspM Config) a
-&gt; ReaderT (LanguageContextEnv Config) IO a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(ReaderT Env (LspM Config) a -&gt; Env -&gt; LspT Config IO a)
-&gt; Env -&gt; ReaderT Env (LspM Config) a -&gt; LspT Config IO a
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">ReaderT Env (LspM Config) a -&gt; Env -&gt; LspT Config IO a
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var hs-var">runReaderT</span></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679407468"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT Env (LspM Config) a -&gt; IO a)
-&gt; ReaderT Env (LspM Config) a -&gt; IO a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ReaderT Env (LspM Config) a
</span><a href="#local-6989586621679407461"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-140"></span><span>    </span><span id="local-6989586621679407464"><span class="annot"><span class="annottext">fromIO :: IO a -&gt; m a
</span><a href="#local-6989586621679407464"><span class="hs-identifier hs-var hs-var">fromIO</span></a></span></span><span> </span><span id="local-6989586621679407460"><span class="annot"><span class="annottext">IO a
</span><a href="#local-6989586621679407460"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">IO a
</span><a href="#local-6989586621679407460"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-141"></span><span>
</span><span id="line-142"></span><span class="annot"><a href="Unison.LSP.html#lspOptions"><span class="hs-identifier hs-type">lspOptions</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Options</span></span><span>
</span><span id="line-143"></span><span id="lspOptions"><span class="annot"><span class="annottext">lspOptions :: Options
</span><a href="Unison.LSP.html#lspOptions"><span class="hs-identifier hs-var hs-var">lspOptions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Options
</span><span class="hs-identifier hs-var">defaultOptions</span></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">textDocumentSync :: Maybe TextDocumentSyncOptions
</span><span class="hs-identifier hs-var">textDocumentSync</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TextDocumentSyncOptions -&gt; Maybe TextDocumentSyncOptions
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(TextDocumentSyncOptions -&gt; Maybe TextDocumentSyncOptions)
-&gt; TextDocumentSyncOptions -&gt; Maybe TextDocumentSyncOptions
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TextDocumentSyncOptions
</span><a href="#local-6989586621679407456"><span class="hs-identifier hs-var">textDocSyncOptions</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-144"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-145"></span><span>    </span><span id="local-6989586621679407456"><span class="annot"><span class="annottext">textDocSyncOptions :: TextDocumentSyncOptions
</span><a href="#local-6989586621679407456"><span class="hs-identifier hs-var hs-var">textDocSyncOptions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-146"></span><span>      </span><span class="annot"><span class="annottext">TextDocumentSyncOptions :: Maybe Bool
-&gt; Maybe TextDocumentSyncKind
-&gt; Maybe Bool
-&gt; Maybe Bool
-&gt; Maybe (Bool |? SaveOptions)
-&gt; TextDocumentSyncOptions
</span><span class="hs-identifier hs-type">TextDocumentSyncOptions</span></span><span>
</span><span id="line-147"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Clients should send file open/close messages so the VFS can handle them</span><span>
</span><span id="line-148"></span><span>          </span><span class="annot"><span class="annottext">$sel:_openClose:TextDocumentSyncOptions :: Maybe Bool
</span><span class="hs-identifier hs-var">_openClose</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Maybe Bool
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span>
</span><span id="line-149"></span><span>          </span><span class="hs-comment">-- Clients should send file change messages so the VFS can handle them</span><span>
</span><span id="line-150"></span><span>          </span><span class="annot"><span class="annottext">$sel:_change:TextDocumentSyncOptions :: Maybe TextDocumentSyncKind
</span><span class="hs-identifier hs-var">_change</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TextDocumentSyncKind -&gt; Maybe TextDocumentSyncKind
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">TextDocumentSyncKind
</span><span class="hs-identifier hs-var">TdSyncIncremental</span></span><span class="hs-special">,</span><span>
</span><span id="line-151"></span><span>          </span><span class="hs-comment">-- Clients should tell us when files are saved</span><span>
</span><span id="line-152"></span><span>          </span><span class="annot"><span class="annottext">$sel:_willSave:TextDocumentSyncOptions :: Maybe Bool
</span><span class="hs-identifier hs-var">_willSave</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Maybe Bool
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">,</span><span>
</span><span id="line-153"></span><span>          </span><span class="hs-comment">-- If we implement a pre-save hook we can enable this.</span><span>
</span><span id="line-154"></span><span>          </span><span class="annot"><span class="annottext">$sel:_willSaveWaitUntil:TextDocumentSyncOptions :: Maybe Bool
</span><span class="hs-identifier hs-var">_willSaveWaitUntil</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Maybe Bool
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">,</span><span>
</span><span id="line-155"></span><span>          </span><span class="hs-comment">-- If we implement a save hook we can enable this.</span><span>
</span><span id="line-156"></span><span>          </span><span class="annot"><span class="annottext">$sel:_save:TextDocumentSyncOptions :: Maybe (Bool |? SaveOptions)
</span><span class="hs-identifier hs-var">_save</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Bool |? SaveOptions) -&gt; Maybe (Bool |? SaveOptions)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool |? SaveOptions
forall a b. a -&gt; a |? b
</span><span class="hs-identifier hs-var">InL</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span>
</span><span id="line-157"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-158"></span></pre></body></html>